{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Gesti√≥n de Productos Ingresar SKU</h5>
                <input 
                    type="text" 
                    class="form-control" 
                    placeholder="Buscar por SKU" 
                    v-model="searchQuery" 
                    @keyup.enter="fetchProducts(1)" 
                    list="productSuggestions"
                    ref="searchInput">
                <datalist id="productSuggestions">
                    <option v-for="product in suggestions" :key="product.id" :value="product.sku">
                        [[ product.name ]]
                    </option>
                </datalist>
            </div>
            <hr>
            <div v-if="product">
                <h5>Editar Producto</h5>
                <form @submit.prevent="updateProduct">
                    <div class="form-group">
                        <label>SKU</label>
                        <input type="text" v-model="product.sku" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" v-model="product.name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Prefijo</label>
                        <input type="text" v-model="product.prefixed" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" v-model="product.brands" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ID ERP</label>
                        <input type="text" v-model="product.iderp" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Alto</label>
                        <input type="number" v-model="product.alto" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Largo</label>
                        <input type="number" v-model="product.largo" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Profundidad</label>
                        <input type="number" v-model="product.profundidad" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Peso</label>
                        <input type="number" v-model="product.peso" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Precio Base Bsale</label>
                        <div class="input-group">
                            <input type="number" v-model.number="product.precio" class="form-control">
                            <button type="button" class="btn btn-primary" @click="actualizarListaPrecio(3, product.precio)">Guardar</button>
                        </div>
                        <small class="form-text text-muted">Precio actual: [[ formatCurrency(product.bsalePrice) ]]</small>
                    </div>
                    <button class="btn btn-info" type="button" @click="abrirModalListas">Editar Precios Marketplaces</button>
                    <button type="submit" class="btn btn-success mt-3">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Precios -->
    <div class="modal fade" id="modalPrecios" tabindex="-1" role="dialog" aria-labelledby="modalPreciosLabel" aria-hidden="true" v-if="product">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Precios para [[ product.sku ]] - [[ product.name ]]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4" v-for="(precio, index) in listasPrecios" :key="index">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6>[[ precio.label ]]</h6>
                                    <p><strong>Precio actual:</strong> [[ formatCurrency(precio.valorActual) ]]</p>
                                    <div class="form-group">
                                        <label>Precio</label>
                                        <input type="number" class="form-control" v-model.number="precio.valor" @input="recalcularMargen(precio)">
                                    </div>
                                    <div class="form-group">
                                        <label>Fee</label>
                                        <input type="number" class="form-control" v-model.number="precio.fee" @input="recalcularMargen(precio)">
                                    </div>
                                    <div class="form-group">
                                        <label>Margen deseado</label>
                                        <input type="number" class="form-control" v-model.number="precio.n" @input="recalcularMargen(precio)">
                                    </div>
                                    <div class="form-group">
                                        <label>Despacho</label>
                                        <input type="number" class="form-control" v-model.number="precio.despacho" @input="recalcularMargen(precio)">
                                    </div>
                                    <p><strong>Margen calculado:</strong> [[ precio.margen ]]%</p>
                                    <p><strong>Precio sugerido:</strong> [[ formatCurrency(precio.valorSugerido) ]]</p>
                                    <button class="btn btn-primary mt-2 w-100" @click="actualizarListaPrecio(precio.id, precio.valor)">Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
