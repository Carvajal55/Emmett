{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="container">
    <audio id="successSound" src="{% static 'sounds/success.mp3' %}" preload="auto"></audio>
    <audio id="errorSound" src="{% static 'sounds/error.mp3' %}" preload="auto"></audio>

    <div class="row mt-4">
        <div class="col-md-6">
            <label for="superid">SuperID</label>
            <input id="superid" v-model="form.superid" @keyup.enter="reingresarProducto" type="text" class="form-control" placeholder="Ingrese el SuperID" autofocus>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div v-if="alertMessage" :class="alertClass" class="alert" role="alert">[[ alertMessage ]]</div>
            <h5>Productos Reingresados</h5>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">
                                <input type="checkbox" @change="toggleSelectAll" v-model="selectAll">
                            </th>
                            <th scope="col">#</th>
                            <th scope="col">SuperID</th>
                            <th scope="col">SKU</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Ubicación</th>
                            <th scope="col">Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-if="productos.length > 0">
                            <tr v-for="(producto, index) in productos" :key="index">
                                <td>
                                    <input type="checkbox" v-model="selectedProducts" :value="producto.superid">
                                </td>
                                <td>[[ index + 1 ]]</td>
                                <td>[[ producto.superid ]]</td>
                                <td>[[ producto.sku ]]</td>
                                <td>[[ producto.name ]]</td>
                                <td>[[ producto.location ]]</td>
                                <td>[[ producto.dateadd ]]</td>
                            </tr>
                        </template>
                        <template v-else>
                            <tr>
                                <td colspan="7" class="text-center">No hay productos reingresados.</td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <button @click="imprimirSeleccionados" class="btn btn-primary" :disabled="selectedProducts.length === 0">
                    Imprimir Seleccionados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            form: {
                superid: '',
                cantidad: 1
            },
            productos: [],          // Lista de productos reingresados
            alertMessage: '',       // Mensaje de alerta
            alertClass: '',         // Clase de alerta
            selectedProducts: [],  // Productos seleccionados para imprimir
            selectAll: false        // Estado del botón "Seleccionar Todo"
        },
        methods: {
            reingresarProducto() {
                const formData = new FormData();
                formData.append('superid', this.form.superid);
                formData.append('cantidad', this.form.cantidad);

                axios.post('/api/reingresar-producto/', formData)
                    .then(response => {
                        if (response.data.error) {
                            this.showAlert(response.data.error, 'alert-danger');
                        } else {
                            this.productos.push(response.data.producto);
                            this.playSound('successSound'); // Sonido de éxito
                            this.showAlert(response.data.message, 'alert-success');
                            this.form.superid = '';
                            this.form.cantidad = 1;
                        }
                    })
                    .catch(error => {
                        this.playSound('errorSound'); // Sonido de éxito
                        console.error('Error al reingresar producto:', error);
                        this.showAlert('Error al reingresar producto.', 'alert-danger');
                    });
            },
            toggleSelectAll() {
                if (this.selectAll) {
                    this.selectedProducts = this.productos.map(producto => producto.superid);
                } else {
                    this.selectedProducts = [];
                }
            },
            imprimirSeleccionados() {
                const formData = new FormData();
                this.selectedProducts.forEach(superid => formData.append('superids[]', superid));

                axios.post('/api/reimprimir-etiqueta/', formData)
                    .then(response => {
                        if (response.data.error) {
                            this.showAlert(response.data.error, 'alert-danger');
                        } else {
                            this.showAlert('Etiquetas generadas con éxito.', 'alert-success');
                            window.open(response.data.urlPdf, '_blank');
                        }
                    })
                    .catch(error => {
                        console.error('Error al imprimir etiquetas:', error);
                        this.showAlert('Error al imprimir etiquetas.', 'alert-danger');
                    });
            },
            showAlert(message, alertClass) {
                this.alertMessage = message;
                this.alertClass = alertClass;
                setTimeout(() => {
                    this.alertMessage = '';
                    this.alertClass = '';
                }, 3000);
            },
            playSound(soundId) {
                const audioElement = document.getElementById(soundId);
                if (audioElement) {
                    audioElement.play();
                } else {
                    console.error(`El sonido con ID ${soundId} no se encontró.`);
                }
            },
        }
    });
</script>
{% endblock js %}