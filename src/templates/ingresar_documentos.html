{% extends 'partials/base-fluid.html' %}
{% load static %}

{% block css %}
<style>
    /* M√°s espacio en la parte final del sitio */
    body {
        padding-bottom: 5rem;
    }

    /* Ajustar el tama√±o del texto y la tabla */
    .table-hover th, .table-hover td {
        font-size: 0.8rem;
        padding: 0.3rem;
    }

    /* Asegurar que el bot√≥n de agregar est√© siempre visible */
    .table-responsive {
        overflow-x: auto;
    }

    /* Truncar texto largo */
    .text-truncate {
        display: inline-block;
        max-width: 150px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    /* Color negro para textos en inputs */
    input, select, textarea {
        color: #000 !important; /* Fuerza el color negro */
    }
</style>
{% endblock css %}

{% block content %}
<div id="app" class="m-2 extra-small ">
    <h3>Agregar Recepci√≥n EMMETT [[ currentDate ]]</h3>
   
    <div class="">
        <!-- Botones para crear proveedor y producto -->
        <div class="mb-4 row">
            <div class="col-auto mt-4">
                <button class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#modalCrearProveedor">
                    Crear Proveedor
                </button>
            </div>
            <div class="col-auto mt-4">
                <button class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#modalCrearProducto">
                    Crear Producto
                </button>
            </div>
            <div class="col-auto mt-4">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearCategoriaMarca">
                    Crear Categor√≠a/Marca
                </button>
            </div>
            <div class="col-4">
                <label for="proveedorSelect" class="form-label">Seleccionar Proveedor</label>
                <select class="form-select" v-model="form.proveedor" @change="buscarFacturasPorProveedor">
                    <option value="">Selecciona un proveedor</option>
                    <option v-for="proveedor in proveedores" :key="proveedor.id" :value="proveedor.rutsupplier">
                        [[ proveedor.rutsupplier ]] - [[ proveedor.namesupplier ]]
                    </option>
                </select>
            </div>
            
            <div class="col-4">
                <label for="nDocument" class="form-label">N√∫mero de Folio</label>
                <div class="input-group">
                    <input class="form-control" type="number" @keyup.enter="buscarFactura" v-model="form.numeroDocumento" :disabled="!form.proveedor">
                    <button class="input-group-text" @click="buscarFactura" :disabled="!form.proveedor"><i class="bi bi-search"></i></button>
                </div>
            </div>
        </div>
<!-- L√≠nea gruesa -->
<hr style="border-top: 4px solid #000; margin-top: 20px; margin-bottom: 20px;">
        <!-- Modal Crear marca categoria -->
        <div class="modal fade" id="modalCrearCategoriaMarca" tabindex="-1" aria-labelledby="modalCategoriaMarcaLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCategoriaMarcaLabel">Crear Categor√≠a o Marca</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nuevaCategoria" class="form-label">Nueva Categor√≠a</label>
                            <input type="text" class="form-control" v-model="nuevaCategoria" placeholder="Nombre de la categor√≠a">
                            <button class="btn btn-primary mt-2" @click="crearCategoria">Crear Categor√≠a</button>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label for="nuevaMarca" class="form-label">Nueva Marca</label>
                            <input type="text" class="form-control" v-model="nuevaMarca" placeholder="Nombre de la marca">
                            <button class="btn btn-secondary mt-2" @click="crearMarca">Crear Marca</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Crear Proveedor -->
        <div class="modal fade" id="modalCrearProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalProveedorLabel">Crear Proveedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="rutProveedor" class="form-label">RUT Proveedor</label>
                            <input type="text" class="form-control" v-model="nuevoProveedor.rut">
                        </div>
                        <div class="mb-3">
                            <label for="nombreProveedor" class="form-label">Nombre Proveedor</label>
                            <input type="text" class="form-control" v-model="nuevoProveedor.nombre">
                        </div>
                        <div class="mb-3">
                            <label for="aliasProveedor" class="form-label">Alias</label>
                            <input type="text" class="form-control" v-model="nuevoProveedor.alias">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" @click="crearProveedor">Crear Proveedor</button>
                    </div>
                </div>
            </div>
        </div>

      <!-- Formulario de Crear Producto -->
        <div class="modal fade" id="modalCrearProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalProductoLabel">Crear Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- SKU -->
                            
                            <!-- Nombre Producto -->
                            <div class="col-6 mb-3">
                                <label for="nombreProducto" class="form-label">Nombre Producto</label>
                                <input type="text" class="form-control" v-model="nuevoProducto.nombre">
                            </div>
                            <div class="col-6 mb-3">
                                <label for="nombreProducto" class="form-label">Alias del Producto</label>
                                <input type="text" class="form-control" v-model="nuevoProducto.alias">
                            </div>
                            <!-- Marca -->
                            <div class="col-6 mb-3">
                                <label for="marcaProducto" class="form-label">Marca</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    placeholder="Buscar marca" 
                                    v-model="nuevoProducto.marcaBusqueda" 
                                    @input="buscarMarcas" 
                                />
                                <div 
                                    v-if="marcas.length > 0" 
                                    class="list-group mt-2" 
                                    style="max-height: 150px; overflow-y: auto;"
                                >
                                    <button 
                                        v-for="marca in marcas" 
                                        :key="marca.id" 
                                        @click="seleccionarMarca(marca)" 
                                        class="list-group-item list-group-item-action"
                                    >
                                        [[ marca.name ]]
                                    </button>
                                </div>
                                <!-- Mostrar la marca seleccionada -->
                                <div v-if="nuevoProducto.marcaSeleccionada" class="mt-2">
                                    <strong>Marca seleccionada:</strong> [[ nuevoProducto.marcaSeleccionada.name ]]
                                </div>
                            </div>
                           
                            <!-- Proveedor -->
                            <div class="col-6 mb-3">
                                <label for="proveedorProducto" class="form-label">Proveedor</label>
                            
                                <!-- Input editable para buscar proveedores -->
                                <input 
                                    v-if="!proveedorSeleccionadoProd" 
                                    type="text" 
                                    class="form-control" 
                                    placeholder="Buscar proveedor por RUT o Nombre"
                                    v-model="searchQueryProd" 
                                    @input="searchProveedoresProd"
                                />
                            
                                <!-- Texto fijo para el proveedor seleccionado -->
                                <div v-else class="d-flex justify-content-between align-items-center">
                                    <span>
                                        [[ proveedorSeleccionadoProd.rutsupplier ]] - [[ proveedorSeleccionadoProd.namesupplier ]]
                                    </span>
                                    <button 
                                        class="btn btn-sm btn-link text-danger" 
                                        @click="limpiarProveedorSeleccionado"
                                    >
                                        Cambiar
                                    </button>
                                </div>
                            
                                <!-- Lista de resultados de b√∫squeda -->
                                <div 
                                    v-if="searchQueryProd && provedoresProd.length && !proveedorSeleccionadoProd" 
                                    class="list-group mt-2" 
                                    style="max-height: 150px; overflow-y: auto;"
                                >
                                    <button 
                                        v-for="proveedor in provedoresProd" 
                                        :key="proveedor.id" 
                                        @click="seleccionarProveedorProd(proveedor)" 
                                        class="list-group-item list-group-item-action"
                                    >
                                        [[ proveedor.rutsupplier ]] - [[ proveedor.namesupplier ]]
                                    </button>
                                </div>
                            </div>
                            <!-- Categor√≠a -->
                            <div class="col-6 mb-3">
                                <label for="categoriaProducto" class="form-label">Categor√≠a Bsale</label>
                                <select class="form-select" v-model="nuevoProducto.categoriaBsale">
                                    <option v-for="categoria in categorias" :key="categoria.iderp" :value="categoria.iderp">
                                        [[ categoria.namecategory ]]
                                    </option>
                                </select>
                            </div>
                            <!-- Categor√≠a -->
                            <div class="col-6 mb-3">
                                <label for="categoriaProducto" class="form-label">Categor√≠a</label>
                                <select class="form-select" v-model="nuevoProducto.categoria">
                                    <option value="audio">Audio</option>
                                    <option value="instrumentos">Instrumentos Musicales</option>
                                    <option value="estudio">Estudio</option>
                                    <option value="iluminacion">Iluminaci√≥n</option>
                                    <option value="electronica">Electr√≥nica y Computaci√≥n</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <!-- C√≥digo de Barra -->
                            
                            <!-- Medidas y Peso -->
                            <div class="col-3 mb-3">
                                <label for="altoProducto" class="form-label">Alto (cm)</label>
                                <input type="number" class="form-control" v-model="nuevoProducto.alto" placeholder="cm">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="largoProducto" class="form-label">Largo (cm)</label>
                                <input type="number" class="form-control" v-model="nuevoProducto.largo" placeholder="cm">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="profundidadProducto" class="form-label">Profundidad (cm)</label>
                                <input type="number" class="form-control" v-model="nuevoProducto.profundidad" placeholder="cm">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="pesoProducto" class="form-label">Peso (kg)</label>
                                <input type="number" class="form-control" v-model="nuevoProducto.peso" placeholder="kg">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" @click="crearProducto">Crear Producto</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campo de b√∫squeda de proveedor -->
        <div>
            <h3>Buscar Proveedor</h3>

            <!-- Campo de b√∫squeda -->
            <input 
                type="text" 
                class="form-control" 
                placeholder="Buscar proveedor por RUT o Nombre"
                v-model="searchQuery" 
                @input="searchProveedores" 
            />
        
            <!-- Lista de resultados de b√∫squeda con scroll -->
            <div 
                v-if="searchQuery && proveedores.length && !showAllProveedores && !proveedorSeleccionado" 
                class="list-group mt-2" 
                style="max-height: 150px; overflow-y: auto;"
            >
                <button 
                    v-for="proveedor in proveedores" 
                    :key="proveedor.id" 
                    @click="seleccionarProveedor(proveedor)" 
                    class="list-group-item list-group-item-action"
                >
                    [[ proveedor.rutsupplier ]] - [[ proveedor.namesupplier ]]
                </button>
            </div>
            
            <!-- Mostrar mensaje cuando no hay resultados -->
            <div 
                v-else-if="searchQuery && !showAllProveedores && !proveedorSeleccionado" 
                class="mt-2 text-muted"
            >
                No se encontraron proveedores.
            </div>
        
            <!-- Datos del proveedor seleccionado -->
            <div 
                v-if="form.proveedor && !showAllProveedores && proveedorSeleccionado" 
                class="mt-3"
            >
                <h5>Proveedor Seleccionado</h5>
                <p>RUT: [[ form.rutProveedor ]]</p>
                <p>Raz√≥n Social: [[ form.razonSocial ]]</p>
            </div>
        </div>

        <!-- Bot√≥n para ver todos los proveedores -->
        <!-- <div class="mt-4">
            <button class="btn btn-primary" @click="mostrarTodosLosProveedores">
                Ver todos los proveedores
            </button>
        </div> -->

        

        <!-- Datos del proveedor -->
        <div class="row mt-3">
            <div class="mb-3  col-3">
                <label for="txtRutSupplier2" class="form-label">RUT PROVEEDOR MTD2</label>
                <input class="form-control form-control-md" type="text" v-model="form.rutProveedor">
            </div>
            <div class="mb-3 col-9">
                <label for="txtNameCompany2" class="form-label">RAZON SOCIAL MTD2</label>
                <input class="form-control form-control-md" type="text" v-model="form.razonSocial">
            </div>
        </div>

  

        <!-- Informaci√≥n del documento -->
        <div class="mb-3 row">
                  <!-- Tipo de documento -->
        <div class="mb-3 col-3">
            <label for="cbTypeDocument" class="form-label">Tipo de Documento</label>
            <select class="form-select" v-model="form.tipoDocumento">
                <option value="33">Factura de Compra</option>
                <option value="52">Gu√≠a de Despacho</option>
            </select>
        </div>
            <div class="col-3">
                <label for="nDocument" class="form-label">N√∫mero Documento</label>
                <div class="input-group">
                    <input class="form-control" type="number" v-model="form.numeroDocumento">
                    <button class="input-group-text" @click=""><i class="bi bi-search"></i></button>
                </div>
            </div>

            <div class="col-2">
                <label for="dctoGeneral" class="form-label">Descuento General (%)</label>
                <input 
                    class="form-control" 
                    type="number" 
                    v-model.number="form.descuentoGeneral" 
                    @input="aplicarDescuentoGeneral"
                >
            </div>

            <div class="col-3">
                <label for="datePurchase" class="form-label">Fecha Emisi√≥n</label>
                <input class="form-control" type="date" v-model="form.fechaEmision">
            </div>

            <div class="col-3">
                <label for="dateExpired" class="form-label">Fecha Vencimiento</label>
                <input class="form-control" type="date" v-model="form.fechaVencimiento">
            </div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="row">
            <div class="col-2">
                <label for="cbTypePay" class="form-label">Tipo de Pago</label>
                <select class="form-select" v-model="form.tipoPago">
                    <option value="1">No Pagado al Proveedor</option>
                    <option value="2">Cheque - Itau</option>
                    <option value="3">Cheque - BCI</option>
                    <option value="4">Cheque - Banco Estado</option>
                    <option value="5">Cheque - Santander</option>
                    <option value="6">Efectivo</option>
                    <option value="7">Transferencia</option>
                    <option value="8">Otros</option>
                </select>
            </div>

            <div class="col-2">
                <label for="nCheque" class="form-label">N¬∫ Cheque</label>
                <input class="form-control" type="number" v-model="form.numeroCheque" value="0">
            </div>

            <div class="col-2">
                <label for="qtyCheque" class="form-label">Cantidad Cheque</label>
                <input class="form-control" type="number" v-model="form.cantidadCheque" value="0">
            </div>

            <div class="col-2">
                <label for="subtotalSinIva" class="form-label">Subtotal (Sin IVA)</label>
                <input
                    class="form-control"
                    type="text"
                    :value="formatCurrency(totalSubtotales)"
                    readonly
                />
            </div>
            <div class="col-2">
                <label for="subtotalConIva" class="form-label">Subtotal (Con IVA)</label>
                <input
                    class="form-control"
                    type="text"
                    :value="formatCurrency(subtotalConIva)"
                    readonly
                />
            </div>
        </div>

        <!-- Observaciones -->
        <div class="my-3">
            <label for="observation" class="form-label">Observaci√≥n</label>
            <input class="form-control form-control-lg" v-model="form.observaciones">
        </div>
        <div class="my-3">
            <label for="imagenFactura" class="form-label">Subir Imagen de la Factura</label>
            <input
                type="file"
                class="form-control"
                @change="procesarImagen"
                accept="image/*"
            />
        </div>

        <!-- Botones de acci√≥n omitidos por brevedad... -->
        <button 
            type="button" 
            style="background-color: #28a745; color: white; border: none;" 
            class="btn btn-lg" 
            @click="enviarDatos"
            :disabled="!formularioValido">
            Guardar
        </button>

        </div>
        <!-- Contenido de las tablas -->
        <div class="row mt-3">
            <!-- Tabla de Productos en el Documento -->
            <div class="col-7">
                <h4>Productos en el Documento</h4>
                <div class="table-responsive compact-table">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>MODELO</th>
                                <th>SKU</th>
                                <th>CANT ESP</th>
                                <th>CANT REC</th>
                                <th>COMP</th> <!-- Nueva columna para el checkmark -->
                                <th>COSTO</th>
                                <th>DCTO</th>
                                <th>SUBTOTAL</th>
                                <th>ELIMINAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(producto, index) in productosDocumento" :key="producto.sku">
                                <td>[[ index + 1 ]]</td>
                                <td>[[ producto.model ]]</td>
                                <td>[[ producto.sku ]]</td>
                                <td>
                                    <input class="form-control form-control-sm" v-model.number="producto.cantidad" @input="verificarCompleto(index)" type="number">
                                </td>
                                <td>
                                    <input class="form-control form-control-sm" v-model.number="producto.received_quantity" @input="verificarCompleto(index)" type="number">
                                </td>
                                <td>
                                    <input type="checkbox" v-model="producto.completo">
                                </td>
                                <td>
                                    <input
                                        class="form-control"
                                        v-model.number="producto.costo"
                                        @input="calcularSubtotalProducto(index)"
                                        type="number"
                                        placeholder=""
                                        style="width: 125px; font-size: 0.8rem;" 
                                    />
                                </td>
                                <td>
                                    <input 
                                        class="form-control form-control-sm" 
                                        v-model.number="producto.descuento" 
                                        @input="calcularSubtotalProducto(index)" 
                                        type="number" 
                                        placeholder="Descuento (%)">
                                </td>
                                <td>[[ formatCurrency(producto.subtotal) ]]</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" @click="eliminarProducto(producto.sku)">Eliminar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tabla de Productos Disponibles (m√°s peque√±a) -->
            <div class="col-5 mb-4">
                <h4>Buscar Productos</h4>
                <input type="text" class="form-control form-control-sm mb-3" placeholder="Buscar producto por SKU o Nombre"
                       v-model="searchProduct" @input="searchProductos" />
            
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto; overflow-x: auto;">
                        <table class="table table-striped table-hover" style="font-size: 0.8rem;">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">SKU</th>
                                    <th style="width: 35%;">Nombre</th>
                                    <th style="width: 15%;">Marca</th>
                                    <th style="width: 15%;">U.Precio</th>
                                    <th style="width: 10%;">Agregar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(producto, index) in productos" :key="producto.id">
                                    <td>[[ producto.sku ]]</td>
                                    <td class="text-truncate" style="max-width: 150px; overflow: hidden; white-space: nowrap;">[[ producto.nameproduct ]]</td>
                                    <td>[[ producto.brands ]]</td>
                                    <td>[[ formatCurrency(producto.lastcost) ]]</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" @click="agregarProducto(producto)">Agregar</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
            </div>
            
            <!-- Estilos inline para hacer la tabla m√°s compacta -->
            <style>
                /* Reducir el tama√±o del texto y el padding en las celdas */
                .table-hover th, .table-hover td {
                    font-size: 0.8rem; /* Tama√±o de texto m√°s peque√±o */
                    padding: 0.3rem;  /* Reduce el padding en las celdas */
                }
            
                /* Ajuste del tama√±o del campo de b√∫squeda */
                .form-control-sm {
                    font-size: 0.8rem;
                    padding: 0.25rem 0.5rem;
                }
            </style>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- SweetAlert -->

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            facturaId: null, // ID de la factura cargada
            nuevaCategoria: '', // Para la nueva categor√≠a
            nuevaMarca: '', 
            marcas: [],
            form: {
                proveedor: null,
                rutProveedor: '',
                razonSocial: '',
                tipoDocumento: '33',
                numeroDocumento: '',
                fechaEmision: '',
                fechaVencimiento: '',
                descuentoGeneral: 0,
                tipoPago: 1,
                numeroCheque: 0,
                cantidadCheque: 0,
                subtotal: 0,
                observaciones: '',
                img_url:''
            },
            sugerenciasFacturas: [], // Para almacenar las facturas recientes
            imagenFactura: null, // Para almacenar la imagen seleccionada
            
            pagination: {
                current_page: 1,
                total_pages: 1
            },
            searchProduct: '',
            searchQuery: '', 
            searchQueryProd: '', 
            
            productosDocumento: [],
            productos: [],
            proveedores: [],
            provedoresProd:[],
            showAllProveedores: false,
            proveedorSeleccionado: false,
            proveedorSeleccionadoProd: null,

            currentDate: new Date().toISOString().slice(0, 10),
            facturaCargada: false,
            nuevoProveedor: {
                rut: '',
                nombre: '',
                alias: ''
            },
            nuevoProducto: {
                marcaBusqueda: '',
                marcaSeleccionada: null,
                costo: null,
                sku: '',
                nombre: '',
                marca: '',
                precio: 0,
                descripcion: '',
                categoria: '',
                codigoBarra: '',
                proveedor: null, // Proveedor del producto, tomar√° el proveedor seleccionado si existe
                categoriaBsale: "",
            },
            categorias: [],
            menu: {
                audio: false,
                pruebaAudio: false,
                checkboxFinalAudio: false,

                instrumentos: false,
                pruebaInstrumentos: false,
                checkboxFinalInstrumentos: false,

                estudio: false,
                pruebaEstudio: false,
                checkboxFinalEstudio: false,

                iluminacion: false,
                pruebaIluminacion: false,
                checkboxFinalIluminacion: false,

                electronica: false,
                pruebaElectronica: false,
                checkboxFinalElectronica: false,
            },
            nuevosCampos: {
                expected_quantity: 0, // Cantidad esperada del producto
                received_quantity: 0, // Cantidad recibida del producto
                difference: 0         // Diferencia calculada (expected_quantity - received_quantity)
            }

        },
        watch: {
            searchQuery(newQuery) {
                this.searchProveedores(newQuery);
                this.searchProveedoresProd(newQuery);
            },
            searchQueryProd(newQuery) {
                this.searchProveedoresProd(newQuery);
            },
            "form.descuentoGeneral": {
                handler(newValue) {
                    console.log("Aplicando descuento general:", newValue);
                    this.aplicarDescuentoGeneral();
                },
                immediate: true, // Ejecutar al cargar la p√°gina
            },
            productosDocumento: {
                handler() {
                    console.log("Productos modificados. Recalculando subtotales.");
                    this.recalcularTodosLosSubtotales();
                },
                deep: true, // Observar cambios en el array y sus objetos
            },
        },
        computed: {
            
            formularioValido() {
                // Verifica que las fechas, n√∫mero de documento y al menos un producto est√©n presentes
                const { fechaEmision, fechaVencimiento, numeroDocumento } = this.form;
                return (
                    fechaEmision &&
                    fechaVencimiento &&
                    numeroDocumento &&
                    this.productosDocumento.length > 0
                );
            },
            totalSubtotales() {
                // Suma todos los subtotales de los productos
                return this.productosDocumento.reduce((total, producto) => total + (producto.subtotal || 0), 0);
            },
            subtotalConIva() {
                const iva = 0.19; // Cambia esto al porcentaje de IVA que uses (19% por ejemplo)
                return this.totalSubtotales * (1 + iva);
            },
        },
        methods: {
            async buscarFacturasPorProveedor() {
                if (!this.form.proveedor) return;

                try {
                    const response = await axios.get('/api/listar-facturas-proveedor/', {
                        params: { supplier: this.form.proveedor }
                    });
                    this.facturasDisponibles = response.data.facturas;
                } catch (error) {
                    console.error('Error al obtener facturas del proveedor:', error);
                    this.facturasDisponibles = [];
                }
            },
            cargarCategorias() {
                fetch("/api/listar-categorias/") // Cambia esta URL seg√∫n tu endpoint
                    .then((response) => response.json())
                    .then((data) => {
                        this.categorias = data.categorias || [];
                    })
                    .catch((error) => {
                        console.error("Error al cargar las categor√≠as:", error);
                    });
            },
            aplicarDescuentoGeneral() {
                this.productosDocumento.forEach((producto, index) => {
                    // Si no hay descuento espec√≠fico, aplica el descuento general
                    producto.descuento = this.form.descuentoGeneral || 0;
                    this.calcularSubtotalProducto(index);
                });
            },
            async crearCategoria() {
                if (!this.nuevaCategoria) {
                    Swal.fire('Error', 'El nombre de la categor√≠a no puede estar vac√≠o.', 'error');
                    return;
                }

                try {
                    const response = await axios.post('/api/create-category/', { name: this.nuevaCategoria });
                    Swal.fire('√âxito', `Categor√≠a "${this.nuevaCategoria}" creada correctamente.`, 'success');
                    this.nuevaCategoria = ''; // Limpia el campo
                } catch (error) {
                    Swal.fire('Error', 'No se pudo crear la categor√≠a.', 'error');
                    console.error('Error al crear la categor√≠a:', error);
                }
            },
            async crearMarca() {
                if (!this.nuevaMarca) {
                    Swal.fire('Error', 'El nombre de la marca no puede estar vac√≠o.', 'error');
                    return;
                }

                try {
                    const response = await axios.post('/api/create-brand/', { name: this.nuevaMarca });
                    Swal.fire('√âxito', `Marca "${this.nuevaMarca}" creada correctamente.`, 'success');
                    this.nuevaMarca = ''; // Limpia el campo
                } catch (error) {
                    Swal.fire('Error', 'No se pudo crear la marca.', 'error');
                    console.error('Error al crear la marca:', error);
                }
            },
            seleccionarMarca(marca) {
                console.log(marca)
                this.nuevoProducto.marcaSeleccionada = marca;
                this.nuevoProducto.marca = marca.name; // Actualiza el input con el nombre de la marca seleccionada
                this.marcas = []; // Limpiar la lista de sugerencias
            },
            async buscarMarcas() {
                try {
                    if (this.nuevoProducto.marcaBusqueda.length > 2) {
                        const response = await axios.get('/api/get-brands/', {
                            params: { q: this.nuevoProducto.marcaBusqueda }
                        });
                        this.marcas = response.data;
                    } else {
                        this.marcas = [];
                    }
                } catch (error) {
                    console.error('Error al buscar marcas:', error);
                } finally {
                }
            },
            async buscarFactura() {
                if (!this.form.proveedor || !this.form.numeroDocumento) {
                    Swal.fire("Error", "Debes seleccionar un proveedor y escribir un n√∫mero de folio.", "error");
                    return;
                }

                try {
                    const response = await axios.get('/api/get-factura/', {
                        params: {
                            supplier: this.form.proveedor,
                            number: this.form.numeroDocumento,
                        },
                    });

                    console.log("üöÄ Respuesta de la API:", response.data);

                    if (!response.data.headers) {
                        Swal.fire("Error", "La factura no contiene datos v√°lidos.", "error");
                        return;
                    }

                    const data = response.data;

                    this.facturaId = data.headers.idFactura;

                    this.form = {
                        rutProveedor: data.headers.supplier || '',
                        razonSocial: data.headers.supplierName || '',
                        tipoDocumento: data.headers.typeDocument || '',
                        numeroDocumento: data.headers.nDocument || '',
                        fechaEmision: data.headers.datePurchase || '',
                        fechaVencimiento: data.headers.dateExpired || '',
                        descuentoGeneral: data.headers.dcto || 0,
                        tipoPago: data.headers.typePay || '',
                        numeroCheque: data.headers.nCheque || 0,
                        cantidadCheque: data.headers.qtyCheque || 0,
                        subtotal: data.headers.subtotal || 0,
                        observaciones: data.headers.observation || '',
                    };

                    this.productosDocumento = data.details ? data.details.map(detalle => ({
                        model: detalle.model || '',
                        sku: detalle.sku || '',
                        cantidad: detalle.qty || 0,
                        received_quantity: detalle.received_quantity || 0,
                        costo: detalle.cost || 0,
                        descuento: detalle.dctoItem || 0,
                        subtotal: detalle.subtotalItem || 0,
                        completo: detalle.checkItem === "true",
                    })) : [];

                    console.log("üìå Data procesada:", this.form, this.productosDocumento);

                    Swal.fire("√âxito", "Factura cargada correctamente.", "success");
                } catch (error) {
                    console.error("‚ùå Error al buscar la factura:", error);
                    Swal.fire("Error", "No se encontr√≥ la factura.", "error");
                }
            },
            // Actualizar descuentos para todos los productos
            actualizarDescuentoProductos(descuentoGeneral) {
                this.productosDocumento.forEach((producto, index) => {
                    if (!producto.descuento) {
                        producto.descuento = descuentoGeneral; // Asignar descuento general si no tiene uno espec√≠fico
                    }
                    this.calcularSubtotalProducto(index);
                });
            },
            verificarCompleto(index) {
                const producto = this.productosDocumento[index];
                producto.completo = producto.cantidad === producto.received_quantity; // Marca como completo si coinciden
            },
            calcularSubtotalProducto(index) {
                const producto = this.productosDocumento[index];

                // Usa el descuento del producto o el general (por defecto, 0%)
                const descuento = producto.descuento || 0;

                // Validar el descuento (evita NaN o vac√≠os)
                const descuentoAplicado = isNaN(descuento) || descuento === '' ? 0 : parseFloat(descuento);

                // Calcular el costo con descuento
                const costoConDescuento = (producto.costo || 0) * (1 - descuentoAplicado / 100);

                // Actualizar el subtotal considerando la cantidad
                producto.subtotal = (producto.cantidad || 0) * costoConDescuento;

                console.log(`Producto SKU: ${producto.sku}, Subtotal Calculado: ${producto.subtotal}`);
            },



            calcularTotalSubtotales() {
                return this.productosDocumento.reduce((total, producto) => total + (producto.subtotal || 0), 0);
            },
           
            seleccionarCategoria(categoria) {
                // Desmarcar todas las categor√≠as principales, excepto la seleccionada
                for (let key in this.menu) {
                    if (key !== categoria && key.startsWith(categoria) === false) {
                        this.menu[key] = false;
                    }
                }
            },
            recalcularTodosLosSubtotales() {
                this.productosDocumento.forEach((_, index) => {
                    this.calcularSubtotalProducto(index);
                });
            },

            searchProductos() {
                axios.get('/api/get-products/', {
                    params: {
                        q: this.searchProduct,
                        page: 1
                    }
                })
                .then(response => {
                    this.productos = response.data.products;
                    this.pagination.current_page = response.data.current_page;
                    this.pagination.total_pages = response.data.total_pages;
                })
                .catch(error => {
                    console.error('Error al buscar productos:', error);
                });
            },
            changePage(page) {
                if (page > 0 && page <= this.pagination.total_pages) {
                    this.searchProductos(page);
                }
            },
            paginatedPages() {
                const range = 5;
                let start = this.pagination.current_page - Math.floor(range / 2);
                let end = this.pagination.current_page + Math.floor(range / 2);

                if (start < 1) {
                    start = 1;
                    end = range;
                }

                if (end > this.pagination.total_pages) {
                    end = this.pagination.total_pages;
                    start = this.pagination.total_pages - range + 1;
                    if (start < 1) {
                        start = 1;
                    }
                }

                const pages = [];
                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }
                return pages;
            },
            formatCurrency(value) {
                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(value);
            },
            agregarProducto(producto) {
                console.log(producto.iderp);
                const productoExistente = this.productosDocumento.find((p) => p.sku === producto.sku);

                if (productoExistente) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Producto duplicado',
                        text: 'Este producto ya ha sido agregado.',
                    });
                } else {
                    const descuentoGeneral = this.form.descuentoGeneral || 0; // Obt√©n el descuento general actual
                    const nuevoProducto = {
                        model: producto.nameproduct,
                        sku: producto.sku,
                        iderp: producto.iderp,
                        cantidad: 1, // Cantidad esperada, inicializada con 1
                        costo: "", // Precio del producto
                        descuento: descuentoGeneral, // Asignar el descuento general al producto
                        subtotal: 0, // Subtotal inicial
                        recibido: 0, // Cantidad recibida
                        completo: false,
                    };

                    // Calcular el subtotal inicial del producto
                    this.calcularSubtotalProducto(this.productosDocumento.push(nuevoProducto) - 1);
                }
            },

            eliminarProducto(sku) {
                this.productosDocumento = this.productosDocumento.filter((producto) => producto.sku !== sku);
            },
            limpiarCeldas() {
                this.form = {
                    proveedor: null,
                    rutProveedor: '',
                    razonSocial: '',
                    tipoDocumento: '33',
                    numeroDocumento: '',
                    fechaEmision: '',
                    fechaVencimiento: '',
                    descuentoGeneral: 0,
                    tipoPago: 1,
                    numeroCheque: 0,
                    cantidadCheque: 0,
                    subtotal: 0,
                    observaciones: ''
                };
                this.productosDocumento = [];
            },
            
            searchProveedoresProd(query) {
                // Asegura que la b√∫squeda solo se ejecute si la query es v√°lida y tiene m√°s de 2 caracteres
                if (query && query.length > 2) {
                    axios.get('/api/get-suppliers/', { params: { q: query } })
                        .then(response => {
                            this.provedoresProd = response.data;
                            this.showAllProveedores = false;
                        })
                        .catch(error => {
                            console.error('Error al buscar proveedores:', error);
                        });
                } else {
                    this.provedoresProd = []; 
                }
            },
            searchProveedores(query) {
                // Asegura que la b√∫squeda solo se ejecute si la query es v√°lida y tiene m√°s de 2 caracteres
                if (query && query.length > 2) {
                    axios.get('/api/get-suppliers/', { params: { q: query } })
                        .then(response => {
                            this.proveedores = response.data;
                            this.showAllProveedores = false;
                        })
                        .catch(error => {
                            console.error('Error al buscar proveedores:', error);
                        });
                } else {
                    this.proveedores = []; 
                }
            },
            seleccionarProveedor(proveedor) {
                this.form.proveedor = proveedor.id;
                this.form.rutProveedor = proveedor.rutsupplier;
                this.form.razonSocial = proveedor.namesupplier;
                this.proveedorSeleccionado = true; // Marca que se ha seleccionado un proveedor
                this.proveedores = []; // Vac√≠a la lista de proveedores despu√©s de la selecci√≥n
            },
            seleccionarProveedorProd(proveedor) {
                this.proveedorSeleccionadoProd = proveedor; // Actualiza el proveedor seleccionado
                this.nuevoProducto.proveedor = proveedor.id; // Vincula el ID al producto
                this.searchQueryProd = ''; // Limpia el input de b√∫squeda
                this.provedoresProd = []; // Limpia las sugerencias
            },
            limpiarProveedorSeleccionado() {
                this.proveedorSeleccionadoProd = null; // Limpia el proveedor seleccionado
                this.nuevoProducto.proveedor = null; // Limpia el ID del proveedor
            },
            cargarProductos() {
                this.searchProductos();
            },
            calcularDiferencia(index) {
                const producto = this.productosDocumento[index];
                producto.difference = producto.cantidad - (producto.received_quantity || 0);
            },
            crearProveedor() {
                // Crear un objeto FormData
                let formData = new FormData();
                formData.append('rut', this.nuevoProveedor.rut);
                formData.append('nombre', this.nuevoProveedor.nombre);
                formData.append('alias', this.nuevoProveedor.alias);

                axios.post('/api/create-supplier/', formData)
                    .then(response => {
                        Swal.fire('√âxito', 'Proveedor creado correctamente.', 'success');
                        this.nuevoProveedor = { rut: '', nombre: '', alias: '' };
                        this.searchProveedores();
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo crear el proveedor.', 'error');
                    });
            },
            crearProducto() {
                // Construimos el objeto nuevoProducto con todos los datos del formulario
                const nuevoProducto = {
                    sku: this.nuevoProducto.sku,            // SKU generado o ingresado
                    nombre: this.nuevoProducto.nombre,  
                    alias: this.nuevoProducto.alias,        // Alias del producto
                    marca: this.nuevoProducto.marca,        // Marca del producto
                    precio: this.nuevoProducto.precio,      // Precio del producto
                    proveedor: this.nuevoProducto.proveedor, // ID del proveedor seleccionado
                    categoria: this.nuevoProducto.categoria, // Categor√≠a seleccionada
                    codigoBarra: this.nuevoProducto.codigoBarra, // C√≥digo de barras
                    alto: this.nuevoProducto.alto,          // Dimensiones del producto
                    largo: this.nuevoProducto.largo,
                    profundidad: this.nuevoProducto.profundidad,
                    peso: this.nuevoProducto.peso,           // Peso del producto
                    categoriaBsale: this.nuevoProducto.categoriaBsale,
                };

                // Mostrar SweetAlert de carga
                Swal.fire({
                    title: "Creando producto...",
                    text: "Por favor, espera mientras procesamos la solicitud.",
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Enviamos la solicitud POST al backend para crear el producto
                fetch("/api/create-product/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(nuevoProducto)  // Convertimos el objeto a JSON
                })
                .then(response => response.json())  // Parseamos la respuesta a JSON
                .then(data => {
                    Swal.close(); // Cerrar el mensaje de carga

                    if (data.message && data.product) {
                        // Mostrar notificaci√≥n de √©xito con el SKU retornado
                        Swal.fire({
                        icon: "success",
                        title: "¬°Producto creado!",
                        html: `
                            <p style="margin-bottom: 10px;">
                                El producto con SKU <span id="skuText" style="font-weight: bold; user-select: text;">${data.product}</span> se cre√≥ con √©xito.
                            </p>
                        `,
                        customClass: {
                            popup: 'swal-selectable' // Personalizaci√≥n opcional
                        }
                    });

                        // Aqu√≠ puedes agregar l√≥gica adicional, como actualizar la lista de productos o limpiar el formulario
                        this.nuevoProducto = {}; // Limpiar el formulario
                    } else {
                        // Mostrar error retornado por el backend
                        Swal.fire({
                            icon: "error",
                            title: "Error al crear el producto",
                            text: data.error || "Hubo un problema inesperado."
                        });
                    }
                })
                .catch(error => {
                    Swal.close(); // Cerrar el mensaje de carga en caso de error
                    console.error("Error al crear el producto:", error);

                    // Mostrar mensaje de error
                    Swal.fire({
                        icon: "error",
                        title: "Error al crear el producto",
                        text: "Ocurri√≥ un problema al conectar con el servidor. Por favor, int√©ntalo de nuevo."
                    });
                });
            },
            procesarImagen(event) {
                const archivo = event.target.files[0]; // Obt√©n el archivo seleccionado
                if (archivo) {
                    this.form.img_url = archivo; // Guarda el archivo en form.img_url para enviarlo al backend
                    console.log('Imagen seleccionada:', archivo);
                } else {
                    this.form.img_url = null; // Limpia el campo si no hay archivo seleccionado
                }
            },
            enviarDatos() {
                const formData = new FormData();

                // Adjuntar imagen si existe
                if (this.form.img_url) {
                    formData.append("img_url", this.form.img_url);
                }

                // Adjuntar el JSON como string
                formData.append("jsonData", JSON.stringify({
                    facturaId: this.facturaId,
                    headers: {
                        supplier: this.form.rutProveedor,
                        supplierName: this.form.razonSocial,
                        typeDocument: this.form.tipoDocumento,
                        nDocument: this.form.numeroDocumento,
                        dcto: this.form.descuentoGeneral,
                        datePurchase: this.form.fechaEmision,
                        dateExpired: this.form.fechaVencimiento,
                        observation: this.form.observaciones,
                        typePay: this.form.tipoPago,
                        nCheque: this.form.numeroCheque,
                        qtyCheque: this.form.cantidadCheque,
                        subtotal: this.totalSubtotales,
                        urlPDF: "",
                        urlJson: "",
                        dateReception: this.currentDate,
                        userProcess: "Nombre Usuario"
                    },
                    details: this.productosDocumento.map(producto => ({
                        qty: producto.cantidad,
                        received_quantity: producto.received_quantity,
                        completo: producto.completo,
                        cost: producto.costo,
                        dctoItem: producto.descuento,
                        subtotalItem: producto.subtotal,
                        sku: producto.sku,
                        model: producto.model,
                    }))
                }));

                axios.post('/api/generar-json/', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                })
                .then(response => {
                    Swal.fire({
                        title: '√âxito',
                        text: 'La factura se ha guardado correctamente.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = "{% url 'recepciones_pendientes' %}";
                    });
                })
                .catch(error => {
                    console.error("Error al enviar los datos:", error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un problema al guardar la factura.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            },

            mostrarTodosLosProveedores() {
                // Obtener la lista completa de proveedores
                axios.get('/api/get-suppliers/')
                    .then(response => {
                        this.proveedores = response.data;
                    })
                    .catch(error => {
                        console.error('Error al obtener todos los proveedores:', error);
                    });
            },
        },
        mounted() {
            this.mostrarTodosLosProveedores();
            this.searchProveedores();
            this.cargarProductos();
            this.searchProveedoresProd();
            this.cargarCategorias();
        }
    });
</script>
{% endblock js %}






