{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="m-2" v-if="accesoPermitido">
    <audio id="successSound" src="{% static 'sounds/success.mp3' %}" preload="auto"></audio>
    <h3>Gestión de Productos por Sector</h3>

    <!-- Input único para ingresar sector o agregar productos por Super ID -->
    <div class="form-group">
        <input type="text" id="sectorOrProductInput" class="form-control" v-model="inputValue" placeholder="Escanea el sector (ej. B-1-G1-1) o el Super ID del producto" @keyup.enter="procesarInput" />
    </div>

    <!-- Mostrar el sector actual seleccionado -->
    <div v-if="sectorSeleccionado">
        <h5 class="mt-3">Sector actual: [[ sectorSeleccionado ]]</h5>
    </div>

    <!-- Lista de productos que se van a agregar -->
    <div v-if="productosParaAgregar.length">
        <h5 class="mt-3">Productos para agregar</h5>
        <ul class="list-group">
            <li v-for="(producto, index) in productosParaAgregar" :key="index" class="list-group-item">
                [[ producto.superid ]]
            </li>
        </ul>
    </div>

    <!-- Botón para confirmar agregar productos al sector -->
    <button class="btn btn-primary mt-3" @click="addProductsToSector" :disabled="productosParaAgregar.length === 0">Confirmar Agregar Productos al Sector</button>

    <!-- Botón para limpiar la selección de sector y productos -->
    <button class="btn btn-secondary mt-3 ms-3" @click="limpiarSeleccion">Limpiar Selección</button>

    <!-- Tabla para mostrar los productos con paginación -->
    <div v-if="productos.length">
        <table class="table table-striped table-hover mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Super ID</th>
                    <th>SKU</th>
                    <th>Nombre del Producto</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(producto, index) in paginatedProducts" :key="producto.superid">
                    <td>[[ index + 1 + (currentPage - 1) * itemsPerPage ]]</td>
                    <td>[[ producto.superid ]]</td>
                    <td>[[ producto.sku ]]</td>
                    <td>[[ producto.name ]]</td>
                </tr>
            </tbody>
        </table>

        <!-- Controles de paginación -->
        <nav aria-label="Paginación de productos">
            <ul class="pagination">
                <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
                    <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Anterior</a>
                </li>
                <li class="page-item" v-for="page in totalPages" :key="page" :class="{ 'active': currentPage === page }">
                    <a class="page-link" href="#" @click.prevent="changePage(page)">[[ page ]]</a>
                </li>
                <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
                    <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Modal para Clave Dinámica -->
<div class="modal fade" id="dynamicKeyModal" tabindex="-1" aria-labelledby="dynamicKeyModalLabel" aria-hidden="true" v-if="userRole === 'VENTAS' && !accesoPermitido">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dynamicKeyModalLabel">Acceso al Sector</h5>
            </div>
            <div class="modal-body">
                <input type="text" v-model="dynamicKey" placeholder="Ingrese la clave de acceso" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" @click="validateDynamicKey" class="btn btn-primary">Ingresar</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            dynamicKey: '',           // Clave ingresada por el usuario
            accesoPermitido: false,   // Estado de acceso
            userRole: '{{ user_role }}',     // Estado de acceso
            inputValue: '',              // Valor del input para sector o Super ID
            sectorSeleccionado: '',      // Sector actualmente seleccionado
            productos: [],               // Lista de productos en el sector
            currentPage: 1,              // Página actual
            itemsPerPage: 10,            // Productos por página
            productosParaAgregar: []     // Lista de productos a agregar
        },
        computed: {
            paginatedProducts() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                return this.productos.slice(start, end);
            },
            totalPages() {
                return Math.ceil(this.productos.length / this.itemsPerPage);
            }
        },
        mounted() {
            // Mostrar el modal de clave al cargar la página solo si el usuario es de Ventas
            if (this.userRole === 'VENTAS' && !this.accesoPermitido) {
                new bootstrap.Modal(document.getElementById('dynamicKeyModal')).show();
            }
        },
        methods: {
            validateDynamicKey() {
                axios.post('/api/validate-dynamic-key/', { key: this.dynamicKey })
                    .then(response => {
                        if (response.data.valid) {
                            this.accesoPermitido = true;
                            new bootstrap.Modal(document.getElementById('dynamicKeyModal')).hide();
                        } else {
                            Swal.fire('Error', 'Clave no válida o expirada.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo validar la clave.', 'error');
                        console.error(error);
                    });
            },
            procesarInput() {
                const valor = this.inputValue.trim();
                if (valor.startsWith('B-')) {
                    if (this.sectorSeleccionado === valor) {
                        this.limpiarSeleccion();
                        alert("Sector cerrado. Ahora puedes seleccionar uno nuevo.");
                    } else {
                        if (this.sectorSeleccionado) {
                            alert("Ya hay un sector abierto. Cierra el sector actual antes de abrir uno nuevo.");
                            return;
                        }
                        this.sectorSeleccionado = valor;
                        this.buscarProductos();
                    }
                } else {
                    this.agregarProductoPorSuperID(valor);
                }
                this.inputValue = '';
            },
            buscarProductos() {
                axios.post('/api/buscar-productos-sector/', {
                    searchTerm: this.sectorSeleccionado
                })
                .then(response => {
                    if (response.data.resp === 1) {
                        this.productos = response.data.productos;
                        this.currentPage = 1;
                    } else {
                        console.error(response.data.msg);
                        this.productos = [];
                    }
                })
                .catch(error => {
                    console.error('Error al buscar productos:', error);
                });
            },
            agregarProductoPorSuperID(superid) {
                if (this.productosParaAgregar.some(producto => producto.superid === superid)) {
                    console.warn('Este producto ya está en la lista.');
                    return;
                }
                this.productosParaAgregar.push({ superid });
            },
            addProductsToSector() {
                if (!this.sectorSeleccionado) {
                    console.error('Selecciona un sector antes de agregar productos.');
                    return;
                }
                if (this.productosParaAgregar.length === 0) {
                    console.error('No hay productos para agregar.');
                    return;
                }

                axios.post('/api/anadir-producto-sector/', {
                    productos: this.productosParaAgregar.map(p => ({ superid: p.superid })),
                    sector: this.sectorSeleccionado
                })
                .then(response => {
                    if (response.data.resp === 1) {
                        this.productosParaAgregar = [];
                        this.buscarProductos();
                    } else {
                        console.error(response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error al agregar productos:', error);
                });
            },
            changePage(page) {
                if (page > 0 && page <= this.totalPages) {
                    this.currentPage = page;
                }
            },
            limpiarSeleccion() {
                this.sectorSeleccionado = '';
                this.productosParaAgregar = [];
                this.productos = [];
                this.currentPage = 1;
                console.log("Selección limpiada, puedes ingresar un nuevo sector.");
            }
        }
    });
</script>
{% endblock js %}
