{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="m-2">
    <h3>Buscar Productos por Sector</h3>

    <!-- Input para ingresar el sector -->
    <div class="form-group">
        <input type="text" id="sectorInput" class="form-control" v-model="sectorQuery" placeholder="Ingresa el sector (ej. G1-1)" @keyup.enter="buscarProductos" />
    </div>

    <!-- Botón para buscar -->
    <button class="btn btn-primary mt-3" @click="buscarProductos">Buscar</button>

    <!-- Botón para abrir el modal de mover productos -->
    <button class="btn btn-warning mt-3" @click="abrirModalMoverProductos">Mover Productos</button>

    <!-- Input para añadir producto al sector actual -->
    <div class="form-group">
        <h5 class="mt-3">Añadir Producto al Sector</h5>
        <input type="text" id="addProductSuperID" class="form-control mb-2" v-model="newProductSuperID" placeholder="Ingresa el Super ID del producto para añadir" @keyup.enter="addProductToList" />
        <button class="btn btn-success" @click="addProductToList">Añadir Producto</button>
        <button class="btn btn-primary " @click="addProductsToSector" :disabled="productosParaAgregar.length === 0">Confirmar Agregar Productos</button>
    </div>

    <!-- Mostrar la lista de productos que se van a agregar -->
    <div v-if="productosParaAgregar.length">
        <h5 class="mt-3">Productos para agregar</h5>
        <ul class="list-group">
            <li v-for="(producto, index) in productosParaAgregar" :key="index" class="list-group-item">
                [[ producto.superid ]]
            </li>
        </ul>
    </div>

    <!-- Tabla para mostrar los productos con paginación -->
    <div v-if="productos.length">
        <table class="table table-striped table-hover mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Super ID</th>
                    <th>SKU</th>
                    <th>Nombre del Producto</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Stock</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(producto, index) in paginatedProducts" :key="producto.superid">
                    <td>[[ index + 1 + (currentPage - 1) * itemsPerPage ]]</td>
                    <td>[[ producto.superid ]]</td>
                    <td>[[ producto.sku ]]</td>
                    <td>[[ producto.name ]]</td>
                    <td>[[ producto.description ]]</td>
                    <td>[[ producto.price ]]</td>
                    <td>[[ producto.stock ]]</td>
                </tr>
            </tbody>
        </table>

        <!-- Controles de paginación -->
        <nav aria-label="Paginación de productos">
            <ul class="pagination">
                <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
                    <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Anterior</a>
                </li>
                <li class="page-item" v-for="page in totalPages" :key="page" :class="{ 'active': currentPage === page }">
                    <a class="page-link" href="#" @click.prevent="changePage(page)">[[ page ]]</a>
                </li>
                <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
                    <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Modal para mover productos a otro sector -->
    <div class="modal fade" id="modalMoverProductos" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Mover Productos a Otro Sector</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Input para agregar productos por Super ID -->
                    <div class="form-group">
                        <label for="superidInput">Ingresa Super ID de Producto</label>
                        <input type="text" class="form-control" v-model="superidInput" @keyup.enter="agregarProductoPorSuperID" placeholder="Ingresa el Super ID del producto y presiona Enter" />
                    </div>

                    <!-- Tabla para mostrar los productos añadidos -->
                    <h5>Productos seleccionados</h5>
                    <div v-if="productosSeleccionados.length">
                        <table class="table table-striped table-hover mt-4">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Super ID</th>
                                    <th>SKU</th>
                                    <th>Nombre del Producto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(producto, index) in productosSeleccionados" :key="producto.superid">
                                    <td>[[ index + 1 ]]</td>
                                    <td>[[ producto.superid ]]</td>
                                    <td>[[ producto.sku ]]</td>
                                    <td>[[ producto.name ]]</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Input para el sector de destino -->
                    <div class="form-group mt-3">
                        <label for="sectorDestino">Sector de destino:</label>
                        <input type="text" class="form-control" id="sectorDestino" v-model="sectorDestino" placeholder="Ingresa el sector de destino (ej. G2-1)" />
                    </div>
                    <p>Moviendo productos desde el sector [[ sectorQuery ]] a [[ sectorDestino ]]</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @click="moverProductos">Mover</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            sectorQuery: '',  // Sector actual
            productos: [],  // Productos encontrados en el sector
            currentPage: 1,  // Página actual
            itemsPerPage: 10,  // Número de productos por página
            newProductSuperID: '',  // Super ID del producto a añadir al sector
            productosParaAgregar: [],  // Lista de productos a agregar
            superidInput: '',  // Input de Super ID de producto a mover
            productosSeleccionados: [],  // Lista de productos seleccionados por Super ID
            sectorDestino: ''  // Sector de destino
        },
        computed: {
            // Obtener los productos para la página actual
            paginatedProducts() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                return this.productos.slice(start, end);
            },
            // Calcular el número total de páginas
            totalPages() {
                return Math.ceil(this.productos.length / this.itemsPerPage);
            }
        },
        methods: {
            // Buscar productos por sector
            buscarProductos() {
                axios.post('/api/buscar-productos-sector/', {
                    searchTerm: this.sectorQuery  // Enviar el término tal cual se ingresa
                })
                .then(response => {
                    if (response.data.resp === 1) {
                        this.productos = response.data.productos;
                        this.currentPage = 1;  // Resetear a la primera página
                    } else {
                        Swal.fire('Error', response.data.msg, 'error');
                        this.productos = [];
                    }
                })
                .catch(error => {
                    console.error('Error al buscar productos:', error);
                    Swal.fire('Error', 'Ocurrió un error al buscar productos.', 'error');
                });
            },
    
            // Cambiar la página actual
            changePage(page) {
                if (page > 0 && page <= this.totalPages) {
                    this.currentPage = page;
                }
            },
    
            // Abrir el modal para mover productos
            abrirModalMoverProductos() {
                $('#modalMoverProductos').modal('show');
            },
    
            // Agregar producto por Super ID a la lista para mover
            agregarProductoPorSuperID() {
                if (this.superidInput.trim() === '') {
                    Swal.fire('Error', 'Por favor, ingresa un Super ID.', 'error');
                    return;
                }
    
                // Verificar si el producto ya está en la lista para evitar duplicados
                const productoYaSeleccionado = this.productosSeleccionados.some(producto => producto.superid === this.superidInput.trim());
    
                if (productoYaSeleccionado) {
                    Swal.fire('Error', 'Este producto ya ha sido agregado a la lista.', 'error');
                    this.superidInput = '';  // Limpiar el input
                    return;
                }
    
                // Verificar si el producto con el Super ID existe en el sector actual
                axios.post('/api/buscar-producto-superid/', {
                    superid: this.superidInput,
                    sector_origen: this.sectorQuery
                })
                .then(response => {
                    if (response.data.resp === 1) {
                        // Agregar el producto a la lista de productos seleccionados
                        this.productosSeleccionados.push(response.data.producto);
                        this.superidInput = '';  // Limpiar el input
                    } else {
                        Swal.fire('Error', response.data.msg, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error al buscar producto por Super ID:', error);
                    Swal.fire('Error', 'Ocurrió un error al buscar el producto.', 'error');
                });
            },
    
            // Añadir producto a la lista para agregar al sector
            addProductToList() {
                if (this.newProductSuperID.trim() === '') {
                    Swal.fire('Error', 'Por favor, ingresa un Super ID válido.', 'error');
                    return;
                }
    
                // Verificar si el producto ya está en la lista para evitar duplicados
                if (this.productosParaAgregar.includes(this.newProductSuperID.trim())) {
                    Swal.fire('Error', 'Este producto ya está en la lista.', 'error');
                    return;
                }

                // Agregar el producto a la lista
                this.productosParaAgregar.push({ superid: this.newProductSuperID.trim() });
                this.newProductSuperID = '';  // Limpiar el input
            },
    
            // Confirmar añadir los productos al sector
            addProductsToSector() {
        if (this.productosParaAgregar.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No hay productos para agregar.',
            });
            return;
        }

        // Mostrar el SweetAlert de cargando
        Swal.fire({
            title: 'Cargando...',
            text: 'Agregando productos al sector',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading(); // Mostrar el indicador de cargando
            }
        });

        // Realizar la solicitud a la API para añadir los productos al sector
        axios.post('/api/anadir-producto-sector/', {
            productos: this.productosParaAgregar.map(p => ({ superid: p.superid })),  // Superids de los productos seleccionados
            sector: this.sectorQuery  // Sector actual
        })
        .then(response => {
            if (response.data.resp === 1) {
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: 'Productos añadidos con éxito.',
                }).then(() => {
                    this.productosParaAgregar = [];  // Vaciar la lista de productos para agregar
                    this.buscarProductos();  // Actualizar la lista de productos en el sector actual
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.data.msg,
                });
            }
        })
        .catch(error => {
            console.error('Error al agregar productos:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ocurrió un error al agregar los productos.',
            });
        });
    },
    
            // Mover productos seleccionados a otro sector
            moverProductos() {
        if (this.sectorDestino.trim() === '') {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor, ingresa un sector de destino.',
            });
            return;
        }

        // Mostrar el SweetAlert de cargando
        Swal.fire({
            title: 'Cargando...',
            text: 'Moviendo productos al nuevo sector',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading(); // Muestra el indicador de cargando
            }
        });

        // Enviar la lista de productos seleccionados para moverlos al nuevo sector
        axios.post('/api/mover-productos/', {
            productos: this.productosSeleccionados.map(p => p.superid),  // Lista de superid de productos seleccionados
            sector_origen: this.sectorQuery,
            sector_destino: this.sectorDestino
        })
        .then(response => {
            if (response.data.resp === 1) {
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: 'Productos movidos con éxito.',
                }).then(() => {
                    this.productosSeleccionados = [];
                    this.sectorDestino = '';
                    this.buscarProductos();  // Actualizar la lista de productos en el sector actual
                    $('#modalMoverProductos').modal('hide');  // Cerrar el modal
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.data.msg,
                });
            }
        })
        .catch(error => {
            console.error('Error al mover productos:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ocurrió un error al mover los productos.',
            });
        });
    },
        },
        mounted() {
            // Colocar el foco en el input cuando la página se carga
            this.$nextTick(() => {
                document.getElementById('sectorInput').focus();
            });
        }
    });
    </script>
{% endblock js %}
