{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="m-2">
    <h3>Cuadrar Productos en Sector</h3>

    <!-- Input para ingresar el sector -->
    <div class="form-group">
        <input type="text" id="sectorInput" class="form-control" v-model="sectorQuery" placeholder="Ingresa el sector (ej. G1-1)" @keyup.enter="buscarProductosSector" />
    </div>

    <!-- Botón para buscar productos en sector -->
    <button class="btn btn-primary mt-3" @click="buscarProductosSector">Buscar Productos en el Sector</button>

    <!-- Indicador de carga -->
    <div v-if="loading" class="text-center mt-3">
        <p><strong>Cargando productos...</strong></p>
    </div>

    <!-- Tabla para mostrar los productos en el sector -->
    <div v-if="!loading && productosEnSector.length">
        <h4>Productos en el sector {{ sectorQuery }}</h4>
        <table class="table table-striped table-hover mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>SuperID</th>
                    <th>SKU</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Stock</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(producto, index) in productosEnSector" :key="producto.superid">
                    <td>[[ index + 1 ]]</td>
                    <td>[[ producto.superid ]]</td>
                    <td>[[ producto.sku ]]</td>
                    <td>[[ producto.name ]]</td>
                    <td>[[ producto.description ]]</td>
                    <td>[[ producto.price ]]</td>
                    <td>[[ producto.stock ]]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Input para ingresar los superids escaneados -->
    <div class="form-group mt-3">
        <input type="text" id="scanInput" class="form-control" v-model="superid" placeholder="Escanear o ingresar SuperID" @keyup.enter="agregarProductoEscaneado" />
    </div>

    <!-- Botón para cuadrar productos -->
    <button class="btn btn-warning mt-3" @click="cuadrarProductos">Cuadrar Productos</button>

    <!-- Tabla para mostrar los productos escaneados -->
    <div v-if="!loading && productosEscaneados.length">
        <h4>Productos Escaneados</h4>
        <table class="table table-striped table-hover mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>SuperID</th>
                    <th>SKU</th>
                    <th>Nombre</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(producto, index) in productosEscaneados" :key="producto.superid">
                    <td>[[ index + 1 ]]</td>
                    <td>[[ producto.superid ]]</td>
                    <td>[[ producto.sku ]]</td>
                    <td>[[ producto.name ]]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Mensajes de productos movidos a Narnia -->
    <div v-if="!loading && productosMovidosNarnia.length">
        <h4>Productos movidos a Narnia</h4>
        <ul>
            <li v-for="producto in productosMovidosNarnia" :key="producto.superid">[[ producto.superid ]]</li>
        </ul>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script> <!-- Importar SweetAlert -->

<script>
new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
        sectorQuery: '',  // Sector actual
        superid: '',  // SuperID actual (escaneado o ingresado)
        productosEnSector: [],  // Productos en el sector
        productosEscaneados: [],  // Productos escaneados (con detalles como superid, sku, nombre)
        productosMovidosNarnia: [],  // Productos movidos a Narnia
        loading: false,  // Indicador de carga
    },
    methods: {
        // Buscar productos en el sector
        buscarProductosSector() {
            if (this.sectorQuery.trim() === '') {
                Swal.fire('Error', 'Por favor, ingresa un sector.', 'error');
                return;
            }

            this.loading = true;  // Iniciar indicador de carga
            this.productosEnSector = [];  // Limpiar la lista

            axios.post('/api/buscar-productos-sector/', {
                searchTerm: this.sectorQuery
            })
            .then(response => {
                this.loading = false;  // Detener indicador de carga
                if (response.data.resp === 1) {
                    this.productosEnSector = response.data.productos;
                } else {
                    Swal.fire('Error', response.data.msg, 'error');
                    this.productosEnSector = [];
                }
            })
            .catch(error => {
                this.loading = false;
                console.error('Error al buscar productos:', error);
                Swal.fire('Error', 'Ocurrió un error al buscar productos.', 'error');
            });
        },

        // Agregar el producto escaneado a la lista de escaneados
        agregarProductoEscaneado() {
            if (this.superid.trim() === '') {
                Swal.fire('Error', 'Por favor, ingresa un SuperID.', 'error');
                return;
            }

            const productoEnSector = this.productosEnSector.find(p => p.superid === this.superid);
            if (!productoEnSector) {
                Swal.fire('Error', 'El SuperID ingresado no pertenece al sector.', 'error');
                return;
            }

            if (!this.productosEscaneados.some(p => p.superid === this.superid)) {
                this.productosEscaneados.push({
                    superid: productoEnSector.superid,
                    sku: productoEnSector.sku,
                    name: productoEnSector.name
                });
                this.superid = '';  // Limpiar el input después de agregar
            } else {
                Swal.fire('Advertencia', 'El SuperID ya ha sido escaneado.', 'warning');
            }
        },

        // Cuadrar productos entre sector y escaneados
        cuadrarProductos() {
            if (this.productosEscaneados.length === 0) {
                Swal.fire('Advertencia', 'Por favor, escanea o ingresa al menos un producto.', 'warning');
                return;
            }

            this.loading = true;  // Iniciar indicador de carga

            axios.post('/api/cuadrar-productos/', {
                superids: this.productosEscaneados.map(p => p.superid),
                sector_id: this.sectorQuery
            })
            .then(response => {
                this.loading = false;
                if (response.data.resp === 1) {
                    this.productosMovidosNarnia = response.data.productos_faltantes;
                    this.productosEscaneados = [];  // Limpiar productos escaneados

                    Swal.fire({
                        title: 'Cuadratura completada',
                        text: 'Productos faltantes movidos a Narnia.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        this.productosEnSector = []; // Limpiar la lista actual
                        // Volver a cargar los productos del sector después de cuadrar
                        this.buscarProductosSector(); 
                    });
                } else {
                    Swal.fire('Error', response.data.msg, 'error');
                }
            })
            .catch(error => {
                this.loading = false;
                console.error('Error al cuadrar productos:', error);
                Swal.fire('Error', 'Ocurrió un error al cuadrar productos.', 'error');
            });
        }
    },
    mounted() {
        this.$nextTick(() => {
            document.getElementById('sectorInput').focus();
        });
    }
});
</script>
{% endblock js %}
