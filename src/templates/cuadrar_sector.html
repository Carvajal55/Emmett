{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="m-2">
    <h3>Cuadrar Productos en Sector</h3>

    <!-- Input único para ingresar sector y SuperID -->
    <div class="form-group">
        <input type="text" id="inputScanner" class="form-control" v-model="scannerInput" placeholder="Escanea el sector o el SuperID" @keyup.enter="procesarEntrada" />
    </div>

    <!-- Indicador de carga -->
    <div v-if="loading" class="text-center mt-3">
        <p><strong>Cargando productos...</strong></p>
    </div>

    <!-- Tabla para mostrar los productos en el sector -->
    <div v-if="!loading && productosEnSector.length">
        <h4>Productos en el sector [[ sectorQuery ]]</h4>
        <table class="table table-striped table-hover mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>SuperID</th>
                    <th>SKU</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Stock</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(producto, index) in productosEnSector" :key="producto.superid">
                    <td>[[ index + 1 ]]</td>
                    <td>[[ producto.superid ]]</td>
                    <td>[[ producto.sku ]]</td>
                    <td>[[ producto.name ]]</td>
                    <td>[[ producto.description ]]</td>
                    <td>[[ producto.price ]]</td>
                    <td>[[ producto.stock ]]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Tabla para mostrar los productos escaneados -->
    <div v-if="productosEscaneados.length">
        <h4>Productos Escaneados</h4>
        <table class="table table-striped table-hover mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>SuperID</th>
                    <th>SKU</th>
                    <th>Nombre</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(producto, index) in productosEscaneados" :key="producto.superid">
                    <td>[[ index + 1 ]]</td>
                    <td>[[ producto.superid ]]</td>
                    <td>[[ producto.sku ]]</td>
                    <td>[[ producto.name ]]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Mensajes de productos movidos a Narnia -->
    <div v-if="productosMovidosNarnia.length">
        <h4>Productos movidos a Narnia</h4>
        <ul>
            <li v-for="producto in productosMovidosNarnia" :key="producto.superid">[[ producto.superid ]]</li>
        </ul>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            scannerInput: '',         // Input para escanear sector o SuperID
            sectorQuery: '',          // Sector actual
            previousSector: '',       // Almacena el sector anterior escaneado
            productosEnSector: [],    // Productos en el sector actual
            productosEscaneados: [],  // Productos escaneados
            productosMovidosNarnia: [], // Productos movidos a Narnia
            loading: false,           // Indicador de carga
        },
        methods: {
            // Procesa el input de escaneo (sector o SuperID)
            procesarEntrada() {
                const input = this.scannerInput.trim();
                
                // Verificar si el input es un sector (B-)
                if (input.startsWith('B-')) {
                    // Verificar si el sector ya está escaneado
                    if (input === this.previousSector) {
                        this.cuadrarProductos(); // Cuadrar productos si es el mismo sector
                    } else {
                        this.sectorQuery = input;
                        this.buscarProductosSector();
                        this.previousSector = input; // Actualizar el sector previo
                        this.productosEscaneados = []; // Limpiar la lista de escaneados
                    }
                } else {
                    // Agregar SuperID escaneado
                    this.agregarProductoEscaneado(input);
                }
                this.scannerInput = ''; // Limpiar el input
            },
    
            // Buscar productos en el sector actual
            buscarProductosSector() {
                if (!this.sectorQuery) return;
                this.loading = true;
                this.productosEnSector = []; 
    
                axios.post('/api/buscar-productos-sector/', { searchTerm: this.sectorQuery })
                    .then(response => {
                        this.loading = false;
                        this.productosEnSector = response.data.resp === 1 ? response.data.productos : [];
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('Error al buscar productos:', error);
                        this.productosEnSector = [];  // Asegura que esté definido
                    });
            },
    
            // Agregar SuperID a la lista de productos escaneados
            agregarProductoEscaneado(superid) {
                const productoEnSector = this.productosEnSector ? this.productosEnSector.find(p => p.superid === superid) : null;
                if (productoEnSector && !this.productosEscaneados.some(p => p.superid === superid)) {
                    this.productosEscaneados.push({
                        superid: productoEnSector.superid,
                        sku: productoEnSector.sku,
                        name: productoEnSector.name
                    });
                }
            },
    
            // Cuadrar productos entre sector y escaneados
            cuadrarProductos() {
                if (this.productosEscaneados.length === 0) {
                    alert("Escanea al menos un producto antes de cuadrar.");
                    return;
                }
                this.loading = true;

                axios.post('/api/cuadrar-productos/', {
                    superids: this.productosEscaneados.map(p => p.superid),
                    sector_id: this.sectorQuery
                })
                .then(response => {
                    this.loading = false;
                    if (response.data.resp === 1) {
                        this.productosMovidosNarnia = response.data.productos_faltantes || [];
                        this.productosEscaneados = [];  // Limpiar productos escaneados

                        // Mostrar SweetAlert de éxito con duración de 2 segundos
                        Swal.fire({
                            title: 'Cuadratura completada',
                            text: 'Productos faltantes movidos a Narnia.',
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 2000 // Duración de 2 segundos
                        });

                        // Limpiar el sector, sector previo, y productos en el sector
                        this.sectorQuery = '';
                        this.previousSector = '';
                        this.productosEnSector = [];  // Limpiar productos en el sector para vaciar la tabla
                    } else {
                        console.error('Error en cuadratura:', response.data.msg);
                    }
                })
                .catch(error => {
                    this.loading = false;
                    console.error('Error al cuadrar productos:', error);
                    this.productosMovidosNarnia = [];  // Asegura que esté definido
                });
            }
        },
        mounted() {
            // Colocar el foco en el input al cargar la página
            this.$nextTick(() => document.getElementById('inputScanner').focus());
        }
    });
    </script>
{% endblock js %}
