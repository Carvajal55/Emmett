{% extends 'partials/base.html' %}
{% load static %}

{% block css %}
<style>
#chat-iframe {
    position: fixed;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    border: none;
    box-shadow: -2px -2px 5px rgba(0,0,0,0.2);
    background-color: red;
}
</style>
<link rel="stylesheet" href="{% static 'libs/owl.carousel/dist/assets/owl.carousel.min.css' %}">
{% endblock css %}
 <!-- Your existing content here -->

{% block content %}
<div id="app" class="container mt-5">
  <div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header" style="background-color: #003399; color: white;">
                <h6 class="mb-0" style="color: white;">Comparar Stock con Bsale</h6>
            </div>
            <div class="card-body">
                <button @click="iniciarComparacion" class="btn btn-primary mt-3" :disabled="loading">
                    [[ loading ? 'Comparando...' : 'Comparar Stock en Bsale' ]]
                </button>
                
                <!-- Barra de progreso -->
                <div class="progress mt-3" v-if="loading">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         :style="{ width: progress + '%' }" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        [[ progress ]]%
                    </div>
                </div>

                <div v-if="comparacionResultado.length > 0">
                    <h6>Resumen de la Comparación:</h6>
                    <table class="table table-striped mt-3">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Stock Local</th>
                                <th>Stock Bsale</th>
                                <th>Diferencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="producto in comparacionResultado" :key="producto.sku">
                                <td>[[ producto.sku ]]</td>
                                <td>[[ producto.stock_local ]]</td>
                                <td>[[ producto.stock_bsale ]]</td>
                                <td>[[ producto.diferencia ]]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
      <!-- Card para mostrar el Rol del Usuario -->
      <div class="col-md-6 mb-4">
          <div class="card h-100">
              <div class="card-header" style="background-color: #003399; color: white;">
                  <h6 class="mb-0" style="color: white;">Rol de Usuario</h6>
              </div>
              <div class="card-body">
                {% if request.user.usuario.rol == 'ADMIN' %}
                <div>
                    <button @click="generateDynamicKey" class="btn btn-warning mt-3">Generar Clave de Acceso</button>
                    <p class="mt-2" v-if="generatedKey">Clave Generada: <span>[[ generatedKey ]]</span> (Expira en 5 minutos)</p>
                </div>
                {% endif %}
                  <p class="mt-2">ROL: {{ request.user.usuario.rol }}</p>
              </div>
          </div>
      </div>

      <!-- Card de Bienvenida o Pantalla de Inicio -->
      <div class="col-md-6 mb-4">
          <div class="card h-100">
              <div class="card-header" style="background-color: #003399; color: white;">
                  <h6 class="mb-0" style="color: white;">Pantalla Inicio</h6>
              </div>
              <div class="card-body">
                  <p class="mb-0">Bienvenido a la plataforma. Explora las distintas secciones y funciones disponibles según tu rol.</p>
              </div>
          </div>
      </div>

      <!-- Card para Anuncio de Gráficos Próximos -->
      <div class="col-md-6 mb-4">
          <div class="card h-100">
              <div class="card-header" style="background-color: #003399; color: white;">
                  <h6 class="mb-0" style="color: white;">Próximamente</h6>
              </div>
              <div class="card-body">
                  <p class="mb-0">Estaremos añadiendo gráficos y estadísticas para visualizar mejor la información relevante.</p>
              </div>
          </div>
      </div>

      <!-- Card para Información de Contacto -->
      <div class="col-md-6 mb-4">
          <div class="card h-100">
              <div class="card-header" style="background-color: #003399; color: white;">
                  <h6 class="mb-0" style="color: white;">Contacto</h6>
              </div>
              <div class="card-body">
                  <p class="mb-0">Para cualquier duda o comentario, contáctanos en <a href="mailto:carvajal.emmett@gmail.com" style="color: blue;">carvajal.emmett@gmail.com</a>.</p>
              </div>
          </div>
      </div>
  </div>
</div>

{% endblock content %}

{% block js %}
<script src="{% static 'chat.js' %}"></script>
<script src="{% static 'libs/owl.carousel/dist/owl.carousel.min.js' %}"></script>
<script src="{% static 'libs/apexcharts/dist/apexcharts.min.js' %}"></script>

<script>
  var app = new Vue({
      el: '#app',
      delimiters: ['[[', ']]'],
      data: {
        dynamicKey: '',
        generatedKey: '', 
        cantidad_de_mensajes: 0,
        cantidad_de_mensajes_whatsapp: 0,
        cantidad_de_mensajes_text: 0,
        llaves: null,
        valores: null,
        ejecutivos: [],
        fecha_select: "{{meses.0}}",
        comparacionResultado: [], // Almacena los resultados de la comparación
        progress: 0,             // Progreso de la comparación en porcentaje
        loading: false 
      },
      mounted() {
      },
      methods: {
        iniciarComparacion() {
            this.loading = true;
            this.progress = 0;

            const eventSource = new EventSource('/api/comparar-stock-bsale/');

            eventSource.onmessage = (event) => {
                const message = event.data;

                // Verificar si el mensaje contiene progreso
                const match = message.match(/Progreso: (\d+(\.\d+)?)%/);
                if (match) {
                    this.progress = parseFloat(match[1]); // Actualizar el progreso en porcentaje
                }

                // Detectar finalización
                if (message.includes("Comparación completada")) {
                    Swal.fire('Éxito', 'La comparación se completó correctamente.', 'success');
                    this.loading = false;
                    eventSource.close();
                }
            };

            eventSource.onerror = (error) => {
                console.error("Error en el evento SSE:", error);
                Swal.fire('Error', 'Ocurrió un error durante la comparación.', 'error');
                this.loading = false;
                this.progress = 0; // Reiniciar progreso en caso de error
                eventSource.close();
            };
        },
        generateDynamicKey() {
            axios.post('/api/generate-dynamic-key/')
                .then(response => {
                    this.generatedKey = response.data.key;  // Almacena la clave generada en generatedKey
                    console.log("Generated Key:", this.generatedKey);  // Confirma en la consola
                })
                .catch(error => {
                    Swal.fire('Error', 'No se pudo generar la clave de acceso.', 'error');
                    console.error(error);
                });
        },
          

          getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
          },

          createChartOptions(llaves, valores) {
            return {
              series: [{ name: "Cantidad de conversaciones", data: valores }],
              chart: { toolbar: { show: false }, type: "bar", height: 320, stacked: true },
              colors: ["var(--bs-secondary)"],
              plotOptions: { bar: { horizontal: false, barHeight: "60%", columnWidth: "20%", borderRadius: [6] } },
              dataLabels: { enabled: false },
              xaxis: { categories: llaves },
              yaxis: { tickAmount: 4 },
              tooltip: { theme: "dark" },
            };
          },

          createBreakupChart() {
            return {
              color: "#adb5bd",
              series: [38, 40, 25],
              labels: ["2022", "2021", "2020"],
              chart: { width: 180, type: "donut" },
              colors: ["var(--bs-primary)", "#ecf2ff", "#F9F9FD"],
              responsive: [{ breakpoint: 991, options: { chart: { width: 120 } } }],
              tooltip: { theme: "dark", fillSeriesColor: false },
            };
          },

          createEarningChart() {
            return {
              chart: { id: "sparkline3", type: "area", height: 60, sparkline: { enabled: true } },
              series: [{ name: "Earnings", data: [25, 66, 20, 40, 12, 58, 20] }],
              stroke: { curve: "smooth", width: 2 },
              fill: { type: "gradient", opacity: 0.5 },
              markers: { size: 0 },
              tooltip: { theme: "dark", fixed: { enabled: true, position: "right" } },
            };
          }
      },
  })
</script>
{% endblock js %}
