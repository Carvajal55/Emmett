{% extends 'partials/base.html' %}
{% load static %}

{% block css %}
<style>
    .progress-bar {
        transition: width 0.5s ease-in-out;
    }
</style>
<link rel="stylesheet" href="{% static 'libs/owl.carousel/dist/assets/owl.carousel.min.css' %}">
{% endblock css %}

{% block content %}
<div id="app" class="container mt-5">
    <div class="row">
        <!-- Comparación de Stock con Bsale -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">Comparar Stock con Bsale</h6>
                </div>
                <div class="card-body">
                    <button @click="iniciarComparacion" class="btn btn-primary mt-3" :disabled="loading">
                        [[ loading ? 'Comparando...' : 'Comparar Stock en Bsale' ]]
                    </button>

                    <!-- Barra de Progreso -->
                    <div v-if="loading" class="mt-4">
                       
                        <h6>Progreso de la Comparación</h6>
                        <div class="progress">
                            <div 
                                id="progressBar"
                                class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                role="progressbar"
                                style="width: 0%;"
                                aria-valuenow="0"
                                aria-valuemin="0"
                                aria-valuemax="100">
                                [[ progress ]]%
                            </div>
                        </div>
                      
                        
                        <p id="progressText" class="text-center mt-2">[[ progressMessage ]]</p>
                    </div>

                    <div v-else-if="!loading" class="mt-4 text-muted">
                        <p>No se han encontrado diferencias en el stock.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Respaldo de Productos -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">Gestión de Unique Products</h6>
                </div>
                <div class="card-body">
                    <button @click="hacerRespaldo" class="btn btn-primary mt-3">Hacer Respaldo</button>
                    <button @click="descargarBackup" class="btn btn-primary mt-3">Descargar Respaldo</button>
                    <button @click="descargarBackupExcel" class="btn btn-primary mt-3">Descargar Excel</button>

                    <div class="mt-4">
                        <h6>Cargar Respaldo</h6>
                        <input type="file" @change="handleFileUpload" accept="application/json" class="form-control">
                        <button @click="cargarRespaldo" class="btn btn-warning mt-3">Cargar Respaldo</button>
                    </div>

                    <div class="mt-4">
                        <h6>Cargar Productos</h6>
                        <input type="file" @change="handleFileUpload" class="form-control">
                        <button @click="uploadProductsFile" class="btn btn-success mt-3">Cargar Productos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block js %}
<script src="{% static 'chat.js' %}"></script>
<script src="{% static 'libs/owl.carousel/dist/owl.carousel.min.js' %}"></script>
<script src="{% static 'libs/apexcharts/dist/apexcharts.min.js' %}"></script>

<script>
    var app = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            file: null,
            progress: 0,
            loading: false,
            progressMessage: "Esperando inicio...",
            comparacionResultado: []
        },
        methods: {
            handleFileUpload(event) {
                this.file = event.target.files[0];
            },
           
            iniciarComparacion() {
                this.loading = true;
                this.progressMessage = "Iniciando comparación...";

                axios.post('/api/ajustar_stock_bsale/')
                    .then(response => {
                        console.log("📊 Resultado:", response.data);
                        this.comparacionResultado = response.data.productos_ajustados;
                        this.loading = false;
                        
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Ocurrió un error al iniciar la comparación.', 'error');
                        console.error(error);
                        this.loading = false;
                    });
            },

            checkProgress() {
                axios.get("/api/progreso_stock/")
                    .then(response => {
                        console.log("📊 Recibiendo progreso:", response.data);
                        
                        this.progress = response.data.progress;
                        this.progressMessage = response.data.logs.join("\n");  // Mostrar logs como texto
                        
                        if (this.progress < 100) {
                            setTimeout(() => this.checkProgress(), 2000);
                        } else {
                            this.loading = false;
                            Swal.fire({
                                title: '¡Completado!',
                                text: 'La comparación de stock ha finalizado.',
                                icon: 'success',
                                confirmButtonText: 'Descargar Reporte',
                            }).then(() => {
                                window.location.href = '/api/descargar-reporte-stock/';
                            });
                        }
                    })
                    .catch(error => {
                        console.error("❌ Error obteniendo el progreso:", error);
                        this.loading = false;
                    });
            },

            obtenerLogs() {
                axios.get("/api/logs_stock/")
                    .then(response => {
                        this.logs = response.data.logs;
                    })
                    .catch(error => {
                        console.error("❌ Error obteniendo logs:", error);
                    });
            },
            hacerRespaldo() {
                axios.get('/api/backup-unique-products/')
                    .then(response => {
                        Swal.fire('Éxito', response.data.message, 'success');
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Ocurrió un problema al realizar el respaldo.', 'error');
                        console.error(error);
                    });
            },
            descargarBackup() {
                window.location.href = '/api/backup-unique-products/';
            },
            descargarBackupExcel() {
                window.location.href = '/api/generar-excel-stock/';
            },
            async uploadProductsFile() {
                if (!this.file) {
                    Swal.fire('Advertencia', 'Debe seleccionar un archivo JSON.', 'warning');
                    return;
                }
                const formData = new FormData();
                formData.append('file', this.file);

                try {
                    const response = await axios.post('/api/bulk-upload-products/', formData);
                    Swal.fire('Éxito', response.data.message, 'success');
                } catch (error) {
                    Swal.fire('Error', 'Error al cargar el archivo.', 'error');
                }
            }
        }
    });
</script>
{% endblock js %}
