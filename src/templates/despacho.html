{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<body class="" >
    <head>
        <audio id="successSound" src="{% static 'sounds/success.mp3' %}" preload="auto"></audio>
        <audio id="errorSound" src="{% static 'sounds/error.mp3' %}" preload="auto"></audio>

        <meta charset="utf-8">
        <title>Despacho</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    </head>
    <body>
        <div id="app" class="container">
            <div>
                <label for="cbCompany">Compañía</label>
                <select id="cbCompany" v-model="company" class="form-select">
                    <option value="1">EMMETT</option>
                    <option value="2">SOUNDSTORE</option>
                    <option value="3">GROBEN</option>
                </select>
            </div>
            <div>
                <label for="cbTypeDocument">Tipo Documento</label>
                <select id="cbTypeDocument" v-model="typeDocument" class="form-select">
                    <option value="39">BOLETA</option>
                    <option value="33">FACTURA</option>
                    <option value="52">GUIA</option>
                </select>
            </div>
            <div>
                <label for="nDocument">N° Documento</label>
                <input id="nDocument" type="number" v-model="nDocument" @change="fetchDetails" class="form-control">
            </div>   
            <div>
                <label for="sidProduct">ID Producto</label>
                <input id="sidProduct" type="text" v-model="sid" @keyup.enter="validateAndLinkSuperid(false)" class="form-control">
            </div>             
            
            <button @click="dispatchConsumption" class="mt-3 btn btn-success">Despachar</button>
            {% if request.user.usuario.rol == 'VENTAS' %}
    <!-- Botón que requiere clave, visible solo para el rol de VENTAS -->
                <button @click="requestDynamicKeyAccess" class="mt-3 btn btn-primary">Despacho Interno</button>
            {% endif %}

            {% if request.user.usuario.rol == 'ADMIN' or request.user.usuario.rol == 'BODEGA' %}
                <!-- Botón sin clave, visible solo para ADMIN y BODEGA -->
                <button @click="openInternalDispatchModal" class="mt-3 btn btn-primary">Despacho Interno</button>
            {% endif %}
            


            <!-- Modal para ingresar la clave dinámica -->
            <div class="modal fade" id="dynamicKeyModal" tabindex="-1" aria-labelledby="dynamicKeyModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            
                            <h5 class="modal-title" id="dynamicKeyModalLabel">Acceso al Despacho Interno</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                            <input type="text" v-model="dynamicKey" placeholder="Ingrese la clave de acceso" class="form-control" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" @click="validateDynamicKey" class="btn btn-primary">Ingresar</button>
                        </div>
                    </div>
                </div>
            </div>
           
        <!-- Modal para "Despacho Interno" -->
        <div class="modal fade" id="internalDispatchModal" tabindex="-1" aria-labelledby="internalDispatchModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="internalDispatchModalLabel">Despacho Interno</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="modalTypeDocument" class="form-label">Tipo de Documento</label>
                            <select id="modalTypeDocument" v-model="typeDocument" class="form-select">
                                <option value="39">Boleta</option>
                                <option value="33">Factura</option>
                                <option value="52">Guía</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalNDocument" class="form-label">Número de Documento</label>
                            <input id="modalNDocument" type="number" v-model="nDocument" class="form-control" placeholder="Ingrese el número del documento">
                        </div>
                        <div v-show="alertasuccess" class="alert alert-success">
                            <strong>¡Éxito!</strong> Producto despachado correctamente.
                        </div>
                        <div v-show="alertaerror" class="alert alert-danger">
                            <strong>Error:</strong> No se pudo despachar el producto.
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" v-model="sid" class="form-control" placeholder="Ingrese SuperID" @keyup.enter="validateAndLinkSuperid(true)">
                            <button type="button" class="btn btn-primary" @click="validateAndLinkSuperid(true)">Agregar</button>
                        </div>
                        <table class="d-none table">
                            <thead>
                                <tr>
                                    <th>SuperID</th>
                                    <th>SKU</th>
                                    <th>Descripción</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(product, index) in internalProducts" :key="index">
                                    <td>[[ product.superid ]]</td>
                                    <td>[[ product.code ]]</td>
                                    <td>[[ product.description ]]</td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm" @click="removeInternalProduct(index)">Eliminar</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
            
        <table class="table mt-3">
            <thead>
                <tr>
                    <th>SuperID</th>
                    <th>SKU</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(product, index) in products" :key="index">
                    <td>[[ product.superid ]]</td>
                    <td>[[ product.code ]]</td>
                    <td>[[ product.description ]]</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" @click="removeProduct(index)">Eliminar</button>
                    </td>
                </tr>
            </tbody>
        </table>
            
        </div>
</body>
{% endblock %}

{% block js %}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            dynamicKey: '',           // Clave ingresada por el usuario
            generatedKey: '',         // Clave generada
            validKey: false, 
            company: 1,
            typeDocument: 39,
            nDocument: null,
            sid: null,
            products: [],
            newProduct: { superid: '', code: '', quantity: 1 },
            internalProducts: [], // Lista de productos para despacho interno
            alertasuccess:false,
            alertaerror:false,
        },
        watch: {
            typeDocument() {
                if (this.nDocument) this.fetchDetails();
            },
            company() {
                if (this.nDocument) this.fetchDetails();
            }
        },
        methods: {
            requestDynamicKeyAccess() {
                new bootstrap.Modal(document.getElementById('dynamicKeyModal')).show();
            },
            removeInternalProduct(index) {
                this.internalProducts.splice(index, 1); // Eliminar producto de la lista interna
            },
            validateDynamicKey() {
                axios.post('/api/validate-dynamic-key/', { key: this.dynamicKey })
                    .then(response => {
                        if (response.data.valid) {
                            this.validKey = true;
                            new bootstrap.Modal(document.getElementById('dynamicKeyModal')).hide();
                            new bootstrap.Modal(document.getElementById('internalDispatchModal')).show();
                        } else {
                            Swal.fire('Error', 'Clave no válida o expirada.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo validar la clave.', 'error');
                        console.error(error);
                    });
            },
            generateDynamicKey() {
                axios.post('/api/generate-dynamic-key/')
                    .then(response => {
                        this.generatedKey = response.data.key;
                        // Forzar actualización
                        this.$nextTick(() => {
                            console.log("Generated Key:", this.generatedKey);
                        });
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo generar la clave de acceso.', 'error');
                        console.error(error);
                    });
            },
            dispatchInternalProducts() {
                const payload = this.internalProducts.map(product => ({
                    superid: product.superid
                }));

                axios.post('/api/dispatch-consumption/', { products: payload })
                    .then(response => {
                        if (response.data.icon === 'success') {
                            Swal.fire('Éxito', 'Productos despachados internamente con éxito.', 'success');
                            this.internalProducts = []; // Limpiar la lista después del despacho
                        } else {
                            Swal.fire('Error', response.data.title, response.data.icon);
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Error al despachar los productos internamente.', 'error');
                        console.error(error);
                    });
            },

            fetchDetails() {
                this.products = [];
                axios.get('/api/consult-bsale-document/', {
                    params: { number: this.nDocument, type: this.typeDocument }
                }).then(response => {
                    this.products = response.data.map(product => ({
                        code: product.code,
                        description: product.description,
                        totalAmount: product.totalAmount,
                        quantity: product.quantity,
                        count: 0,
                        name : product.name,
                        superid: null
                    }));
                }).catch(error => {
                    Swal.fire('Error', 'No se pudieron obtener los detalles del documento.', 'error');
                    console.error(error);
                });
            },
            playSound(soundId) {
                const audioElement = document.getElementById(soundId);
                if (audioElement) {
                    audioElement.play();
                } else {
                    console.error(`El sonido con ID ${soundId} no se encontró.`);
                }
            },
            validateAndLinkSuperid(isInternal = false) {
                const superidToValidate = this.sid;

                // Validar que el tipo y número de documento estén completos
                if (!this.typeDocument || !this.nDocument) {
                    Swal.fire('Error', 'Debe ingresar el tipo y número de documento antes de agregar un producto.', 'error');
                    return;
                }

                axios.post('/api/validate-superid/', { sid: superidToValidate })
                    .then(response => {
                        if (response.data.icon === 'success') {
                            const product = {
                                superid: superidToValidate,
                                code: response.data.sku,
                                description: response.data.description
                            };

                            // Llamar a dispatchConsumption con el producto validado
                            this.dispatchConsumption(product);

                            this.sid = ''; // Limpiar el campo de entrada
                        } else {
                            Swal.fire('Error', response.data.title, response.data.icon);
                            this.playSound('errorSound'); // Reproducir sonido de error
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Error al validar el SuperID.', 'error');
                        this.playSound('errorSound'); // Reproducir sonido de error
                        console.error(error);
                    });
            },

            dispatchConsumption(product) {
                // Verificar que el número de documento y el tipo de documento estén completos
                if (!this.nDocument || !this.typeDocument) {
                    Swal.fire('Error', 'Debe ingresar el tipo y número de documento antes de despachar.', 'error');
                    return;
                }

                axios.post('/api/dispatch-consumption/', {
                    nDocument: this.nDocument,         // Número de documento
                    typeDocument: this.typeDocument,   // Tipo de documento
                    company: this.company,             // Compañía seleccionada
                    products: [product]                // Producto a despachar
                })
                .then(response => {
                    if (response.data.icon === 'success') {
                        this.alertasuccess = true;      // Mostrar mensaje de éxito
                        this.playSound('successSound'); // Reproducir sonido de éxito

                        // Opcional: Aquí puedes limpiar los datos o actualizar la lista de productos
                    } else {
                        Swal.fire('Error', response.data.title, response.data.icon);
                        this.playSound('errorSound'); // Reproducir sonido de error
                    }
                })
                .catch(error => {
                    this.alertaerror = true;           // Mostrar mensaje de error
                    this.playSound('errorSound');      // Reproducir sonido de error
                    console.error(error);
                });
            },
            openInternalDispatchModal() {
                new bootstrap.Modal(document.getElementById('internalDispatchModal')).show();
            }
        }
    });
</script>
{% endblock js %}