{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<body class="" >
    <head>
        <audio id="successSound" src="{% static 'sounds/success.mp3' %}" preload="auto"></audio>
        <audio id="errorSound" src="{% static 'sounds/error.mp3' %}" preload="auto"></audio>

        <meta charset="utf-8">
        <title>Despacho</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    </head>
    <body>
        <div id="app" class="container">
            <div>
                <label for="cbCompany">Compañía</label>
                <select id="cbCompany" v-model="company" class="form-select">
                    <option value="1">EMMETT</option>
                    <option value="2">SOUNDSTORE</option>
                    <option value="3">GROBEN</option>
                </select>
            </div>
            <div>
                <label for="cbTypeDocument">Tipo Documento</label>
                <select id="cbTypeDocument" v-model="typeDocument" class="form-select">
                    <option value="39">BOLETA</option>
                    <option value="33">FACTURA</option>
                    <option value="52">GUIA</option>
                </select>
            </div>
            <div>
                <label for="nDocument">N° Documento</label>
                <input id="nDocument" type="number" v-model="nDocument" @change="fetchDetails" class="form-control">
            </div>   
            <div>
                <label for="sidProduct">ID Producto</label>
                <input id="sidProduct" type="text" v-model="sid" @keyup.enter="validateAndLinkSuperid(false)" class="form-control">
            </div>             
            
            <button @click="dispatchConsumption" class="mt-3 btn btn-success">Despachar</button>
            {% if request.user.usuario.rol == 'VENTAS' %}
    <!-- Botón que requiere clave, visible solo para el rol de VENTAS -->
                <button @click="requestDynamicKeyAccess" class="d-none mt-3 btn btn-primary">Despacho Interno</button>
            {% endif %}

            {% if request.user.usuario.rol == 'ADMIN' or request.user.usuario.rol == 'BODEGA' %}
                <!-- Botón sin clave, visible solo para ADMIN y BODEGA -->
                <button @click="openInternalDispatchModal" class="d-none mt-3 btn btn-primary">Despacho Interno</button>
            {% endif %}
            


            <!-- Modal para ingresar la clave dinámica -->
            <div class="modal fade" id="dynamicKeyModal" tabindex="-1" aria-labelledby="dynamicKeyModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            
                            <h5 class="modal-title" id="dynamicKeyModalLabel">Acceso al Despacho Interno</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                            <input type="text" v-model="dynamicKey" placeholder="Ingrese la clave de acceso" class="form-control" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" @click="validateDynamicKey" class="btn btn-primary">Ingresar</button>
                        </div>
                    </div>
                </div>
            </div>
           
        <!-- Modal para "Despacho Interno" -->
        <div class="modal fade" id="internalDispatchModal" tabindex="-1" aria-labelledby="internalDispatchModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="internalDispatchModalLabel">Despacho Interno</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="modalTypeDocument" class="form-label">Tipo de Documento</label>
                            <select id="modalTypeDocument" v-model="typeDocument" class="form-select">
                                <option value="39">Boleta</option>
                                <option value="33">Factura</option>
                                <option value="52">Guía</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalNDocument" class="form-label">Número de Documento</label>
                            <input id="modalNDocument" type="number" v-model="nDocument" class="form-control" placeholder="Ingrese el número del documento">
                        </div>
                        <div v-show="alertasuccess" class="alert alert-success">
                            <strong>¡Éxito!</strong> Producto despachado correctamente.
                        </div>
                        <div v-show="alertaerror" class="alert alert-danger">
                            <strong>Error:</strong> No se pudo despachar el producto.
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" v-model="sid" class="form-control" placeholder="Ingrese SuperID" @keyup.enter="validateAndLinkSuperid(true)">
                            <button type="button" class="btn btn-primary" @click="validateAndLinkSuperid(true)">Agregar</button>
                        </div>
                        <table class="d-none table">
                            <thead>
                                <tr>
                                    <th>SuperID</th>
                                    <th>SKU</th>
                                    <th>Descripción</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(product, index) in internalProducts" :key="index">
                                    <td>[[ product.superid ]]</td>
                                    <td>[[ product.code ]]</td>
                                    <td>[[ product.description ]]</td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm" @click="removeInternalProduct(index)">Eliminar</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
            
        <table class="table mt-3">
            <thead>
                <tr>
                    <th>SuperID</th>
                    <th>SKU</th>
                    <th>Nombre</th>
                    <th>Cantidad Escaneada / Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(product, index) in products" :key="index" :class="getProductRowClass(product)">
                    <td>[[ product.superid || 'Pendiente' ]]</td>
                    <td>[[ product.code ]]</td>
                    <td>[[ product.name ]]</td>
                    <td>[[ product.quantityScanned ]] / [[ product.quantity ]]</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" @click="removeProduct(index)">Eliminar</button>
                    </td>
                </tr>
            </tbody>
        </table>
            
        </div>
</body>
{% endblock %}

{% block js %}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            dynamicKey: '',           // Clave ingresada por el usuario
            generatedKey: '',         // Clave generada
            validKey: false, 
            company: 1,
            typeDocument: 39,
            nDocument: null,
            sid: null,
            products: [],
            newProduct: { superid: '', code: '', quantity: 1 },
            internalProducts: [], // Lista de productos para despacho interno
            alertasuccess:false,
            alertaerror:false,
            processingQueue: [],     // Cola de SuperIDs en espera
            isProcessing: false,     // Bandera para evitar procesos simultáneos
        },
        watch: {
            typeDocument() {
                if (this.nDocument) this.fetchDetails();
            },
            company() {
                if (this.nDocument) this.fetchDetails();
            }
        },
        mounted() {
            // Inicializar el modal del despacho interno
            const modalElement = document.getElementById('internalDispatchModal');
            if (modalElement) {
                this.modalInstance = new bootstrap.Modal(modalElement, {
                    keyboard: false,    // Prevenir cierre con teclado
                    backdrop: 'static'  // Prevenir cierre al hacer clic fuera
                });
            }
        },

        methods: {
            requestDynamicKeyAccess() {
                new bootstrap.Modal(document.getElementById('dynamicKeyModal')).show();
            },
            removeInternalProduct(index) {
                this.internalProducts.splice(index, 1); // Eliminar producto de la lista interna
            },
            validateDynamicKey() {
                axios.post('/api/validate-dynamic-key/', { key: this.dynamicKey })
                    .then(response => {
                        if (response.data.valid) {
                            this.validKey = true;
                            new bootstrap.Modal(document.getElementById('dynamicKeyModal')).hide();
                            new bootstrap.Modal(document.getElementById('internalDispatchModal')).show();
                        } else {
                            Swal.fire('Error', 'Clave no válida o expirada.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo validar la clave.', 'error');
                        console.error(error);
                    });
            },
            dispatchInternalProducts() {
                const payload = this.internalProducts.map(product => ({
                    superid: product.superid
                }));

                axios.post('/api/dispatch-consumption/', { products: payload })
                    .then(response => {
                        if (response.data.icon === 'success') {
                            this.internalProducts = []; // Limpiar la lista después del despacho
                        } else {
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            },

            fetchDetails() {
                this.products = [];
                axios.get('/api/consult-bsale-document/', {
                    params: { number: this.nDocument, type: this.typeDocument }
                }).then(response => {
                    this.products = response.data.map(product => ({
                        code: product.code,
                        name: product.name,         // Usar el nombre en lugar de la descripción
                        description: product.description, // Opcional, si decides mantenerlo
                        totalAmount: product.totalAmount,
                        quantity: product.quantity, // Cantidad esperada
                        quantityScanned: 0,         // Cantidad escaneada inicial
                        superid: null
                    }));
                }).catch(error => {
                    Swal.fire('Error', 'No se pudieron obtener los detalles del documento.', 'error');
                    console.error(error);
                });
            },
            playSound(soundId) {
                const audioElement = document.getElementById(soundId);
                if (audioElement) {
                    audioElement.play();
                } else {
                    console.error(`El sonido con ID ${soundId} no se encontró.`);
                }
            },
            async validateAndLinkSuperid(isInternal = false) {
                if (!this.sid || this.isProcessing) return;

                const superidToValidate = this.sid.trim();

                // Verificar si ya fue escaneado
                if (this.products.some(p => p.superid === superidToValidate)) {
                    Swal.fire('Error', `El SuperID ${superidToValidate} ya fue escaneado.`, 'error');
                    this.playSound('errorSound');
                    this.sid = ''; // Limpiar el input
                    return;
                }

                this.processingQueue.push(superidToValidate); // Agregar a la cola
                this.sid = ''; // Limpiar el input inmediatamente
                this.$nextTick(() => document.getElementById('sidProduct').focus()); // Enfocar nuevamente

                if (!this.isProcessing) {
                    this.processQueue(isInternal); // Iniciar procesamiento si no hay otro activo
                }
            },
            getProductRowClass(product) {
                if (product.quantityScanned === product.quantity) {
                    return 'table-success'; // Verde para completado
                }
                return 'table-danger'; // Rojo para incompleto
            },

            async processQueue(isInternal) {
                if (this.processingQueue.length === 0) {
                    this.isProcessing = false;
                    return; // Nada que procesar
                }

                this.isProcessing = true; // Marcar como en proceso
                const superidToProcess = this.processingQueue.shift(); // Extraer el primer SuperID de la cola

                // Verificar si el SuperID ya fue procesado
                if (this.products.some(p => p.superid === superidToProcess)) {
                    Swal.fire('Error', `El SuperID ${superidToProcess} ya fue escaneado.`, 'error');
                    this.playSound('errorSound');
                    this.processQueue(isInternal); // Continuar con el siguiente
                    return;
                }

                try {
                    const response = await axios.post('/api/validate-superid/', { sid: superidToProcess });

                    if (response.data.icon === 'success') {
                        const product = this.products.find(p => p.code === response.data.sku);

                        if (product) {
                            // Validar cantidad
                            if (product.quantityScanned < product.quantity) {
                                // Realizar el descuento en Bsale
                                await axios.post('/api/dispatch-consumption/', {
                                    superid: superidToProcess,
                                    company: this.company,
                                    documentType: this.typeDocument,
                                    documentNumber: this.nDocument,
                                });

                                // Actualizar la cantidad escaneada y SuperID
                                product.quantityScanned++;
                                product.superid = superidToProcess;
                                this.playSound('successSound');
                            } else {
                                Swal.fire('Error', `Cantidad escaneada excedida para el producto ${product.name}.`, 'error');
                                this.playSound('errorSound');
                            }
                        } else {
                            Swal.fire('Error', 'Producto no encontrado para el SuperID.', 'error');
                            this.playSound('errorSound');
                        }
                    } else {
                        Swal.fire('Error', response.data.title, response.data.icon);
                        this.playSound('errorSound');
                    }
                } catch (error) {
                    this.playSound('errorSound');
                    console.error('Error al procesar SuperID:', error);
                } finally {
                    this.processQueue(isInternal); // Procesar el siguiente SuperID en la cola
                }
            },

            async dispatchConsumption(product, isInternal = false) {
                const payload = {
                    company: this.company,
                    products: [product]
                };

                if (!isInternal) {
                    payload.nDocument = this.nDocument;
                    payload.typeDocument = this.typeDocument;
                }

                try {
                    const response = await axios.post('/api/dispatch-consumption/', payload);

                    if (response.data.icon === 'success') {
                        this.alertasuccess = true;      // Mostrar mensaje de éxito
                        this.updateDispatchedProducts(product); // Actualizar la lista de productos despachados
                    } else {
                        this.alertaerror = true;           // Mostrar mensaje de error
                    }
                } catch (error) {
                    this.alertaerror = true;
                    console.error('Error al despachar:', error);
                }
            },
            updateDispatchedProducts(product) {
                // Agregar el producto despachado a una lista visible en el modal
                this.internalProducts.push({
                    superid: product.superid,
                    code: product.code,
                    description: product.description
                });
            },
            openInternalDispatchModal() {
                new bootstrap.Modal(document.getElementById('internalDispatchModal')).show();
            }
        }
    });
</script>
{% endblock js %}