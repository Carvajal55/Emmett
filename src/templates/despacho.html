{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<body class="" >
    <head>
        <meta charset="utf-8">
        <title>Despacho</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    </head>
    <body>
        <div id="app" class="container">
            <div>
                <label for="cbCompany">Compañía</label>
                <select id="cbCompany" v-model="company" class="form-select">
                    <option value="1">EMMETT</option>
                    <option value="2">SOUNDSTORE</option>
                    <option value="3">GROBEN</option>
                </select>
            </div>
            <div>
                <label for="cbTypeDocument">Tipo Documento</label>
                <select id="cbTypeDocument" v-model="typeDocument" class="form-select">
                    <option value="39">BOLETA</option>
                    <option value="33">FACTURA</option>
                    <option value="52">GUIA</option>
                </select>
            </div>
            <div>
                <label for="nDocument">N° Documento</label>
                <input id="nDocument" type="number" v-model="nDocument" @change="fetchDetails" class="form-control">
            </div>   
            <div>
                <label for="sidProduct">ID Producto</label>
                <input id="sidProduct" type="text" v-model="sid" @keyup.enter="validateAndLinkSuperid" class="form-control">
            </div>       
            {% if request.user.usuario.rol == 'ADMIN' %}
            <div>
                <button @click="generateDynamicKey" class="btn btn-warning mt-3">Generar Clave de Acceso</button>
                <p v-if="generatedKey">Clave Generada: <span>[[ generatedKey ]]</span> (Expira en 5 minutos)</p>
            </div>
            {% endif %}
            <button @click="dispatchConsumption" class="mt-3 btn btn-success">Despachar</button>
            <button @click="requestDynamicKeyAccess" class="mt-3 btn btn-primary">Despacho Interno</button>

            <!-- Modal para ingresar la clave dinámica -->
            <div class="modal fade" id="dynamicKeyModal" tabindex="-1" aria-labelledby="dynamicKeyModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="dynamicKeyModalLabel">Acceso al Despacho Interno</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" v-model="dynamicKey" placeholder="Ingrese la clave de acceso" class="form-control" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" @click="validateDynamicKey" class="btn btn-primary">Ingresar</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal para "Despacho Interno" -->
            <div class="modal fade" id="internalDispatchModal" tabindex="-1" aria-labelledby="internalDispatchModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="internalDispatchModalLabel">Despacho Interno</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Formulario para agregar un SuperID -->
                            <div class="input-group mb-3">
                                <input type="text" v-model="sid" class="form-control" @keyup.enter="validateAndLinkSuperid" placeholder="Ingrese SuperID">
                            </div>

                            <!-- Tabla de productos para despacho interno -->
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>SuperID</th>
                                        <th>Code (SKU)</th>
                                        <th>Cantidad</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(product, index) in products" :key="index">
                                        <td>[[ product.superid ]]</td>
                                        <td>[[ product.code ]]</td>
                                        <td>
                                            <input type="number" v-model="product.quantity" class="form-control" min="1">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger btn-sm" @click="removeInternalProduct(index)">Eliminar</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="button" class="btn btn-primary" @click="dispatchConsumption">Realizar Descuento</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <table class="table mt-3">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Escaneado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="product in products" :key="product.code">
                        <td>[[ product.code ]]</td>
                        <td>[[ product.description ]]</td>
                        <td>[[ product.totalAmount ]]</td>
                        <td>[[ product.quantity ]]</td>
                        <td>[[ product.count || 0 ]]</td>
                    </tr>
                </tbody>
            </table>
        </div>
</body>
{% endblock %}

{% block js %}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            dynamicKey: '',           // Clave ingresada por el usuario
            generatedKey: '',         // Clave generada
            validKey: false, 
            company: 1,
            typeDocument: 39,
            nDocument: null,
            sid: null,
            products: [],
            newProduct: { superid: '', code: '', quantity: 1 },
            internalProducts: [] // Lista de productos para despacho interno
        },
        watch: {
            typeDocument() {
                if (this.nDocument) this.fetchDetails();
            },
            company() {
                if (this.nDocument) this.fetchDetails();
            }
        },
        methods: {
            requestDynamicKeyAccess() {
                new bootstrap.Modal(document.getElementById('dynamicKeyModal')).show();
            },
            validateDynamicKey() {
                axios.post('/api/validate-dynamic-key/', { key: this.dynamicKey })
                    .then(response => {
                        if (response.data.valid) {
                            this.validKey = true;
                            new bootstrap.Modal(document.getElementById('dynamicKeyModal')).hide();
                            new bootstrap.Modal(document.getElementById('internalDispatchModal')).show();
                        } else {
                            Swal.fire('Error', 'Clave no válida o expirada.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo validar la clave.', 'error');
                        console.error(error);
                    });
            },
            generateDynamicKey() {
                axios.post('/api/generate-dynamic-key/')
                    .then(response => {
                        this.generatedKey = response.data.key;
                        // Forzar actualización
                        this.$nextTick(() => {
                            console.log("Generated Key:", this.generatedKey);
                        });
                    })
                    .catch(error => {
                        Swal.fire('Error', 'No se pudo generar la clave de acceso.', 'error');
                        console.error(error);
                    });
            },
            fetchDetails() {
                this.products = [];
                axios.get('/api/consult-bsale-document/', {
                    params: { number: this.nDocument, type: this.typeDocument }
                }).then(response => {
                    this.products = response.data.map(product => ({
                        code: product.code,
                        description: product.description,
                        totalAmount: product.totalAmount,
                        quantity: product.quantity,
                        count: 0,
                        name : product.name,
                        superid: null
                    }));
                }).catch(error => {
                    Swal.fire('Error', 'No se pudieron obtener los detalles del documento.', 'error');
                    console.error(error);
                });
            },
            validateAndLinkSuperid() {
                const superidToValidate = this.sid;
                const documentProducts = this.nDocument ? this.products.map(product => product.code) : []; 

                axios.post('/api/validate-superid/', {
                    sid: superidToValidate,
                    document_products: documentProducts
                }).then(response => {
                    if (response.data.icon === 'success') {
                        const productSku = response.data.sku;

                        if (this.nDocument) {
                            const productInList = this.products.find(product => product.code === productSku);
                            if (productInList && productInList.count < productInList.quantity) {
                                productInList.count += 1;
                                productInList.superid = this.sid;
                                this.sid = '';
                            } else {
                                Swal.fire('Advertencia', 'No se puede escanear más de la cantidad total.', 'warning');
                            }
                        } else {
                            if (!this.products.some(product => product.code === productSku)) {
                                this.products.push({
                                    superid: superidToValidate,
                                    code: productSku,
                                    quantity: 1
                                });
                                this.newProduct.superid = '';
                            } else {
                                Swal.fire('Advertencia', 'Este producto ya fue agregado.', 'warning');
                            }
                        }
                    } else {
                        Swal.fire('Error', response.data.title, response.data.icon);
                    }
                }).catch(error => {
                    Swal.fire('Error', 'Error al validar el SuperID.', 'error');
                    console.error(error);
                });
            },
            dispatchConsumption() {
                const payload = this.products.map(product => ({
                    code: product.code,
                    quantity: product.count,
                    superid: product.superid
                }));
                
                axios.post('/api/dispatch-consumption/', {
                    nDocument: this.nDocument,
                    typeDocument: this.typeDocument,
                    company: this.company,
                    products: payload
                }).then(response => {
                    if (response.data.icon === 'success') {
                        Swal.fire('Éxito', 'Productos despachados con éxito.', 'success');
                    } else {
                        Swal.fire('Error', response.data.title, response.data.icon);
                    }
                }).catch(error => {
                    Swal.fire('Error', 'Error al despachar los productos.', 'error');
                    console.error(error);
                });
            },
            openInternalDispatchModal() {
                new bootstrap.Modal(document.getElementById('internalDispatchModal')).show();
            }
        }
    });
</script>
{% endblock js %}
