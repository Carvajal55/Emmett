{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="container mt-4">
    <audio id="successSound" src="{% static 'sounds/success.mp3' %}" preload="auto"></audio>
    <audio id="errorSound" src="{% static 'sounds/error.mp3' %}" preload="auto"></audio>
    <!-- Selección de compañía -->
    <div class="mb-3">
        <label for="cbCompany">Compañía</label>
        <select id="cbCompany" v-model="company" class="form-select">
            <option value="1">EMMETT</option>
            <option value="2">SOUNDSTORE</option>
            <option value="3">GROBEN</option>
        </select>
    </div>

    <!-- Selección de tipo de documento -->
    <div class="mb-3">
        <label for="cbTypeDocument">Tipo Documento</label>
        <select id="cbTypeDocument" v-model="typeDocument" class="form-select">
            <option value="39">BOLETA</option>
            <option value="33">FACTURA</option>
            <option value="52">GUIA</option>
        </select>
    </div>

    <!-- Ingreso de número de documento -->
    <div class="mb-3">
        <label for="nDocument">N° Documento</label>
        <input id="nDocument" type="number" v-model="nDocument" @change="fetchDetails" class="form-control">
    </div>

    <!-- Ingreso de SuperID -->
    <div class="mb-3">
        <label for="sidProduct">SuperID</label>
        <input id="sidProduct" type="text" v-model="sid" @keyup.enter="validateAndLinkSuperid" class="form-control">
    </div>

    <!-- Tabla de productos -->
    <table class="table mt-4">
        <thead>
            <tr>
                <th>SuperID</th>
                <th>SKU</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Cantidad Escaneada / Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="(product, index) in products" :key="index" :class="getProductRowClass(product)">
                <td>
                    <ul>
                        <li v-for="(superid, idx) in product.superids" :key="idx">[[ superid ]]</li>
                    </ul>
                </td>
                <td>[[ product.code ]]</td>
                <td>[[ product.name ]]</td>
                <td>[[ product.description ]]</td>
                <td>[[ product.quantityScanned ]] / [[ product.quantity ]]</td>
                <td>
                    <button class="btn btn-warning btn-sm" @click="forceComplete(index)">
                        Forzar Completo
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Botón para completar el despacho -->
    <div class="mt-4">
        <button class="btn btn-success" @click="completeDispatch" :disabled="!allProductsComplete">
            Marcar Documento como Despachado
        </button>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            company: 1,
            typeDocument: 39,
            nDocument: null,
            sid: '',
            products: [],
            dispatchReady: false, // Control para evitar disparo automático de completeDispatch
        },
        computed: {
            allProductsComplete() {
                // Verifica si todos los productos están completos (escaneados o forzados)
                return this.products.every(product => product.is_complete);
            }
        },
        watch: {
            allProductsComplete(value) {
                if (value && this.dispatchReady) {
                    this.completeDispatch();
                }
            },
        },
        methods: {
            validateAndLinkSuperid() {
                if (!this.sid) return;

                const superid = this.sid.trim();
                this.sid = ''; // Limpiar el input

                axios.post('/api/validate-superid/', {
                    sid: superid,
                    document_products: this.products.map(product => product.code) // Lista de SKUs del documento
                }).then(response => {
                    if (response.data.icon === 'success') {
                        const sku = response.data.sku;

                        // Buscar el producto asociado en la lista de productos del documento
                        const product = this.products.find(product => product.code === sku);

                        if (product) {
                            if (!product.superids.includes(superid)) {
                                product.superids.push(superid);
                                product.quantityScanned++;
                                this.playSound('successSound'); // Sonido de éxito
                            } else {
                                Swal.fire('Error', 'El SuperID ya está vinculado a este producto.', 'error');
                            }
                        } else {
                            Swal.fire('Error', 'Producto no encontrado en la lista del documento.', 'error');
                        }
                    } else {
                        this.playSound('errorSound'); // Sonido de error
                        Swal.fire('Error', response.data.error || 'Error al validar el SuperID.', 'error');
                    }
                }).catch(error => {
                    console.error('Error al validar el SuperID:', error);
                    this.playSound('errorSound');
                    Swal.fire('Error', 'No se pudo validar el SuperID.', 'error');
                });
            },
            fetchProductDetails(sku) {
                return axios.get('/api/fetch-product-details/', { params: { sku } })
                    .then(response => response.data)
                    .catch(error => {
                        console.error(`Error al obtener detalles del producto para SKU ${sku}:`, error);
                        return { name: 'Desconocido', description: 'Desconocido' };
                    });
            },

            fetchDetails() {
                this.products = [];
                this.dispatchReady = false; // Resetea al cargar nuevos productos
                axios.get('/api/fetch-invoice-products/', {
                    params: { number: this.nDocument, type: this.typeDocument }
                }).then(async response => {
                    console.log('Productos obtenidos del modelo:', response.data.products);

                    // Mapear productos y obtener detalles adicionales
                    this.products = await Promise.all(response.data.products.map(async product => {
                        const details = await this.fetchProductDetails(product.code);
                        return {
                            code: product.code,
                            name: details.name,
                            description: details.description,
                            quantity: product.total_quantity,
                            quantityScanned: product.dispatched_quantity,
                            superids: [], // Si tienes superids relacionados
                            is_complete: product.is_complete,
                        };
                    }));

                    console.log('Productos procesados:', this.products); // Depuración

                    // Habilitar despacho solo después de cargar los productos
                    this.dispatchReady = true;
                }).catch(error => {
                    Swal.fire('Error', 'No se pudieron obtener los detalles del documento.', 'error');
                    console.error('Error al obtener productos:', error);
                });
            },

            async validateSuperid(superid) {
                try {
                    const skuList = this.products.map(product => product.code); // Lista de SKUs del frontend

                    console.log('Payload enviado al backend:', { superid, sku_list: skuList });

                    const validateResponse = await axios.post('/api/validate-superid/', { superid, sku_list: skuList });
                    if (validateResponse.status !== 200) {
                        this.playSound('error');
                        Swal.fire('Error', validateResponse.data.error || 'Error al validar el SuperID.', 'error');
                        return;
                    }

                    const { sku } = validateResponse.data;

                    // Buscar el producto en la lista de productos del frontend
                    const product = this.products.find(product => product.code === sku);

                    if (!product) {
                        this.playSound('error');
                        Swal.fire('Error', 'El SKU del SuperID no está en la lista de productos.', 'error');
                        return;
                    }

                    // Verificar que el SuperID no haya sido agregado previamente
                    if (product.superids.includes(superid)) {
                        this.playSound('error');
                        Swal.fire('Error', 'El SuperID ya ha sido agregado.', 'error');
                        return;
                    }

                    // Asociar el SuperID al producto
                    product.superids.push(superid);
                    product.quantityScanned++;

                    // Marcar el producto como completo si se ha escaneado la cantidad necesaria
                    if (product.quantityScanned >= product.quantity) {
                        product.is_complete = true;
                    }

                    // Realizar el despacho
                    this.dispatchSuperid(superid, sku);
                } catch (error) {
                    console.error('Error al validar el SuperID:', error);
                    this.playSound('error');
                    Swal.fire('Error', 'No se pudo validar el SuperID.', 'error');
                }
            },


            async dispatchSuperid(superid, sku) {
                const payload = {
                    nDocument: this.nDocument,
                    typeDocument: this.typeDocument,
                    company: this.company,
                    products: [{ superid, sku }]
                };

                try {
                    const response = await axios.post('/api/dispatch-consumption/', payload);
                    if (response.data.icon === 'success') {
                        this.playSound('success');
                        Swal.fire('Éxito', `SuperID ${superid} despachado correctamente.`, 'success');
                    } else {
                        this.playSound('error');
                        Swal.fire('Error', response.data.message || 'Error al despachar.', 'error');
                    }
                } catch (error) {
                    console.error('Error al despachar:', error);
                    this.playSound('error');
                    Swal.fire('Error', 'No se pudo procesar el despacho.', 'error');
                }
            },
            
            async forceComplete(index) {
                const product = this.products[index];
                product.quantityScanned = product.quantity;
                product.is_complete = true;

                // Actualizar el estado del producto en el backend
                try {
                    const response = await axios.post('/api/force-complete-product/', {
                        nDocument: this.nDocument,
                        typeDocument: this.typeDocument,
                        sku: product.code,
                    });

                    if (response.data.icon === 'success') {
                        this.playSound('success');
                        Swal.fire('Éxito', `Producto ${product.code} marcado como completo.`, 'success');
                    } else {
                        this.playSound('error');
                        Swal.fire('Error', response.data.message || 'Error al marcar como completo.', 'error');
                    }
                } catch (error) {
                    console.error('Error al forzar el producto:', error);
                    this.playSound('error');
                    Swal.fire('Error', 'No se pudo marcar el producto como completo.', 'error');
                }
            },

            async completeDispatch() {
                try {
                    const response = await axios.post('/api/complete-dispatch/', {
                        nDocument: this.nDocument,
                        typeDocument: this.typeDocument
                    });

                    if (response.data.icon === 'success') {
                        this.playSound('success');
                        Swal.fire('Éxito', 'El documento fue marcado como despachado.', 'success');
                    } else {
                        this.playSound('error');
                        Swal.fire('Error', response.data.message || 'Error al completar el despacho.', 'error');
                    }
                } catch (error) {
                    console.error('Error al completar el despacho:', error);
                    this.playSound('error');
                    Swal.fire('Error', 'No se pudo completar el despacho.', 'error');
                }
            },
            playSound(type) {
                const audioElement = type === 'success' ? document.getElementById('successSound') : document.getElementById('errorSound');
                audioElement.currentTime = 0;
                audioElement.play();
            },

            getProductRowClass(product) {
                return product.quantityScanned === product.quantity ? 'table-success' : 'table-danger';
            },
        },
    });
</script>
{% endblock js %}
