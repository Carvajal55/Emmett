{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="m-2">
    <h3>Aprobación de Factura</h3>

    <!-- Aquí mostraremos los datos de la factura -->
    <div v-if="factura" class="container">
        <div class="row">
            <!-- Columna 1 -->
            <div class="col-md-4">
                <p><strong>Forma de Pago:</strong> [[ factura.headers.typePay ]]</p>
                <p><strong>Número de Cheque:</strong> [[ factura.headers.nCheque ]]</p>
                <p><strong>Fecha Pago Documento:</strong> [[ factura.headers.dateExpired || 'N/A' ]]</p>
                <p><strong>Ingresado Por:</strong> [[ factura.headers.userProcess ]]</p>
                <p><strong>Estado Resumen:</strong> OK</p>
                <p><strong>PDF:</strong> <a :href="`/media/${factura.headers.urlImg}`" target="_blank">Ver PDF</a></p>

            </div>

            <!-- Columna 2 -->
            <div class="col-md-4">
                <p><strong>Tipo de Documento:</strong> [[ factura.headers.typeDocument ]]</p>
                <p><strong>Folio:</strong> [[ factura.headers.nDocument ]]</p>
                <p><strong>Proveedor:</strong> [[ factura.headers.supplierName ]]</p>
                <p><strong>Observación:</strong> [[ factura.headers.observation || 'Sin observaciones' ]]</p>
                
                <!-- Botones para aprobar o rechazar -->
                <div>
                    <button class="btn btn-success" @click="aprobarFactura()">Aprobar</button>
                    <button class="btn btn-danger" @click="confirmarRechazarFactura()">Rechazar</button>
                </div>
            </div>

            <!-- Columna 3 -->
            <div class="col-md-4">
                <p><strong>Fecha de Emisión:</strong> [[ factura.headers.datePurchase ]]</p>
                <p><strong>Fecha Recepción:</strong> [[ factura.headers.dateReception ]]</p>
                <p><strong>Descuento Documento:</strong> [[ factura.headers.dcto || '0' ]]</p>
                <p><strong>Valor Neto:</strong> [[ formatCurrency(factura.headers.subtotalNeto) ]]</p>
                <p><strong>Total IVA Incluido:</strong> [[ formatCurrency(factura.headers.subtotalBruto) ]]</p>
            </div>
        </div>
    </div>
   <!-- Modal -->
   <div class="modal fade" id="modalPrecios" tabindex="-1" role="dialog" aria-labelledby="modalPreciosLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPreciosLabel">Actualizar Listas de Precios para SKU: [[ skuSeleccionado ]]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div v-for="(precio, index) in listasPrecios" :key="index" class="form-group">
                    <label :for="'precio-' + precio.id">[[ precio.label ]]</label>
                    <input
                        type="number"
                        class="form-control"
                        v-model="precio.valor"
                        @input="recalcularMargen(precio)"
                        :id="'precio-' + precio.id"
                        placeholder="Ingrese precio"
                    />
                    <p><strong>Margen:</strong> [[ precio.margen || 0 ]]%</p>
                    <button class="btn btn-primary mt-2" @click="actualizarListaPrecio(detalleSeleccionado, precio.id, precio.valor)">
                        Guardar para [[ precio.label ]]
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

    <!-- Detalles de la factura -->
    <table v-if="detalles.length > 0" class="table table-striped">
        <thead>
            <tr>
                <th>#</th>
                <th>SKU</th>
                <th>PRODUCTO</th>
                <th>QTY</th>
                <th>DCTO</th>
                <th>COSTO REAL</th>
                <th>COSTO </th>
                <th>Ú.COSTO</th>
                <th>Ú.PRECIO</th>
                <th>PRECIO BSALE</th> <!-- Nueva columna -->
                <th>TOTAL</th>
                <th>PRECIO BASE</th>
                <th>MARGEN</th>
                <th>STOCK</th>
                <th>Accion</th>
                <button class="btn btn-primary mb-3" @click="actualizarPreciosBaseMasivo">
                    Actualizar Todos los Precios Base
                </button>
            </tr>
        </thead>
        <tbody>
            <tr v-for="(detalle, index) in detalles" :key="detalle.sku" style="font-size: 0.9rem;">
                <td>[[ index + 1 ]]</td>
                <td>[[ detalle.sku ]]</td>
                <td>[[ detalle.model ]]</td>
                <td>[[ detalle.qty ]]</td>
                <td>[[ detalle.dctoItem ]] %</td>
                <td>[[ formatCurrency(detalle.cost_with_discount) ]]</td>
                <td>[[ formatCurrency(detalle.cost) ]]</td>
                <td>[[ formatCurrency(detalle.lastCost || 0) ]]</td>
                <td>[[ formatCurrency(detalle.lastPrice || 0) ]]</td>
                <td>[[ formatCurrency(detalle.bsalePrice || 0) ]]</td>
                <td>[[ formatCurrency(calcularTotal(detalle.cost_with_discount, detalle.qty)) ]]</td>
                <td style="width: 300px;">
                    <input
                        type="number"
                        class="form-control"
                        v-model="detalle.precioBase"
                        placeholder="Precio Base"
                        @input="calcularMargen(detalle)" 
                        style="font-size: 0.9rem;" 
                    />
                </td>
                <td>[[ detalle.margen ]]%</td>
                <td>[[ detalle.totalStock ]]</td>
                <td>
                    <button
                        class="btn btn-info"
                        style="font-size: 0.9rem;" 
                        @click="abrirModal(detalle)"
                    >
                       Precios MarketPlace
                    </button>
                </td>
                <td>
                    <button
                        class="btn btn-primary"
                        style="font-size: 0.9rem;"
                        @click="actualizarPrecioBase(detalle)"
                    >
                        Precio Base
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    

    <!-- Mostrar un mensaje si no hay detalles -->
    <p v-if="detalles.length === 0 && factura">No hay detalles para esta factura.</p>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  <!-- SweetAlert -->

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],  // Evitar conflictos con las etiquetas de Django
        data: {
            factura: null,  // Datos de la factura
            detalles: [],   // Detalles de la factura
            errorMsg: '',    // Mensaje de error
            idFactura: null,
            listasPrecios: [
                { label: 'Falabella', id: 11, valor: null, margen: null }, // Lista para Falabella
                { label: 'Líder', id: 14, valor: null, margen: null }      // Lista para Líder
            ], // ID de la factura guardado
            detalleSeleccionado: null,
            skuSeleccionado: null, // SKU del producto seleccionado
            stockProductos: {}
        },
        mounted() {
            console.log("Componente montado"); // Verificar que el mounted se ejecuta

            this.idFactura = this.getFacturaIdFromURL(); // Guardar el ID de la URL en la variable de Vue
            if (this.idFactura) {
                this.obtenerFactura(); // Llamar a la API con el ID de la factura
            } else {
                console.error("No se pudo obtener el ID de la factura desde la URL");
            }

            
        },
        methods: {
            actualizarListaPrecio(detalle, type, bPrice) {
                if (!bPrice) {
                    alert('Por favor ingresa un precio.');
                    return;
                }

                const data = {
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    type: type, // ID de la lista
                    bPrice: bPrice
                };

                console.log("Actualizando lista de precios:", data);

                axios.post('/api/actualizar_precio/', data)
                    .then(response => {
                        console.log(`Precio para lista ${type} actualizado correctamente:`, response.data);
                        Swal.fire({
                            title: 'Éxito',
                            text: `El precio para la lista ${type} se actualizó correctamente.`,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error(`Error al actualizar el precio para la lista ${type}:`, error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar el precio.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            actualizarPrecioBase(detalle) {
                if (!detalle.precioBase) {
                    alert('Por favor ingresa un precio base.');
                    return;
                }

                const data = {
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    type: 3, // Lista base Bsale Emmett DEV
                    //type: 2, //Lista base SOundstore
                    bPrice: detalle.precioBase
                };

                console.log("Actualizando precio base:", data);

                axios.post('/api/actualizar_precio/', data)
                    .then(response => {
                        console.log('Precio base actualizado correctamente:', response.data);
                        Swal.fire({
                            title: 'Éxito',
                            text: 'El precio base se actualizó correctamente.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error al actualizar el precio base:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar el precio base.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            abrirModal(detalle) {
                this.skuSeleccionado = detalle.sku;
                this.detalleSeleccionado = detalle;
                $('#modalPrecios').modal('show');
            },
            actualizarListasPrecios() {
                console.log("Actualizando listas de precios para SKU:", this.skuSeleccionado);
                console.log("Nuevos precios:", this.listasPrecios);

                // Enviar la solicitud al backend con el SKU y las listas de precios
                axios.post('/api/actualizar_listas_precios/', {
                    sku: this.skuSeleccionado,
                    precios: this.listasPrecios
                })
                .then(response => {
                    console.log("Listas de precios actualizadas:", response.data);
                    Swal.fire({
                        title: 'Éxito',
                        text: 'Las listas de precios se actualizaron correctamente.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    $('#modalPrecios').modal('hide'); // Cerrar el modal
                })
                .catch(error => {
                    console.error("Error al actualizar las listas de precios:", error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un problema al actualizar las listas de precios.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            },
            obtenerDatosProducto(detalle) {
                console.log("Obteniendo datos para SKU:", detalle.sku); // Log para verificar el SKU

                let formData = new FormData();
                formData.append("sku", detalle.sku);
                formData.append("price_list_id", 3); // Enviar la lista de precios fija (3)

                axios.post("/api/obtener_datos_producto/", formData)
                    .then(response => {
                        console.log("Datos del producto obtenidos:", response.data); // Verifica la respuesta completa

                        // Usa this.$set para garantizar reactividad
                        this.$set(detalle, "lastCost", parseFloat(response.data.lastCost) || 0);
                        this.$set(detalle, "totalStock", parseFloat(response.data.totalStock) || 0);
                        this.$set(detalle, "lastPrice", parseFloat(response.data.lastPrice) || 0);
                        this.$set(detalle, "bsalePrice", response.data.bsalePrice || "No disponible");
                        this.$set(detalle, "precioBase", parseFloat(response.data.bsalePrice) || 0);
                        this.$set(detalle, "iderp",response.data.iderp || "No disponible");
                         // Asegura que sea 0 si no es válido
 // Asegura que sea un número válido

                        // Solo llama a calcularMargen si los datos son válidos
                        if (detalle.cost && detalle.precioBase) {
                            this.calcularMargen(detalle);
                        } else {
                            console.warn(`No se puede calcular margen: faltan datos para el detalle con SKU ${detalle.sku}`);
                        }

                        console.log("Detalle actualizado con margen:", detalle); // Verifica los valores asignados
                    })
                    .catch(error => {
                        console.error("Error al obtener datos del producto:", error);

                        // Valores predeterminados en caso de error
                        this.$set(detalle, "lastCost", 0);
                        this.$set(detalle, "totalStock", 0);
                        this.$set(detalle, "lastPrice", 0);
                        this.$set(detalle, "bsalePrice", "No disponible");
                        this.$set(detalle, "precioBase", 0); // Precio base predeterminado
                        this.$set(detalle, "margen", 0); // Margen predeterminado
                    });
            },
            formatCurrency(value) {
                if (!value || isNaN(value)) {
                    return "0";
                }
                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(value);
            },
            recalcularMargen(precio) {
                const costoNeto = this.detalleSeleccionado.cost; // Usar el costo del detalle seleccionado
                const precioBaseNeto = precio.valor / 1.19; // El Precio Base sin IVA

                if (precioBaseNeto > 0) {
                    const margen = (1 - (costoNeto / precioBaseNeto)) * 100; // Fórmula del margen
                    precio.margen = margen.toFixed(2); // Redondear a 2 decimales
                } else {
                    precio.margen = 0; // Si el Precio Base Neto es 0, el margen también lo es
                }
            },
            // Función para calcular el costo con descuento
            calcularCostoConDescuento(cost, dctoItem) {
                const descuento = cost * (dctoItem / 100);
                return cost - descuento;
            },
            // Función para calcular el total (cost * qty)
            calcularTotal(cost, qty) {
                return cost * qty;
            },
            // Función para calcular el margen basado en el precio base
            calcularMargen(detalle) {
                // Verifica que los valores sean números válidos
                const costoNeto = parseFloat(detalle.cost_with_discount) || 0; 
                const precioBaseNeto = (parseFloat(detalle.precioBase) || 0) / 1.19; // Precio base sin IVA

                if (precioBaseNeto > 0) {
                    const margen = ((precioBaseNeto - costoNeto) / precioBaseNeto) * 100; // Fórmula del margen
                    detalle.margen = margen.toFixed(2); // Redondea a 2 decimales

                    // Imprime los valores utilizados en la ecuación
                    console.log(`Cálculo del margen para SKU ${detalle.sku}:`);
                    console.log(`Costo Neto: ${costoNeto}, Precio Base Neto: ${precioBaseNeto}`);
                    console.log(`Margen calculado: ${margen}%`);
                } else {
                    detalle.margen = 0; // Si el precio base neto es 0, el margen también lo es

                    // Imprime un mensaje si no es posible calcular el margen
                    console.log(`No se puede calcular el margen para SKU ${detalle.sku}: Precio Base Neto es 0.`);
                }
            },
            // Función para obtener los detalles de la factura
            obtenerFactura() {
                console.log("Obteniendo factura con ID:", this.idFactura);

                let formData = new FormData();
                formData.append("id", this.idFactura);

                axios.post("/api/obtener_factura/", formData)
                    .then(response => {
                        this.factura = response.data; // Asignar los datos de la factura
                        this.detalles = response.data.details.map(detalle => ({
                            ...detalle,
                            precioBase: detalle.bsalePrice || '000' // Precargar el precio base con el valor de bsalePrice
                        }));
                        console.log("Datos de la factura:", response.data);

                        // Llamar a obtenerDatosProducto para cada detalle
                        this.detalles.forEach(detalle => {
                            this.obtenerDatosProducto(detalle);
                        });
                    })
                    .catch(error => {
                        console.error("Error al obtener la factura:", error);
                        this.errorMsg = "Hubo un problema al obtener los detalles de la factura.";
                    });
            },
            // Función para rechazar la factura con confirmación
            confirmarRechazarFactura() {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Esta acción no se puede deshacer",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, rechazar',
                    cancelButtonText: 'No, cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.rechazarFactura();  // Llamar a la función que rechaza la factura
                    }
                });
            },
            // Función para rechazar la factura
            rechazarFactura() {
                let formData = new FormData();
                formData.append('id', this.idFactura);

                axios.post('/api/rechazar-factura/', formData)
                    .then(response => {
                        console.log(response.data.message);
                        Swal.fire({
                            title: 'Factura Rechazada',
                            text: 'La factura ha sido rechazada con éxito.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '/recepciones_pendientes/';  // Redirigir a la página indicada
                        });
                    })
                    .catch(error => {
                        console.error('Error al rechazar la factura:', error);
                    });
            },
            // Función para aprobar la factura
            aprobarFactura() {
                const detalles = this.detalles.map(detalle => ({
                    sku: detalle.sku,
                    cost: detalle.cost
                }));

                const data = {
                    factura_id: this.idFactura, // Incluye el ID de la factura
                    detalles: detalles          // Detalles de la factura
                };

                axios.post('/api/aprobar-factura/', data)
                    .then(response => {
                        console.log(response.data.message);
                        console.log('Productos actualizados:', response.data.productos_actualizados);
                        console.log('Productos no encontrados:', response.data.productos_no_encontrados);

                        Swal.fire({
                            title: 'Factura Aprobada',
                            text: 'La factura ha sido aprobada con éxito.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '/recepciones_pendientes/';  // Redirigir a la página indicada
                        });
                    })
                    .catch(error => {
                        console.error('Error al aprobar la factura:', error);
                    });
            },
            // Función para extraer el ID de la factura desde la URL
            getFacturaIdFromURL() {
                const urlParts = window.location.pathname.split('/');
                const idFactura = urlParts[urlParts.length - 2];  // El ID de la factura está en la penúltima parte de la URL
                return idFactura;
            },
            actualizarPreciosBaseMasivo() {
                // Validar si hay detalles en la lista
                if (this.detalles.length === 0) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay productos en la lista para actualizar.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // Preparar los datos para enviar al backend
                const data = this.detalles.map(detalle => {
                    if (!detalle.precioBase) {
                        console.warn(`El producto con SKU ${detalle.sku} no tiene precio base.`);
                    }
                    return {
                        iderp: detalle.iderp,
                        sku: detalle.sku,
                        type: 3, // Lista base Bsale Emmett DEV
                        bPrice: detalle.precioBase || 0 // Asegurar que siempre haya un valor
                    };
                });

                // Enviar solicitud al backend
                axios.post('/api/actualizar_precio_masivo/', { detalles: data })
                    .then(response => {
                        console.log('Precios base actualizados correctamente:', response.data);
                        Swal.fire({
                            title: 'Éxito',
                            text: 'Todos los precios base se actualizaron correctamente.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error al actualizar los precios base masivamente:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar los precios base.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            }

        },
        mounted() {
            console.log("Componente montado");  // Verificar que el mounted se ejecuta

            this.idFactura = this.getFacturaIdFromURL();  // Guardar el ID de la URL en la variable de Vue
            if (this.idFactura) {
                this.obtenerFactura();  // Llamar a la API con el ID de la factura
            } else {
                console.error("No se pudo obtener el ID de la factura desde la URL");
            }
        }
    });
</script>
{% endblock js %}
