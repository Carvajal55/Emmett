{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="m-2">
    <h3>Aprobación de Factura</h3>

    <!-- Aquí mostraremos los datos de la factura -->
    <div v-if="factura" class="container">
        <div class="row">
            <!-- Columna 1 -->
            <div class="col-md-4">
                <p><strong>Forma de Pago:</strong> [[ factura.headers.typePay ]]</p>
                <p><strong>Número de Cheque:</strong> [[ factura.headers.nCheque ]]</p>
                <p><strong>Fecha Pago Documento:</strong> [[ factura.headers.dateExpired || 'N/A' ]]</p>
                <p><strong>Ingresado Por:</strong> [[ factura.headers.userProcess ]]</p>
                <p><strong>Estado Resumen:</strong> OK</p>
                <p><strong>PDF:</strong> <a :href="`/media/${factura.headers.urlImg}`" target="_blank">Ver PDF</a></p>
            

            </div>

            <!-- Columna 2 -->
            <div class="col-md-4">
                <p><strong>Tipo de Documento:</strong> [[ factura.headers.typeDocument ]]</p>
                <p><strong>Folio:</strong> [[ factura.headers.nDocument ]]</p>
                <p><strong>Proveedor:</strong> [[ factura.headers.supplierName ]]</p>
                <p><strong>Observación:</strong> [[ factura.headers.observation || 'Sin observaciones' ]]</p>
                
                <!-- Botones para aprobar o rechazar -->
                <div>
                    <button class="btn btn-success" @click="aprobarFactura()">Aprobar</button>
                    <button class="btn btn-danger" @click="confirmarRechazarFactura()">Rechazar</button>
                </div>
            </div>

            <!-- Columna 3 -->
            <div class="col-md-4">
                <p><strong>Fecha de Emisión:</strong> [[ factura.headers.datePurchase ]]</p>
                <p><strong>Fecha Recepción:</strong> [[ factura.headers.dateReception ]]</p>
                <p><strong>Descuento Documento:</strong> [[ factura.headers.dcto || '0' ]]</p>
                <p><strong>Valor Neto:</strong> [[ formatCurrency(factura.headers.subtotalNeto) ]]</p>
                <p><strong>Total IVA Incluido:</strong> [[ formatCurrency(factura.headers.subtotalBruto) ]]</p>
            </div>
        </div>
    </div>
    <div class="col-12  mt-4">
        <button class="btn btn-primary" @click="actualizarPreciosBaseMasivo">
            Actualizar Todos los Precios Base
        </button>
    </div>
   <!-- Modal -->
   <div class="modal fade" id="modalPrecios" tabindex="-1" role="dialog" aria-labelledby="modalPreciosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl custom-modal-width" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h4 class="modal-title" id="modalPreciosLabel" style="font-size: 1.5rem; font-weight: bold;">
                        Actualizar Listas de Precios para SKU: [[ skuSeleccionado ]]
                    </h4>
                    <p style="font-size: 1.2rem; font-weight: bold;">
                        Nombre: [[ nombreSeleccionado ]]
                    </p>
                    <p style="font-size: 1.2rem; font-weight: bold;">
                        Precio Base Bsale: [[ precioSeleccionado ]]
                    </p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div v-for="(precio, index) in listasPrecios" :key="index" class="col-md-6 mb-3" style="padding: 10px;">
                        <div class="form-group">
                            <!-- Mostrar el label con el Valor Sugerido -->
                            <label :for="'precio-' + precio.id" style="font-weight: bold; margin-bottom: 5px; display: block;">
                                [[ precio.label ]]
                            </label>
            
                            <!-- Mostrar el Valor Sugerido -->
                            <p style="margin-top: 5px; font-size: 0.9rem; color: gray;">
                                Valor Sugerido: [[ precio.valorSugerido || 'Pendiente' ]] CLP
                            </p>
                            <p style="margin-top: 5px; font-size: 0.9rem; color: gray;">
                                Valor Actual: [[ precio.valorActual || 'Pendiente' ]] CLP
                            </p>
            
                            <!-- Input para ingresar el valor -->
                            <input
                                type="number"
                                class="form-control"
                                v-model.number="precio.valor"
                                @input="recalcularMargen(precio)"
                                :id="'precio-' + precio.id"
                                placeholder="Ingrese precio"
                                style="margin-bottom: 10px;"
                            />
            
                            <!-- Mostrar el margen calculado -->
                            <p style="margin-top: 10px; font-size: 1rem;">
                                <strong>Margen:</strong> [[ precio.margen || 0 ]]%
                            </p>
            
                            <div class="row">
                                <div class="col-4">
                                    <label for="fee" style="font-size: 0.8rem; font-weight: bold;">Comisión (Fee)</label>
                                    <input
                                        type="number"
                                        class="form-control form-control-sm"
                                        v-model.number="precio.fee"
                                        @input="recalcularMargen(precio)"
                                        id="fee"
                                        placeholder="Ej: 1.25"
                                    />
                                </div>
                            
                                <div class="col-4">
                                    <label for="n" style="font-size: 0.8rem; font-weight: bold;">Margen (N)</label>
                                    <input
                                        type="number"
                                        class="form-control form-control-sm"
                                        v-model.number="precio.n"
                                        @input="recalcularMargen(precio)"
                                        id="n"
                                        placeholder="Ej: 1.35"
                                    />
                                </div>
                            
                                <div class="col-4">
                                    <label for="despacho" style="font-size: 0.8rem; font-weight: bold;">Despacho (CLP)</label>
                                    <input
                                        type="number"
                                        class="form-control form-control-sm"
                                        v-model.number="precio.despacho"
                                        @input="recalcularMargen(precio)"
                                        id="despacho"
                                        placeholder="Ej: 4990"
                                    />
                                </div>
                            </div>
            
                            <!-- Botón para guardar -->
                            <button
                                class="btn btn-primary mt-2 w-100"
                                @click="actualizarListaPrecio(detalleSeleccionado, precio.id, precio.valor)"
                                :style="getButtonStyle(precio.label)"
                            >
                                Guardar para [[ precio.label ]]
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                    style="padding: 10px 20px; font-size: 1rem;"
                >
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>



    <!-- Detalles de la factura -->
    <table v-if="detalles.length > 0" class="table table-striped">
        <thead>
            <tr>
                <th style="width: 3%;">#</th>
                <th style="width: 8%;">SKU</th>
                <th style="width: 15%;">PRODUCTO</th>
                <th style="width: 5%; text-align: center;">QTY</th>
                <th style="width: 5%; text-align: center;">DCTO</th>
                <th style="width: 10%; text-align: right;">COSTO REAL</th>
                <th style="width: 10%; text-align: right;">COSTO</th>
                <th style="width: 8%; text-align: right;">Ú.COSTO</th>
                <th style="width: 8%; text-align: right;">Ú.PRECIO</th>
                <th style="width: 10%; text-align: right;">PRECIO BSALE</th>
                <th style="width: 10%; text-align: right;">TOTAL</th>
                <th style="width: 18%;">PRECIO BASE</th>
                <th style="width: 5%; text-align: center;">MARGEN</th>
                <th style="width: 5%; text-align: center;">STOCK</th>
                <th style="width: 10%;">ACCIÓN</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="(detalle, index) in detalles" :key="detalle.sku" style="font-size: 0.9rem;">
                <td>[[ index + 1 ]]</td>
                <td>[[ detalle.sku ]]</td>
                <td>[[ detalle.model ]]</td>
                <td style="text-align: center;">[[ detalle.qty ]]</td>
                <td style="text-align: center;">[[ detalle.dctoItem ]] %</td>
                <td style="text-align: right;">[[ formatCurrency(detalle.cost_with_discount) ]]</td>
                <td style="text-align: right;">[[ formatCurrency(detalle.cost) ]]</td>
                <td style="text-align: right;">[[ formatCurrency(detalle.lastCost || 0) ]]</td>
                <td style="text-align: right;">[[ formatCurrency(detalle.lastPrice || 0) ]]</td>
                <td style="text-align: right;">[[ formatCurrency(detalle.bsalePrice || 0) ]]</td>
                <td style="text-align: right;">[[ formatCurrency(calcularTotal(detalle.cost_with_discount, detalle.qty)) ]]</td>
                <td>
                    <input
                        type="number"
                        class="form-control px-0"
                        v-model="detalle.precioBase"
                        placeholder="Precio Base"
                        @input="calcularMargen(detalle)" 
                        style="font-size: 0.9rem; width: 100%;" 
                    />
                </td>
                <td style="text-align: center;">[[ detalle.margen ]]%</td>
                <td style="text-align: center;">[[ detalle.totalStock ]]</td>
                <td>
                    <button
                        class="btn btn-info btn-sm"
                        style="font-size: 0.9rem;" 
                        @click="abrirModal(detalle)"
                    >
                       P.MarketPlace
                    </button>
                    <button
                        class="btn btn-primary btn-sm mt-1"
                        style="font-size: 0.9rem;"
                        @click="actualizarPrecioBase(detalle)"
                    >
                        P.Base
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    

    <!-- Mostrar un mensaje si no hay detalles -->
    <p v-if="detalles.length === 0 && factura">No hay detalles para esta factura.</p>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  <!-- SweetAlert -->

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],  // Evitar conflictos con las etiquetas de Django
        data: {
            factura: null,  // Datos de la factura
            detalles: [],   // Detalles de la factura
            errorMsg: '',    // Mensaje de error
            idFactura: null,
            listasPrecios: [
                { label: 'MercadoLibre', id: 10, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 4900, margen: null, valor: null, valorSugerido: null },
                { label: 'Paris', id: 12,  fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null },
                { label: 'Ripley', id: 13, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null },
                { label: 'Walmart', id: 14, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null },
                
            ],
            detalleSeleccionado: null,
            skuSeleccionado: null, // SKU del producto seleccionado
            precioSeleccionado: null,
            nombreSeleccionado: null,
            stockProductos: {}
        },
        mounted() {
            console.log("Componente montado"); // Verificar que el mounted se ejecuta

            this.idFactura = this.getFacturaIdFromURL(); // Guardar el ID de la URL en la variable de Vue
            if (this.idFactura) {
                this.obtenerFactura(); // Llamar a la API con el ID de la factura
            } else {
                console.error("No se pudo obtener el ID de la factura desde la URL");
            }
            this.recalcularTodos();

            
        },
        methods: {
            obtenerValorActual(precio) {
                const data = {
                    price_list_id: precio.id, // ID de la lista de precios
                    sku: this.skuSeleccionado // SKU seleccionado
                };

                axios.post('/api/obtener_valor_actual/', data)
                    .then(response => {
                        const valorRecibido = response.data.valor_actual;
                        precio.valorActual = valorRecibido ? Math.floor(valorRecibido) : 'No disponible';
                    })
                    .catch(error => {
                        console.error('Error al obtener el valor actual:', error);
                        precio.valorActual = 'Error';
                    });
            },
            initializeListasPrecios(detalle) {
                return [
                    { label: 'MercadoLibre', id: 10, fee: 1.25, iva: 1.19, n: 1.35, despacho: 4900, costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null },
                    { label: 'Paris', id: 12, fee: 1.25, iva: 1.19, n: 1.35, despacho: 0, costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null },
                    { label: 'Ripley', id: 13, fee: 1.25, iva: 1.19, n: 1.35, despacho: 0, costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null },
                    { label: 'Walmart', id: 14, fee: 1.25, iva: 1.19, n: 1.35, despacho: 0, costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null },
                    { label: 'Falabella', id: 11, fee: 1.25, iva: 1.19, n: 1.35, despacho: 0, costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null }

                ];
            },
            recalcularTodos() {
                this.listasPrecios.forEach(precio => {
                    this.recalcularMargen(precio);
                });
            },
            getButtonStyle(label) {
                switch (label) {
                    case 'MercadoLibre':
                        return 'background-color: #ffdd00; color: black; width: 100%;';
                    case 'Paris':
                        return 'background-color: #0056b3; color: white; width: 100%;';
                    case 'Falabella':
                        return 'background-color: #76b900; color: white; width: 100%;';
                    case 'Ripley':
                        return 'background-color: #4b0082; color: white; width: 100%;';
                    case 'Walmart':
                        return 'background-color: #0071ce; color: white; width: 100%;';
                    default:
                        return 'background-color: #6c757d; color: white; width: 100%;';
                }
            },
            actualizarListaPrecio(detalle, type, bPrice) {
                if (!bPrice) {
                    alert('Por favor ingresa un precio.');
                    return;
                }

                const data = {
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    type: type, // ID de la lista
                    bPrice: bPrice
                };

                console.log("Actualizando lista de precios:", data);

                axios.post('/api/actualizar_precio/', data)
                    .then(response => {
                        console.log(`Precio para lista ${type} actualizado correctamente:`, response.data);
                        Swal.fire({
                            title: 'Éxito',
                            text: `El precio para la lista ${type} se actualizó correctamente.`,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error(`Error al actualizar el precio para la lista ${type}:`, error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar el precio.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            actualizarPrecioBase(detalle) {
                if (!detalle.precioBase) {
                    alert('Por favor ingresa un precio base.');
                    return;
                }

                const data = {
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    type: 3, // Lista base Bsale Emmett DEV
                    //type: 2, //Lista base SOundstore
                    bPrice: detalle.precioBase
                };

                console.log("Actualizando precio base:", data);

                axios.post('/api/actualizar_precio/', data)
                    .then(response => {
                        console.log('Precio base actualizado correctamente:', response.data);
                        Swal.fire({
                            title: 'Éxito',
                            text: 'El precio base se actualizó correctamente.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error al actualizar el precio base:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar el precio base.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            abrirModal(detalle) {
                this.skuSeleccionado = detalle.sku;
                this.nombreSeleccionado = detalle.model;
                this.precioSeleccionado = detalle.precioBase;
                this.detalleSeleccionado = detalle;
                console.log(detalle,"Detalle")

                // Inicializar las listas de precios al abrir el modal
                this.listasPrecios = this.initializeListasPrecios(detalle);
                // Llamar a obtenerValorActual para cada precio en las listas de precios
                this.listasPrecios.forEach(precio => {
                    this.obtenerValorActual(precio);
                });

                $('#modalPrecios').modal('show');
            },
            actualizarListasPrecios() {
                console.log("Actualizando listas de precios para SKU:", this.skuSeleccionado);
                console.log("Nuevos precios:", this.listasPrecios);

                // Enviar la solicitud al backend con el SKU y las listas de precios
                axios.post('/api/actualizar_listas_precios/', {
                    sku: this.skuSeleccionado,
                    precios: this.listasPrecios
                })
                .then(response => {
                    console.log("Listas de precios actualizadas:", response.data);
                    Swal.fire({
                        title: 'Éxito',
                        text: 'Las listas de precios se actualizaron correctamente.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    $('#modalPrecios').modal('hide'); // Cerrar el modal
                })
                .catch(error => {
                    console.error("Error al actualizar las listas de precios:", error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un problema al actualizar las listas de precios.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            },
            obtenerDatosProducto(detalle) {
                console.log("Obteniendo datos para SKU:", detalle.sku); // Log para verificar el SKU

                let formData = new FormData();
                formData.append("sku", detalle.sku);
                formData.append("price_list_id", 3); // Enviar la lista de precios fija (3)

                axios.post("/api/obtener_datos_producto/", formData)
                    .then(response => {
                        console.log("Datos del producto obtenidos:", response.data); // Verifica la respuesta completa

                        // Usa this.$set para garantizar reactividad
                        this.$set(detalle, "lastCost", parseFloat(response.data.lastCost) || 0);
                        this.$set(detalle, "totalStock", parseFloat(response.data.totalStock) || 0);
                        this.$set(detalle, "lastPrice", parseFloat(response.data.lastPrice) || 0);
                        this.$set(detalle, "bsalePrice", response.data.bsalePrice || "No disponible");
                        this.$set(detalle, "precioBase", parseFloat(response.data.bsalePrice) || 0);
                        this.$set(detalle, "iderp",response.data.iderp || "No disponible");
                         // Asegura que sea 0 si no es válido
 // Asegura que sea un número válido

                        // Solo llama a calcularMargen si los datos son válidos
                        if (detalle.cost && detalle.precioBase) {
                            this.calcularMargen(detalle);
                        } else {
                            console.warn(`No se puede calcular margen: faltan datos para el detalle con SKU ${detalle.sku}`);
                        }

                        console.log("Detalle actualizado con margen:", detalle); // Verifica los valores asignados
                    })
                    .catch(error => {
                        console.error("Error al obtener datos del producto:", error);

                        // Valores predeterminados en caso de error
                        this.$set(detalle, "lastCost", 0);
                        this.$set(detalle, "totalStock", 0);
                        this.$set(detalle, "lastPrice", 0);
                        this.$set(detalle, "bsalePrice", "No disponible");
                        this.$set(detalle, "precioBase", 0); // Precio base predeterminado
                        this.$set(detalle, "margen", 0); // Margen predeterminado
                    });
            },
            formatCurrency(value) {
                if (!value || isNaN(value)) {
                    return "0";
                }
                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(value);
            },
            recalcularMargen(precio) {
                console.log(precio,"PRECIO")
                const costo = parseFloat(precio.costo) || 0;
                const fee = parseFloat(precio.fee) || 1.25;
                const iva = parseFloat(precio.iva) || 1.19;
                const n = parseFloat(precio.n) || 1.35;
                const despacho = parseFloat(precio.despacho) || 0;
                const valorIngresado = parseFloat(precio.valor) || 0;

                if (!costo || !fee || !iva || !n) {
                    precio.valorSugerido = null;
                    precio.margen = 0;
                    return;
                }

                // Calcular Valor Sugerido y redondear hacia arriba
                const valorSugerido = Math.ceil((costo * fee * iva * n) + despacho);
                precio.valorSugerido = valorSugerido;

                // Calcular Margen basado en el Valor Ingresado
                let margenIngresado = 0;
                if (valorIngresado > 0) {
                    const xIngresado = (valorIngresado / (fee * iva)) - despacho;
                    margenIngresado = (1 - (costo / xIngresado)) * 100;
                }

                // Asignar valores calculados
                precio.margen = margenIngresado.toFixed(2);
            },
            updateFee(precio) {
                // Convertir porcentaje a formato decimal y recalcular margen
                precio.fee = 1 + (parseFloat(precio.feePercentage || 0) / 100);
                this.recalcularMargen(precio);
            },
            updateN(precio) {
                // Convertir porcentaje a formato decimal y recalcular margen
                precio.n = 1 + (parseFloat(precio.nPercentage || 0) / 100);
                this.recalcularMargen(precio);
            },

            // Función para calcular el costo con descuento
            calcularCostoConDescuento(cost, dctoItem) {
                const descuento = cost * (dctoItem / 100);
                return cost - descuento;
            },
            // Función para calcular el total (cost * qty)
            calcularTotal(cost, qty) {
                return cost * qty;
            },
            // Función para calcular el margen basado en el precio base
            calcularMargen(detalle) {
                // Verifica que los valores sean números válidos
                const costoNeto = parseFloat(detalle.cost_with_discount) || 0; 
                const precioBaseNeto = (parseFloat(detalle.precioBase) || 0) / 1.19; // Precio base sin IVA

                if (precioBaseNeto > 0) {
                    const margen = ((precioBaseNeto - costoNeto) / precioBaseNeto) * 100; // Fórmula del margen
                    detalle.margen = margen.toFixed(2); // Redondea a 2 decimales

                    // Imprime los valores utilizados en la ecuación
                    console.log(`Cálculo del margen para SKU ${detalle.sku}:`);
                    console.log(`Costo Neto: ${costoNeto}, Precio Base Neto: ${precioBaseNeto}`);
                    console.log(`Margen calculado: ${margen}%`);
                } else {
                    detalle.margen = 0; // Si el precio base neto es 0, el margen también lo es

                    // Imprime un mensaje si no es posible calcular el margen
                    console.log(`No se puede calcular el margen para SKU ${detalle.sku}: Precio Base Neto es 0.`);
                }
            },
            // Función para obtener los detalles de la factura
            obtenerFactura() {
                console.log("Obteniendo factura con ID:", this.idFactura);

                let formData = new FormData();
                formData.append("id", this.idFactura);

                axios.post("/api/obtener_factura/", formData)
                    .then(response => {
                        this.factura = response.data; // Asignar los datos de la factura
                        this.detalles = response.data.details.map(detalle => ({
                            ...detalle,
                            precioBase: detalle.bsalePrice || '000' // Precargar el precio base con el valor de bsalePrice
                        }));
                        console.log("Datos de la factura:", response.data);

                        // Llamar a obtenerDatosProducto para cada detalle
                        this.detalles.forEach(detalle => {
                            this.obtenerDatosProducto(detalle);
                        });
                    })
                    .catch(error => {
                        console.error("Error al obtener la factura:", error);
                        this.errorMsg = "Hubo un problema al obtener los detalles de la factura.";
                    });
            },
            // Función para rechazar la factura con confirmación
            confirmarRechazarFactura() {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Esta acción no se puede deshacer",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, rechazar',
                    cancelButtonText: 'No, cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.rechazarFactura();  // Llamar a la función que rechaza la factura
                    }
                });
            },
            // Función para rechazar la factura
            rechazarFactura() {
                let formData = new FormData();
                formData.append('id', this.idFactura);

                axios.post('/api/rechazar-factura/', formData)
                    .then(response => {
                        console.log(response.data.message);
                        Swal.fire({
                            title: 'Factura Rechazada',
                            text: 'La factura ha sido rechazada con éxito.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '/recepciones_pendientes/';  // Redirigir a la página indicada
                        });
                    })
                    .catch(error => {
                        console.error('Error al rechazar la factura:', error);
                    });
            },
            // Función para aprobar la factura
            aprobarFactura() {
                const detalles = this.detalles.map(detalle => ({
                    sku: detalle.sku,
                    cost: detalle.cost
                }));

                const data = {
                    factura_id: this.idFactura, // Incluye el ID de la factura
                    detalles: detalles          // Detalles de la factura
                };

                axios.post('/api/aprobar-factura/', data)
                    .then(response => {
                        console.log(response.data.message);
                        console.log('Productos actualizados:', response.data.productos_actualizados);
                        console.log('Productos no encontrados:', response.data.productos_no_encontrados);

                        Swal.fire({
                            title: 'Factura Aprobada',
                            text: 'La factura ha sido aprobada con éxito.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '/recepciones_pendientes/';  // Redirigir a la página indicada
                        });
                    })
                    .catch(error => {
                        console.error('Error al aprobar la factura:', error);
                    });
            },
            // Función para extraer el ID de la factura desde la URL
            getFacturaIdFromURL() {
                const urlParts = window.location.pathname.split('/');
                const idFactura = urlParts[urlParts.length - 2];  // El ID de la factura está en la penúltima parte de la URL
                return idFactura;
            },
            actualizarPreciosBaseMasivo() {
                if (this.detalles.length === 0) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay precios para actualizar.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                const precios = this.detalles.map(detalle => ({
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    bPrice: detalle.precioBase, // Precio bruto con impuestos
                    type: 3 // ID de la lista de precios base
                }));

                console.log("Datos enviados a la API para actualización masiva:", precios);

                axios.post('/api/actualizar_precios_masivo/', { precios })
                    .then(response => {
                        console.log('Respuesta de la API:', response.data);
                        Swal.fire({
                            title: 'Éxito',
                            text: 'Precios actualizados correctamente.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error al actualizar los precios:', error.response.data);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar los precios.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            }


        },
        mounted() {
            console.log("Componente montado");  // Verificar que el mounted se ejecuta

            this.idFactura = this.getFacturaIdFromURL();  // Guardar el ID de la URL en la variable de Vue
            if (this.idFactura) {
                this.obtenerFactura();  // Llamar a la API con el ID de la factura
            } else {
                console.error("No se pudo obtener el ID de la factura desde la URL");
            }
        }
    });
</script>
{% endblock js %}