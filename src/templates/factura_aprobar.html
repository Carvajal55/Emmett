{% extends 'partials/base.html' %}
{% load static %}
{% block css %}
<style>
    .table-container {
        max-height: 500px; /* Ajusta la altura de la tabla */
        overflow-y: auto; /* Permite hacer scroll en el contenido */
        border: 1px solid #ccc;
    }

    .table thead {
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 10;
    }
</style>
{% endblock css %}
{% block content %}
<div id="app" class="m-2">
    <h3>Aprobaci√≥n de Factura</h3>

    <!-- Aqu√≠ mostraremos los datos de la factura -->
    <div v-if="factura" class="container">
        <div class="row">
            <button class="btn btn-success mt-3" @click="exportarExcel">
                Descargar Excel(EN DESARROLLO)
            </button>
            <!-- Columna 1 -->
            <div class="col-md-4">
                <p><strong>Forma de Pago:</strong> [[ factura.headers.typePay ]]</p>
                <p><strong>N√∫mero de Cheque:</strong> [[ factura.headers.nCheque ]]</p>
                <p><strong>Fecha Pago Documento:</strong> [[ factura.headers.dateExpired || 'N/A' ]]</p>
                <p><strong>Ingresado Por:</strong> [[ factura.headers.userProcess ]]</p>
                <p><strong>Estado Resumen:</strong> OK</p>
                <p><strong>PDF:</strong> <a :href="`/media/${factura.headers.urlImg}`" target="_blank">Ver PDF</a></p>
            

            </div>

            <!-- Columna 2 -->
            <div class="col-md-4">
                <p><strong>Tipo de Documento:</strong> [[ factura.headers.typeDocument ]]</p>
                <p><strong>Folio:</strong> [[ factura.headers.nDocument ]]</p>
                <p><strong>Proveedor:</strong> [[ factura.headers.supplierName ]]</p>
                <p><strong>Observaci√≥n:</strong> [[ factura.headers.observation || 'Sin observaciones' ]]</p>
                
                <!-- Botones para aprobar o rechazar -->
                <div v-if="statusInvoiceD !== 1">
                    <button class="btn btn-success" @click="aprobarFactura()">Aprobar</button>
                    <button class="btn btn-danger" @click="confirmarRechazarFactura()">Rechazar</button>
                </div>
            </div>

            <!-- Columna 3 -->
            <div class="col-md-4">
                <p><strong>Fecha de Emisi√≥n:</strong> [[ factura.headers.datePurchase ]]</p>
                <p><strong>Fecha Recepci√≥n:</strong> [[ factura.headers.dateReception ]]</p>
                <p><strong>Descuento Documento:</strong> [[ factura.headers.dcto || '0' ]]</p>
                <p><strong>Valor Neto:</strong> [[ formatCurrency(factura.headers.subtotalNeto) ]]</p>
                <p><strong>Total IVA Incluido:</strong> [[ formatCurrency(factura.headers.subtotalBruto) ]]</p>
            </div>
        </div>
    </div>
    <div class="col-12  mt-4">
        <button class="btn btn-primary" @click="actualizarPreciosBaseMasivo">
            Actualizar Todos los Precios Base
        </button>
    </div>
   <!-- Modal -->
   <div class="modal fade" id="modalPrecios" tabindex="-1" role="dialog" aria-labelledby="modalPreciosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl custom-modal-width" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h4 class="modal-title" id="modalPreciosLabel" style="font-size: 1.5rem; font-weight: bold;">
                            Actualizar Listas de Precios para SKU: [[ skuSeleccionado ]]
                        </h4>
                        <p style="font-size: 1.2rem; font-weight: bold;">
                            Nombre: [[ nombreSeleccionado ]]
                        </p>
                        <p style="font-size: 1.2rem; font-weight: bold;">
                            Precio Base Bsale: [[ precioSeleccionado ]]
                        </p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group col-6 mb-3" v-if="mostrarPrecioGlobal">
                        <div class="form-check">
                            <input 
                                type="checkbox" 
                                id="toggleGlobalInput" 
                                class="form-check-input" 
                                v-model="habilitarInputGlobal"
                            />
                            <label for="toggleGlobalInput" class="form-check-label" style="font-weight: bold;">Habilitar Precio Global</label>
                        </div>
                    
                        <label for="inputGlobal" style="font-weight: bold; font-size: 1rem;">Precio Global</label>
                        <input
                            type="number"
                            id="inputGlobal"
                            class="form-control"
                            v-model.number="precioGlobal"
                            @input="asignarPrecioGlobal"
                            placeholder="Ingrese un precio global"
                            :disabled="!habilitarInputGlobal"
                            v-if="mostrarActualizarTodos"
                        />
                    </div>
                    <div class="col-12  mt-4">
                        <button
                            type="button"
                            class="btn btn-success"
                            @click="actualizarTodosLosPrecios"
                            style="padding: 10px 20px; font-size: 1rem;"
                            v-if="mostrarActualizarTodos"
                        >
                            Actualizar Todos
                        </button>
                    </div>
                    <div class="row">
                        <div v-for="(precio, index) in listasPrecios" 
                             :key="index" 
                             class="col-md-6 mb-3" 
                             style="padding: 10px;"
                             v-if="precio.mostrar"> <!-- Solo se muestran los precios con mostrar: true -->
                             
                            <div class="form-group">
                                <!-- Mostrar el label con el Valor Sugerido -->
                                <label :for="'precio-' + precio.id" style="font-weight: bold; margin-bottom: 5px; display: block;">
                                    [[ precio.label ]]
                                </label>
                    
                                <!-- Mostrar el Valor Sugerido -->
                                <p style="margin-top: 5px; font-size: 0.9rem; color: gray;">
                                    Valor Sugerido: [[ precio.valorSugerido || 'Pendiente' ]] CLP
                                </p>
                                <p style="margin-top: 5px; font-size: 0.9rem; color: gray;">
                                    Valor Actual: [[ precio.valorActual || 'Pendiente' ]] CLP
                                </p>
                    
                                <!-- Input para ingresar el valor -->
                                <input
                                    type="number"
                                    class="form-control"
                                    v-model.number="precio.valor"
                                    @input="recalcularMargen(precio)"
                                    :id="'precio-' + precio.id"
                                    placeholder="Ingrese precio"
                                    style="margin-bottom: 10px;"
                                />
                    
                                <!-- Mostrar el margen calculado -->
                                <p style="margin-top: 10px; font-size: 1rem;">
                                    <strong>Margen:</strong> [[ precio.margen || 0 ]]%
                                </p>
                    
                                <div class="row">
                                    <div class="col-4">
                                        <label for="fee" style="font-size: 0.8rem; font-weight: bold;">
                                            Comisi√≥n (Fee)
                                            <span style="color: gray;">[[ calcularPorcentajeFee(precio.fee) ]]%</span>
                                        </label>
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            v-model.number="precio.fee"
                                            @input="actualizarMargenYValorSugerido(precio)"
                                            id="fee"
                                            placeholder="Ej: 1.25"
                                        />
                                    </div>
                                    
                                    <div class="col-4">
                                        <label for="n" style="font-size: 0.8rem; font-weight: bold;">
                                            Margen (N)
                                            <span style="color: gray;">[[ calcularPorcentajeMargen(precio.n) ]]%</span>
                                        </label>
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            v-model.number="precio.n"
                                            @input="actualizarMargenYValorSugerido(precio)"
                                            id="n"
                                            placeholder="Ej: 1.35"
                                        />
                                    </div>
                                    
                                    <div class="col-4">
                                        <label for="despacho" style="font-size: 0.8rem; font-weight: bold;">
                                            Despacho (CLP)
                                        </label>
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            v-model.number="precio.despacho"
                                            @input="actualizarMargenYValorSugerido(precio)"
                                            id="despacho"
                                            placeholder="Ej: 4990"
                                        />
                                    </div>
                                </div>
                    
                                <!-- Bot√≥n para guardar individual -->
                                <button
                                    class="btn btn-primary mt-2 w-100"
                                    @click="actualizarListaPrecio(detalleSeleccionado, precio.id, precio.valor)"
                                    :style="getButtonStyle(precio.label)"
                                >
                                    Guardar para [[ precio.label ]]
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- Bot√≥n para cerrar -->
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                        style="padding: 10px 20px; font-size: 1rem;"
                    >
                        Cerrar
                    </button>
                    <!-- Bot√≥n para actualizar todos los precios -->
                    <button
                        type="button"
                        class="btn btn-success"
                        @click="actualizarTodosLosPrecios"
                        style="padding: 10px 20px; font-size: 1rem;"
                        v-if="mostrarActualizarTodos"
                    >
                        Actualizar Todos
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Detalles de la factura -->
    <div class="table-container">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th style="width: 8%;">SKU</th>
                    <th style="width: 15%;">PRODUCTO</th>
                    <th style="width: 5%; text-align: center;">QTY</th>
                    <th style="width: 5%; text-align: center;">DCTO</th>
                    <th style="width: 10%; text-align: right;">COSTO REAL</th>
                    <th style="width: 10%; text-align: right;">COSTO</th>
                    <th style="width: 8%; text-align: right;">√ö.COSTO</th>
                    <th style="width: 8%; text-align: right;">√ö.PRECIO</th>
                    <th style="width: 10%; text-align: right;">PRECIO BSALE</th>
                    <th style="width: 10%; text-align: right;">TOTAL</th>
                    <th style="width: 18%;">PRECIO BASE</th>
                    <th style="width: 5%; text-align: center;">MARGEN</th>
                    <th style="width: 5%; text-align: center;">STOCK</th>
                    <th style="width: 10%;">ACCI√ìN</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(detalle, index) in detalles" :key="detalle.sku">
                    <td>[[ detalle.sku ]]</td>
                    <td>[[ detalle.model ]]</td>
                    <td style="text-align: center;">[[ detalle.qty ]]</td>
                    <td style="text-align: center;">[[ detalle.dctoItem ]] %</td>
                    <td style="text-align: right;">[[ formatCurrency(detalle.cost_with_discount) ]]</td>
                    <td style="text-align: right;">[[ formatCurrency(detalle.cost) ]]</td>
                    <td style="text-align: right;">[[ formatCurrency(detalle.lastCost || 0) ]]</td>
                    <td style="text-align: right;">[[ formatCurrency(detalle.lastPrice || 0) ]]</td>
                    <td style="text-align: right;">[[ formatCurrency(detalle.bsalePrice || 0) ]]</td>
                    <td style="text-align: right;">[[ formatCurrency(calcularTotal(detalle.cost_with_discount, detalle.qty)) ]]</td>
                    <td>
                        <input 
                            type="number" 
                            class="form-control" 
                            v-model.number="detalle.precioBase" 
                            placeholder="Precio Base"
                            @input="calcularMargen(detalle)"
                        >
                    </td>
                    <td style="text-align: center;">[[ detalle.margen ]]%</td>
                    <td style="text-align: center;">[[ detalle.totalStock ]]</td>
                    <td>
                        <button class="btn btn-info btn-sm" @click="abrirModal(detalle,true)">P.MarketPlace</button>
                        <button class="btn btn-primary btn-sm mt-1" @click="actualizarPrecioBase(detalle)">P.Base</button>
                        <button class="btn btn-secondary btn-sm" @click="abrirModal(detalle, false)">Precios.G&M</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    

    <!-- Mostrar un mensaje si no hay detalles -->
    <p v-if="detalles.length === 0 && factura">No hay detalles para esta factura.</p>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  <!-- SweetAlert -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],  // Evitar conflictos con las etiquetas de Django
        data: {
            statusInvoiceD: 0,  // ‚úÖ Inicializa el estado del statusInvoiceD
            habilitarInputGlobal: false,
            factura: null,  // Datos de la factura
            detalles: [],   // Detalles de la factura
            errorMsg: '',    // Mensaje de error
            idFactura: null,
            listasPrecios: [
                { label: 'MercadoLibre', id: 10, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 4990, margen: null, valor: null, valorSugerido: null, mostrar: true },
                { label: 'Paris', id: 12,  fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                { label: 'Ripley', id: 13, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                { label: 'Walmart', id: 14, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                { label: 'Falabella', id: 11, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                { label: 'Groben', id: 20, fee: 1.031, feePercentage: 1.25, iva: 1.19, n: 1, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null, mostrar: false },
                { label: 'Mayorista', id: 21, fee: 1, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, margen: null, valor: null, valorSugerido: null, mostrar: false }
            ],
            detalleSeleccionado: null,
            skuSeleccionado: null, // SKU del producto seleccionado
            precioSeleccionado: null,
            nombreSeleccionado: null,
            stockProductos: {},
            precioGlobal: null,
        },
        computed: {
            mostrarActualizarTodos() {
                // Filtrar las listas que est√°n visibles
                const listasVisibles = this.listasPrecios.filter(precio => precio.mostrar);
                
                // Verificar si todas las listas visibles son Groben y/o Mayorista
                const soloGrobenOMayorista = listasVisibles.every(precio => 
                    precio.label === 'Groben' || precio.label === 'Mayorista'
                );

                // Mostrar el bot√≥n solo si hay listas visibles y no son solo Groben y Mayorista
                return listasVisibles.length > 0 && !soloGrobenOMayorista;
            },
            mostrarPrecioGlobal() {
                // Filtrar las listas que est√°n visibles
                const listasVisibles = this.listasPrecios.filter(precio => precio.mostrar);
                
                // Verificar si todas las listas visibles son Groben y/o Mayorista
                const soloGrobenOMayorista = listasVisibles.every(precio => 
                    precio.label === 'Groben' || precio.label === 'Mayorista'
                );

                // Mostrar el input global solo si hay listas visibles y no son solo Groben y Mayorista
                return listasVisibles.length > 0 && !soloGrobenOMayorista;
            }
        },
        mounted() {
            console.log("Componente montado"); // Verificar que el mounted se ejecuta

            this.idFactura = this.getFacturaIdFromURL(); // Guardar el ID de la URL en la variable de Vue
            if (this.idFactura) {
                this.obtenerFactura(); // Llamar a la API con el ID de la factura
            } else {
                console.error("No se pudo obtener el ID de la factura desde la URL");
            }
            this.recalcularTodos();

            
        },
        methods: {
            calcularPorcentaje(valor) {
                if (valor && valor > 0) {
                    return ((valor - 1) * 100).toFixed(2);
                }
                return 0;
            },
            calcularPorcentajeFee(valor) {
                if (valor && valor > 0) {
                    return (100 - (100 / valor)).toFixed(2);
                }
                return 0;
            },
            calcularPorcentajeMargen(valor) {
                if (valor && valor > 0) {
                    return (100 - (100 / valor)).toFixed(2);
                }
                return 0;
            },
            asignarPrecioGlobal() {
                // Verificar que el precio global sea v√°lido y el input est√© habilitado
                if (this.habilitarInputGlobal && this.precioGlobal !== null && this.precioGlobal >= 0) {
                    this.listasPrecios.forEach(precio => {
                        precio.valor = this.precioGlobal; // Actualizar cada valor
                        this.recalcularMargen(precio); // Solo recalcula el margen cuando hay un valor en el input
                    });
                }
            },
            actualizarTodosLosPrecios() {
                if (this.listasPrecios.length === 0) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay precios para actualizar.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // üî• Filtrar Groben y Mayorista para que NO se actualicen masivamente
                const preciosAActualizar = this.listasPrecios.filter(precio => 
                    precio.label !== 'Groben' && precio.label !== 'Mayorista' && precio.mostrar
                );

                // Verificar si hay precios para actualizar despu√©s del filtro
                if (preciosAActualizar.length === 0) {
                    Swal.fire({
                        title: 'Informaci√≥n',
                        text: 'No hay precios para actualizar.',
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // Mapear todas las actualizaciones de precios
                const actualizaciones = preciosAActualizar.map(precio => {
                    if (!precio.valor || precio.valor <= 0) {
                        return Promise.resolve({
                            label: precio.label,
                            status: 'error',
                            message: `El valor ingresado para ${precio.label} no es v√°lido.`
                        });
                    }

                    const url = `https://api.bsale.io/v1/price_lists/${precio.id}/details.json?code=${this.skuSeleccionado}`;
                    const headers = {
                        access_token: '1b7908fa44b56ba04a3459db5bb6e9b12bb9fadc',
                        'Content-Type': 'application/json'
                    };

                    return axios.get(url, { headers })
                        .then(response => {
                            const items = response.data.items || [];
                            if (items.length === 0) {
                                throw new Error(`No se encontr√≥ detalle para el SKU ${this.skuSeleccionado} en la lista ${precio.label}`);
                            }
                            const idDetalle = items[0].id;

                            const urlUpdate = `https://api.bsale.io/v1/price_lists/${precio.id}/details/${idDetalle}.json`;
                            const dataUpdate = {
                                variantValue: Math.ceil(precio.valor / 1.19),
                                id: idDetalle
                            };

                            return axios.put(urlUpdate, dataUpdate, { headers });
                        })
                        .then(() => ({
                            label: precio.label,
                            status: 'success',
                            message: `Precio actualizado correctamente en ${precio.label}`
                        }))
                        .catch(error => ({
                            label: precio.label,
                            status: 'error',
                            message: error.response?.data?.message || error.message || `Error al actualizar precio en ${precio.label}`
                        }));
                });

                // Procesar los resultados
                Promise.all(actualizaciones)
                    .then(results => {
                        const errores = results.filter(result => result.status === 'error');
                        const exitos = results.filter(result => result.status === 'success');

                        Swal.fire({
                            title: 'Resultados de la Actualizaci√≥n',
                            html: `
                                <p><strong>Actualizados con √©xito:</strong> ${exitos.length}</p>
                                <p><strong>Errores:</strong> ${errores.length}</p>
                                ${errores.length > 0 ? `<p><strong>Detalles de errores:</strong></p><ul>${errores.map(err => `<li>${err.label}: ${err.message}</li>`).join('')}</ul>` : ''}
                            `,
                            icon: errores.length > 0 ? 'warning' : 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error general al actualizar los precios:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Ocurri√≥ un problema al actualizar los precios.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            obtenerValorActual(precio) {
                const data = {
                    price_list_id: precio.id,
                    sku: this.skuSeleccionado
                };

                axios.post('/api/obtener_valor_actual/', data)
                    .then(response => {
                        const valorRecibido = response.data.valor_actual;
                        if (valorRecibido) {
                            const valorConIva = Math.floor(valorRecibido * 1.19);
                            this.$set(precio, 'valorActual', valorConIva);
                        } else {
                            this.$set(precio, 'valorActual', 'Pendiente');
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener el valor actual:', error);
                        this.$set(precio, 'valorActual', 'Error');
                    });
            },
            initializeListasPrecios(detalle) {
                return [
                    { label: 'MercadoLibre', id: 10, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 4990,costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                    { label: 'Paris', id: 12,  fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0,costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                    { label: 'Ripley', id: 13, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, costo: detalle.cost || 0,margen: null, valor: null, valorSugerido: null, mostrar: true },
                    { label: 'Walmart', id: 14, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0,costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                    { label: 'Falabella', id: 11, fee: 1.25, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0,costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null, mostrar: true },
                    { label: 'Groben', id: 20, fee: 1.031, feePercentage: 1.25, iva: 1.19, n: 1, nPercentage: 1.35, despacho: 0,costo: detalle.cost || 0, margen: null, valor: null, valorSugerido: null, mostrar: false },
                    { label: 'Mayorista', id: 21, fee: 1, feePercentage: 1.25, iva: 1.19, n: 1.35, nPercentage: 1.35, despacho: 0, costo: detalle.cost || 0,margen: null, valor: null, valorSugerido: null, mostrar: false }
                ];
            },
            recalcularTodos() {
                this.listasPrecios.forEach(precio => {
                    this.recalcularMargen(precio);
                });
            },
            getButtonStyle(label) {
                switch (label) {
                    case 'MercadoLibre':
                        return 'background-color: #ffdd00; color: black; width: 100%;';
                    case 'Paris':
                        return 'background-color: #0056b3; color: white; width: 100%;';
                    case 'Falabella':
                        return 'background-color: #76b900; color: white; width: 100%;';
                    case 'Ripley':
                        return 'background-color: #4b0082; color: white; width: 100%;';
                    case 'Walmart':
                        return 'background-color: #0071ce; color: white; width: 100%;';
                    case 'Groben':
                        return 'background-color: #0071ce; color: white; width: 100%;';
                    case 'Mayorista':
                        return 'background-color: #0071ce; color: white; width: 100%;';
                    default:
                        return 'background-color: #6c757d; color: white; width: 100%;';
                }
            },
            actualizarListaPrecio(detalle, type, bPrice) {
                if (!bPrice) {
                    alert('Por favor ingresa un precio.');
                    return;
                }

                const data = {
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    type: type, // ID de la lista
                    bPrice: bPrice
                };

                console.log("Actualizando lista de precios:", data);

                axios.post('/api/actualizar_precio/', data)
                    .then(response => {
                        console.log(`Precio para lista ${type} actualizado correctamente:`, response.data);
                        Swal.fire({
                        title: '√âxito',
                        text: `El precio para la lista ${type} se actualiz√≥ correctamente.`,
                        icon: 'success',
                        showConfirmButton: false, // Ocultar el bot√≥n de confirmaci√≥n
                        timer: 500 // Cerrar autom√°ticamente despu√©s de 500ms
                    });
                    })
                    .catch(error => {
                        console.error(`Error al actualizar el precio para la lista ${type}:`, error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar el precio.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            actualizarPrecioBase(detalle) {
                if (!detalle.precioBase) {
                    alert('Por favor ingresa un precio base.');
                    return;
                }

                const data = {
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    type: 3, // Lista base Bsale Emmett DEV
                    //type: 2, //Lista base SOundstore
                    bPrice: detalle.precioBase
                };

                console.log("Actualizando precio base:", data);

                axios.post('/api/actualizar_precio/', data)
                    .then(response => {
                        console.log('Precio base actualizado correctamente:', response.data);
                        Swal.fire({
                            title: '√âxito',
                            text: 'El precio base se actualiz√≥ correctamente.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error al actualizar el precio base:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar el precio base.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            // Funci√≥n unificada para recalcular Margen y Valor Sugerido
            actualizarMargenYValorSugerido(precio) {
                const costo = parseFloat(precio.costo) || 0;
                const fee = parseFloat(precio.fee) || 1.25;
                const iva = parseFloat(precio.iva) || 1.19;
                const despacho = parseFloat(precio.despacho) || 0;
                const valorIngresado = parseFloat(precio.valor) || precio.valorSugerido || 0;
                const n = parseFloat(precio.n) || 1; // Margen deseado

                // Calcular Margen usando el valor ingresado y el valor neto
                if (valorIngresado > 0) {
                    const valorNeto = ((valorIngresado - despacho) / (iva)) / fee;
                    const margenIngresado = (1 - (costo / valorNeto)) * 100;
                    precio.margen = margenIngresado.toFixed(2);
                } else {
                    precio.margen = 0;
                }

                // Calcular Margen Deseado para Valor Sugerido
                const margenDeseado = (100 - (100 / n)) / 100;

                // Calcular Valor Sugerido considerando el margen deseado y el despacho
                const valorSugerido = Math.ceil(((costo * fee * iva) / (1 - margenDeseado)) + despacho);
                precio.valorSugerido = valorSugerido;
            },
            abrirModal(detalle, mostrar) {
                this.skuSeleccionado = detalle.sku;
                this.nombreSeleccionado = detalle.model;
                this.precioSeleccionado = detalle.precioBase;
                this.detalleSeleccionado = detalle;

                console.log("Detalle seleccionado:", detalle);

                // Reiniciar el estado del Precio Global
                this.habilitarInputGlobal = false;
                this.precioGlobal = null;

                // Inicializar las listas de precios con valores por defecto
                this.listasPrecios = this.initializeListasPrecios(detalle);

                // Mostrar solo los valores de 'mostrar' que coincidan con el par√°metro recibido
                this.listasPrecios.forEach(precio => {
                    precio.mostrar = (precio.mostrar === mostrar);
                });

                // Obtener los valores actuales y calcular sugeridos solo para los que se muestran
                this.listasPrecios.forEach(precio => {
                    if (precio.mostrar) {
                        this.obtenerValorActual(precio);   // Obtiene el valor actual del marketplace
                        this.calcularValorSugerido(precio); // Calcula el valor sugerido con margen de 25%
                        precio.margen = 0; // Inicializa el margen en 0% // Recalcula el margen
                    }
                });

                // Mostrar el modal despu√©s de cargar los datos
                $('#modalPrecios').modal('show');
            },
            calcularValorSugerido(precio) {
                const costo = parseFloat(precio.costo) || 0;
                const fee = parseFloat(precio.fee) || 1.25;
                const iva = parseFloat(precio.iva) || 1.19;
                const despacho = parseFloat(precio.despacho) || 0;
                const n = parseFloat(precio.n) || 1;

                // Calcular Margen Deseado usando la f√≥rmula dada
                const margenDeseado = (100 - (100 / n)) / 100;

                // Calcular Valor Sugerido considerando el despacho y el margen calculado
                const valorSugerido = Math.ceil(((costo * fee * iva) / (1 - margenDeseado)) + despacho);
                precio.valorSugerido = valorSugerido;
            },

            actualizarListasPrecios() {
                console.log("Actualizando listas de precios para SKU:", this.skuSeleccionado);
                console.log("Nuevos precios:", this.listasPrecios);

                // Enviar la solicitud al backend con el SKU y las listas de precios
                axios.post('/api/actualizar_listas_precios/', {
                    sku: this.skuSeleccionado,
                    precios: this.listasPrecios
                })
                .then(response => {
                    console.log("Listas de precios actualizadas:", response.data);
                    Swal.fire({
                        title: '√âxito',
                        text: 'Las listas de precios se actualizaron correctamente.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    $('#modalPrecios').modal('hide'); // Cerrar el modal
                })
                .catch(error => {
                    console.error("Error al actualizar las listas de precios:", error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un problema al actualizar las listas de precios.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            },
            obtenerDatosProducto(detalle) {
                console.log("Obteniendo datos para SKU:", detalle.sku); // Log para verificar el SKU

                let formData = new FormData();
                formData.append("sku", detalle.sku);
                formData.append("price_list_id", 3); // Enviar la lista de precios fija (3)

                axios.post("/api/obtener_datos_producto/", formData)
                    .then(response => {
                        console.log("Datos del producto obtenidos:", response.data); // Verifica la respuesta completa

                        // Usa this.$set para garantizar reactividad
                        this.$set(detalle, "lastCost", parseFloat(response.data.lastCost) || 0);
                        this.$set(detalle, "totalStock", parseFloat(response.data.totalStock) || 0);
                        this.$set(detalle, "lastPrice", parseFloat(response.data.lastPrice) || 0);
                        this.$set(detalle, "bsalePrice", response.data.bsalePrice || "No disponible");
                        this.$set(detalle, "precioBase", parseFloat(response.data.bsalePrice) || 0);
                        this.$set(detalle, "iderp",response.data.iderp || "No disponible");
                         // Asegura que sea 0 si no es v√°lido
 // Asegura que sea un n√∫mero v√°lido

                        // Solo llama a calcularMargen si los datos son v√°lidos
                        if (detalle.cost && detalle.precioBase) {
                            this.calcularMargen(detalle);
                        } else {
                            console.warn(`No se puede calcular margen: faltan datos para el detalle con SKU ${detalle.sku}`);
                        }

                        console.log("Detalle actualizado con margen:", detalle); // Verifica los valores asignados
                    })
                    .catch(error => {
                        console.error("Error al obtener datos del producto:", error);

                        // Valores predeterminados en caso de error
                        this.$set(detalle, "lastCost", 0);
                        this.$set(detalle, "totalStock", 0);
                        this.$set(detalle, "lastPrice", 0);
                        this.$set(detalle, "bsalePrice", "No disponible");
                        this.$set(detalle, "precioBase", 0); // Precio base predeterminado
                        this.$set(detalle, "margen", 0); // Margen predeterminado
                    });
            },
            formatCurrency(value) {
                if (!value || isNaN(value)) {
                    return "0";
                }
                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(value);
            },
           recalcularMargen(precio) {
                const costo = parseFloat(precio.costo) || 0;
                const fee = parseFloat(precio.fee) || 1.25;
                const iva = parseFloat(precio.iva) || 1.19;
                const despacho = parseFloat(precio.despacho) || 0;
                const valorIngresado = parseFloat(precio.valor) || precio.valorSugerido || 0;

                // Si el valor ingresado es mayor a 0, recalcular el margen
                if (valorIngresado > 0) {
                    const valorNeto = ((valorIngresado - despacho) / (iva))/fee;
                    const margenIngresado = (1 - (costo / valorNeto)) * 100;
                    precio.margen = margenIngresado.toFixed(2);
                } else {
                    precio.margen = 0; // Inicializa en 0 si no hay valor ingresado
                }
            },
            updateFee(precio) {
                // Convertir porcentaje a formato decimal y recalcular margen
                precio.fee = 1 + (parseFloat(precio.feePercentage || 0) / 100);
                this.recalcularMargen(precio);
            },
            updateN(precio) {
                // Convertir porcentaje a formato decimal y recalcular margen
                precio.n = 1 + (parseFloat(precio.nPercentage || 0) / 100);
                this.recalcularMargen(precio);
            },

            // Funci√≥n para calcular el costo con descuento
            calcularCostoConDescuento(cost, dctoItem) {
                const descuento = cost * (dctoItem / 100);
                return cost - descuento;
            },
            // Funci√≥n para calcular el total (cost * qty)
            calcularTotal(cost, qty) {
                return cost * qty;
            },
            // Funci√≥n para calcular el margen basado en el precio base
            calcularMargen(detalle) {
                // Verifica que los valores sean n√∫meros v√°lidos
                const costoNeto = parseFloat(detalle.cost_with_discount) || 0; 
                const precioBaseNeto = (parseFloat(detalle.precioBase) || 0) / 1.19; // Precio base sin IVA

                if (precioBaseNeto > 0) {
                    const margen = ((precioBaseNeto - costoNeto) / precioBaseNeto) * 100; // F√≥rmula del margen
                    detalle.margen = margen.toFixed(2); // Redondea a 2 decimales

                    // Imprime los valores utilizados en la ecuaci√≥n
                    console.log(`C√°lculo del margen para SKU ${detalle.sku}:`);
                    console.log(`Costo Neto: ${costoNeto}, Precio Base Neto: ${precioBaseNeto}`);
                    console.log(`Margen calculado: ${margen}%`);
                } else {
                    detalle.margen = 0; // Si el precio base neto es 0, el margen tambi√©n lo es

                    // Imprime un mensaje si no es posible calcular el margen
                    console.log(`No se puede calcular el margen para SKU ${detalle.sku}: Precio Base Neto es 0.`);
                }
            },
            // Funci√≥n para obtener los detalles de la factura
            obtenerFactura() {
                console.log("Obteniendo factura con ID:", this.idFactura);

                let formData = new FormData();
                formData.append("id", this.idFactura);

                axios.post("/api/obtener_factura/", formData)
                    .then(response => {
                        this.factura = response.data; // Asignar los datos de la factura
                        this.detalles = response.data.details.map(detalle => ({
                            ...detalle,
                            precioBase: detalle.bsalePrice || '000' // Precargar el precio base con el valor de bsalePrice
                        }));
                        console.log("Datos de la factura:", response.data);

                        // ‚úÖ Asignar nDocument y supplierName para usar en aprobarFactura
                        this.nDocumento = response.data.headers.nDocument;
                        this.proveedor = response.data.headers.supplierName;

                        // ‚úÖ Asignar statusInvoiceD para mostrar u ocultar botones
                        this.statusInvoiceD = response.data.headers.statusInvoiceD;

                        // Llamar a obtenerDatosProducto para cada detalle
                        this.detalles.forEach(detalle => {
                            this.obtenerDatosProducto(detalle);
                        });
                    })
                    .catch(error => {
                        console.error("Error al obtener la factura:", error);
                        this.errorMsg = "Hubo un problema al obtener los detalles de la factura.";
                    });
            },
            // Funci√≥n para rechazar la factura con confirmaci√≥n
            confirmarRechazarFactura() {
                Swal.fire({
                    title: '¬øEst√°s seguro?',
                    text: "Esta acci√≥n no se puede deshacer",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, rechazar',
                    cancelButtonText: 'No, cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.rechazarFactura();  // Llamar a la funci√≥n que rechaza la factura
                    }
                });
            },
            // Funci√≥n para rechazar la factura
            rechazarFactura() {
                let formData = new FormData();
                formData.append('id', this.idFactura);

                axios.post('/api/rechazar-factura/', formData)
                    .then(response => {
                        console.log(response.data.message);
                        Swal.fire({
                            title: 'Factura Rechazada',
                            text: 'La factura ha sido rechazada con √©xito.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '/recepciones_pendientes/';  // Redirigir a la p√°gina indicada
                        });
                    })
                    .catch(error => {
                        console.error('Error al rechazar la factura:', error);
                    });
            },
            // Funci√≥n para aprobar la factura
            aprobarFactura() {
                const detalles = this.detalles.map(detalle => ({
                    sku: detalle.sku,
                    cost: detalle.cost,
                    name: detalle.model  // Se asume que 'detalle.model' contiene el nombre del producto
                }));

                const data = {
                    factura_id: this.idFactura, // ID de la factura
                    detalles: detalles,          // Detalles con SKU, costo y nombre
                    n_documento: this.nDocumento,  // ‚úÖ Enviar N√∫mero de documento
                    proveedor: this.proveedor      // ‚úÖ Enviar Proveedor
                };

                axios.post('/api/aprobar-factura/', data)
                    .then(response => {
                        console.log(response.data.message);
                        console.log('Productos actualizados:', response.data.productos_actualizados);
                        console.log('Productos no encontrados:', response.data.productos_no_encontrados);

                        Swal.fire({
                            title: 'Factura Aprobada',
                            text: 'La factura ha sido aprobada con √©xito.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '/recepciones_pendientes/';  // Redirigir a la p√°gina indicada
                        });
                    })
                    .catch(error => {
                        console.error('Error al aprobar la factura:', error);
                    });
            },
            // Funci√≥n para extraer el ID de la factura desde la URL
            getFacturaIdFromURL() {
                const urlParts = window.location.pathname.split('/');
                const idFactura = urlParts[urlParts.length - 2];  // El ID de la factura est√° en la pen√∫ltima parte de la URL
                return idFactura;
            },
            actualizarPreciosBaseMasivo() {
                if (this.detalles.length === 0) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay precios para actualizar.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                const precios = this.detalles.map(detalle => ({
                    iderp: detalle.iderp,
                    sku: detalle.sku,
                    bPrice: detalle.precioBase, // Precio bruto con impuestos
                    type: 3 // ID de la lista de precios base
                }));

                console.log("Datos enviados a la API para actualizaci√≥n masiva:", precios);

                axios.post('/api/actualizar_precios_masivo/', { precios })
                    .then(response => {
                        console.log('Respuesta de la API:', response.data);
                        Swal.fire({
                            title: '√âxito',
                            text: 'Precios actualizados correctamente.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    })
                    .catch(error => {
                        console.error('Error al actualizar los precios:', error.response.data);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al actualizar los precios.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            },
            exportarExcel() {
                if (!this.detalles.length) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay datos para exportar.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                let promesas = [];

                // Recorremos cada detalle de la factura
                this.detalles.forEach(detalle => {
                    // Por cada detalle, recorrer las listas de precios visibles
                    this.listasPrecios.forEach(precioLista => {
                        if (precioLista.mostrar) {
                            // Crear la promesa para obtener el valor actual desde Bsale
                            let promesa = axios.post('/api/obtener_valor_actual/', {
                                price_list_id: precioLista.id,
                                sku: detalle.sku
                            })
                            .then(response => {
                                const valorActual = response.data.valor_actual ? Math.ceil(response.data.valor_actual * 1.19) : 'Pendiente';
                                // Calcular margen del precio actual
                                const costo = parseFloat(detalle.cost) || 0;
                                const margenActual = (valorActual !== 'Pendiente' && costo > 0) 
                                    ? (((valorActual / 1.19) - costo) / (valorActual / 1.19) * 100).toFixed(2) 
                                    : 'Pendiente';

                                // Guardar estos datos dentro del detalle din√°micamente
                                this.$set(detalle, `precioActual_${precioLista.label}`, valorActual);
                                this.$set(detalle, `margenActual_${precioLista.label}`, margenActual);

                                // Tambi√©n los sugeridos que ya calculaste en pantalla
                                const precioSugerido = precioLista.valor || 'Pendiente';
                                const margenSugerido = precioLista.margen || 'Pendiente';
                                this.$set(detalle, `precioSugerido_${precioLista.label}`, precioSugerido);
                                this.$set(detalle, `margenSugerido_${precioLista.label}`, margenSugerido);
                            })
                            .catch(error => {
                                console.error(`Error al obtener valor actual para ${precioLista.label}:`, error);
                                this.$set(detalle, `precioActual_${precioLista.label}`, 'Error');
                                this.$set(detalle, `margenActual_${precioLista.label}`, 'Error');
                                this.$set(detalle, `precioSugerido_${precioLista.label}`, 'Error');
                                this.$set(detalle, `margenSugerido_${precioLista.label}`, 'Error');
                            });

                            promesas.push(promesa);
                        }
                    });
                });

                // Esperar a que todas las consultas terminen
                Promise.all(promesas).then(() => {
                    // Una vez obtenida toda la data, generamos el Excel
                    let data = this.detalles.map(detalle => {
                        let preciosMarketplaces = {};
                        // Agregar din√°micamente precios y m√°rgenes por cada lista visible
                        this.listasPrecios.forEach(precioLista => {
                            if (precioLista.mostrar) {
                                preciosMarketplaces[`Precio Actual ${precioLista.label}`] = detalle[`precioActual_${precioLista.label}`] || 'N/A';
                                preciosMarketplaces[`Margen Actual ${precioLista.label}`] = detalle[`margenActual_${precioLista.label}`] || 'N/A';
                                preciosMarketplaces[`Precio Sugerido ${precioLista.label}`] = detalle[`precioSugerido_${precioLista.label}`] || 'N/A';
                                preciosMarketplaces[`Margen Sugerido ${precioLista.label}`] = detalle[`margenSugerido_${precioLista.label}`] || 'N/A';
                            }
                        });

                        return {
                            SKU: detalle.sku,
                            Producto: detalle.model,
                            Cantidad: detalle.qty,
                            "Descuento %": detalle.dctoItem,
                            "Costo Real": detalle.cost_with_discount,
                            "Costo": detalle.cost,
                            "√öltimo Costo": detalle.lastCost || 0,
                            "√öltimo Precio": detalle.lastPrice || 0,
                            "Precio Bsale": detalle.bsalePrice || 0,
                            "Precio Base": detalle.precioBase || 0,
                            "Margen %": detalle.margen || 0,
                            "Stock Total": detalle.totalStock || 0,
                            ...preciosMarketplaces
                        };
                    });

                    // Convertir los datos en una hoja de c√°lculo
                    let ws = XLSX.utils.json_to_sheet(data);

                    // Crear un libro de Excel y agregar la hoja
                    let wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Detalles Factura");

                    // Generar el archivo Excel y descargarlo
                    XLSX.writeFile(wb, `Factura_${this.idFactura}_completa.xlsx`);
                });
            }



        },
        mounted() {
            console.log("Componente montado");  // Verificar que el mounted se ejecuta

            this.idFactura = this.getFacturaIdFromURL();  // Guardar el ID de la URL en la variable de Vue
            if (this.idFactura) {
                this.obtenerFactura();  // Llamar a la API con el ID de la factura
            } else {
                console.error("No se pudo obtener el ID de la factura desde la URL");
            }
        }
    });
</script>
{% endblock js %}