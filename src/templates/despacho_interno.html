{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app" class="container">
    <div v-if="showAccessControl" class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    <h5>Validación de Acceso</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="accessKey" class="form-label">Ingrese la clave de acceso</label>
                        <input type="password" id="accessKey" v-model="accessKey" class="form-control" placeholder="Clave de acceso">
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary" @click="validateAccessKey">Validar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-else>
        <div class="row mt-4">
            <div class="col-md-4">
                <label for="cbCompany">Compañía</label>
                <select id="cbCompany" v-model="company" class="form-select">
                    <option value="1">EMMETT</option>
                    <option value="2">SOUNDSTORE</option>
                    <option value="3">GROBEN</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="nDocument">Número de Documento (Opcional)</label>
                <input id="nDocument" type="text" v-model="nDocument" class="form-control" placeholder="Ingrese el número del documento">
            </div>
            <div class="col-md-4">
                <label for="sidProduct">Escanear ID Producto (SuperID)</label>
                <input 
                    id="sidProduct" 
                    type="text" 
                    v-model="sid" 
                    @keyup.enter="validateAndLinkSuperid" 
                    class="form-control" 
                    placeholder="Escanea el código único" 
                    autocomplete="off"
                >
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div v-if="alertMessage" :class="alertClass" class="alert" role="alert">[[ alertMessage ]]</div>
                <h5>Productos Despachados</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">SuperID</th>
                                <th scope="col">SKU</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-if="internalProducts.length > 0">
                                <tr v-for="(product, index) in internalProducts" :key="index">
                                    <td>[[ index + 1 ]]</td>
                                    <td>[[ product.superid ]]</td>
                                    <td>[[ product.code ]]</td>
                                </tr>
                            </template>
                            <template v-else>
                                <tr>
                                    <td colspan="4" class="text-center">No se han despachado productos.</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            company: 1,            // Compañía seleccionada
            nDocument: '',         // Número de documento
            sid: '',               // SuperID ingresado
            internalProducts: [], // Lista de productos despachados
            processingQueue: [],  // Cola de SuperIDs pendientes de procesar
            isProcessing: false,  // Estado del procesamiento
            showAccessControl: false, // Control de acceso inicial
            accessKey: '',          // Clave de acceso
            alertMessage: '',       // Mensaje de alerta
            alertClass: ''          // Clase de alerta
        },
        mounted() {
            // Determinar si mostrar el control de acceso según el rol
            const userRole = '{{ request.user.usuario.rol }}';
            if (userRole === 'BODEGA') {
                this.showAccessControl = true;
            }
        },
        methods: {
            validateAccessKey() {
                axios.post('/api/validate-access-key/', { key: this.accessKey })
                    .then(response => {
                        if (response.data.valid) {
                            this.showAccessControl = false;
                        } else {
                            this.showAlert('Clave no válida.', 'alert-danger');
                        }
                    })
                    .catch(error => {
                        this.showAlert('No se pudo validar la clave.', 'alert-danger');
                        console.error(error);
                    });
            },

            validateAndLinkSuperid() {
                // Evitar acumulación mientras se procesa la entrada
                if (this.isProcessing) return;

                const superidToValidate = this.sid.trim();
                if (!superidToValidate) return;

                // Agregar a la cola y limpiar el input inmediatamente
                this.processingQueue.push(superidToValidate);
                this.sid = ''; // Limpieza inmediata
                this.$nextTick(() => document.getElementById('sidProduct').focus()); // Re-enfocar input

                // Iniciar procesamiento si no está activo
                if (!this.isProcessing) {
                    this.processQueue();
                }
            },


            async processQueue() {
                // Verificar si hay algo en la cola
                if (this.processingQueue.length === 0) {
                    this.isProcessing = false;
                    return; // No hay más SuperIDs por procesar
                }

                this.isProcessing = true; // Marcar procesamiento activo
                const superidToProcess = this.processingQueue.shift(); // Extraer el siguiente SuperID

                try {
                    // Validar SuperID con la API
                    const response = await axios.post('/api/validate-superid/', { sid: superidToProcess });

                    if (response.data.icon === 'success') {
                        const product = {
                            superid: superidToProcess,
                            code: response.data.sku,
                            description: response.data.description
                        };

                        // Despachar el producto
                        await this.dispatchConsumption(product);
                        this.internalProducts.push(product); // Agregar a la lista de productos despachados
                        this.alertasuccess = true; // Mostrar alerta de éxito
                        this.playSound('successSound'); // Reproducir sonido de éxito
                    } else {
                        // Manejo de errores específicos
                        this.alertaerror = true; // Mostrar alerta de error
                        this.playSound('errorSound');
                    }
                } catch (error) {
                    console.error('Error al procesar SuperID:', error);
                    this.alertaerror = true; // Mostrar alerta de error
                    this.playSound('errorSound');
                } finally {
                    // Continuar con el siguiente SuperID en la cola
                    this.$nextTick(() => document.getElementById('sidProduct').focus()); // Asegurar foco
                    this.isProcessing = false;
                    this.processQueue();
                }
            },

            async dispatchConsumption(product) {
                const payload = {
                    company: this.company,
                    products: [product]
                };

                try {
                    const response = await axios.post('/api/dispatch-consumption/', payload);

                    if (response.data.icon !== 'success') {
                        console.error('Error en la API de despacho:', response.data);
                        this.alertaerror = true; // Mostrar alerta de error
                        this.playSound('errorSound');
                    }
                } catch (error) {
                    console.error('Error al realizar el despacho:', error);
                    this.alertaerror = true; // Mostrar alerta de error
                    this.playSound('errorSound');
                }
            },

            showAlert(message, alertClass) {
                this.alertMessage = message;
                this.alertClass = alertClass;
                setTimeout(() => {
                    this.alertMessage = '';
                    this.alertClass = '';
                }, 3000); // Ocultar alerta después de 3 segundos
            },

            playSound(soundId) {
                const audioElement = document.getElementById(soundId);
                if (audioElement) {
                    audioElement.play();
                } else {
                    console.error(`El sonido con ID ${soundId} no se encontró.`);
                }
            }

        }
    });
</script>
{% endblock js %}
