{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div id="app">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Gestión de Sectores</h5>
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#crearModal">
                    Crear Sector
                </button>
            </div>

           <!-- Modal para crear un sector -->
            <div class="modal fade" id="crearModal" tabindex="-1" aria-labelledby="crearModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="crearModalLabel">Crear Sector</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Formulario para ingresar datos del sector -->
                            <form @submit.prevent="createSector">
                                <div class="mb-3">
                                    <label for="inputBodega" class="form-label">Bodega</label>
                                    <select id="inputBodega" class="form-select" v-model="newSector.idoffice" required>
                                        <option value="">Seleccione una bodega</option>
                                        <option v-for="bodega in bodegas" :key="bodega.idoffice" :value="bodega.idoffice">
                                            [[ bodega.name ]]
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="inputZona" class="form-label">Zona</label>
                                    <input type="text" id="inputZona" class="form-control" v-model="newSector.zone" placeholder="Ingrese la zona" required>
                                </div>
                                <div class="mb-3">
                                    <label for="inputPiso" class="form-label">Piso</label>
                                    <input type="text" id="inputPiso" class="form-control" v-model="newSector.floor" placeholder="Ingrese el piso" required>
                                </div>
                                <div class="mb-3">
                                    <label for="inputSeccion" class="form-label">Sección</label>
                                    <input type="text" id="inputSeccion" class="form-control" v-model="newSector.section" placeholder="Ingrese la sección" required>
                                </div>
                                <div class="mb-3">
                                    <label for="inputNombreSector" class="form-label">Nombre del Sector</label>
                                    <!-- Cambiar ":value" por "v-model" para enlazar correctamente la propiedad computada -->
                                    <input 
                                        type="text" 
                                        id="inputNombreSector" 
                                        class="form-control" 
                                        :value="autoGeneratedName" 
                                        placeholder="Se generará automáticamente" 
                                        readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="inputDescripcion" class="form-label">Descripción</label>
                                    <textarea id="inputDescripcion" class="form-control" v-model="newSector.description" placeholder="Ingrese una descripción" rows="3"></textarea>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex mb-3">
                <!-- Filtro por Bodega -->
                <div class="me-3">
                    <label for="filterBodega" class="form-label">Filtrar por Bodega</label>
                    <select id="filterBodega" class="form-select" v-model="filters.bodega">
                        <option value="">Todas</option>
                        <option v-for="bodega in bodegas" :key="bodega.idoffice" :value="bodega.name">
                            [[ bodega.name ]]
                        </option>
                    </select>
                </div>
                <!-- Filtro por Zona -->
                <div>
                    <label for="filterZona" class="form-label">Filtrar por Zona</label>
                    <select id="filterZona" class="form-select" v-model="filters.zona">
                        <option value="">Todas</option>
                        <option v-for="zona in uniqueZones" :key="zona" :value="zona">
                            [[ zona ]]
                        </option>
                    </select>
                </div>
            </div>
            <button class="btn btn-success mb-3" @click="imprimirEtiquetasMasivas" :disabled="sectoresSeleccionados.length === 0">
                Imprimir Etiquetas Seleccionadas
            </button>
            <hr>
            <!-- Tabla para listar sectores -->
            <div class="table-responsive mt-4">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="thead-dark">
                        <tr>
                            <th><input type="checkbox" @change="seleccionarTodos($event)"></th>
                            <th>#</th>
                            <th>Bodega</th>
                            <th>Zona</th>
                            <th>Piso</th>
                            <th>Sección</th>
                            <th>Nombre del Sector</th>
                            <th>Descripción</th>
                            <th>Imprimir</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(sector, index) in filteredSectors" :key="sector.idsectoroffice">
                            <td><input type="checkbox" :value="sector" v-model="sectoresSeleccionados"></td>
                            <td>[[ index + 1 ]]</td>
                            <td>[[ sector.bodega_name ]]</td>
                            <td>[[ sector.zone ]]</td>
                            <td>[[ sector.floor ]]</td>
                            <td>[[ sector.section ]]</td>
                            <td>[[ sector.namesector ]]</td>
                            <td>[[ sector.description ]]</td>
                            <td>
                                <button class="btn btn-primary btn-sm" @click="imprimirEtiqueta(sector)">Imprimir</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/qrious/dist/qrious.min.js"></script>

<script>
new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
        sectors: [],
        bodegas: [],
        sectoresSeleccionados: [],
        newSector: { idoffice: '', zone: '', floor: '', section: '', namesector: '', description: '' },
        filters: { bodega: '', zona: '' },
    },
    computed: {
        autoGeneratedName() {
            const name = this.newSector.zone && this.newSector.floor && this.newSector.section 
                ? `${this.newSector.zone}${this.newSector.floor}-${this.newSector.section}` 
                : '';
            this.newSector.namesector = name; // Asignar el nombre generado
            return name;
        },
        uniqueZones() {
            const zones = this.sectors.map(sector => sector.zone);
            return [...new Set(zones)];
        },

        filteredSectors() {
            return this.sectors.filter(sector => {
                const matchesBodega = this.filters.bodega ? sector.bodega_name === this.filters.bodega : true;
                const matchesZona = this.filters.zona ? sector.zone === this.filters.zona : true;
                return matchesBodega && matchesZona;
            });
        }

    },
    methods: {
        async imprimirEtiqueta(sector) {
            try {
                const payload = {
                    sectores: [
                        {
                            idsector: sector.idsectoroffice,
                            qty: 1, // Cantidad fija para impresión individual
                        }
                    ]
                };
                const response = await axios.post('/api/imprimir-etiqueta-sector-simple/', payload);
                window.open(response.data.urlPdf, '_blank'); // Abrir el PDF generado en una nueva pestaña
            } catch (error) {
                console.error('Error al imprimir etiqueta individual:', error);
                Swal.fire('Error', 'No se pudo imprimir la etiqueta.', 'error');
            }
        },

        // Imprimir etiquetas masivas
        async imprimirEtiquetasMasivas() {
            if (this.sectoresSeleccionados.length === 0) {
                Swal.fire('Error', 'Debe seleccionar al menos un sector.', 'error');
                return;
            }

            try {
                const payload = {
                    sectores: this.sectoresSeleccionados.map(sector => ({
                        idsector: sector.idsectoroffice,
                        qty: 1 // Cantidad fija por sector
                    }))
                };

                const response = await axios.post('/api/imprimir-etiqueta-sector-simple/', payload);
                window.open(response.data.urlPdf, '_blank'); // Abrir el PDF generado en una nueva pestaña
            } catch (error) {
                console.error('Error al imprimir etiquetas masivas:', error);
                Swal.fire('Error', 'No se pudieron imprimir las etiquetas.', 'error');
            }
        },
        async imprimirEtiquetasSeleccionadas() {
            try {
                if (this.sectoresSeleccionados.length === 0) {
                    Swal.fire('Error', 'Debe seleccionar al menos un sector.', 'error');
                    return;
                }

                // Crear una lista de promesas para cada sector seleccionado
                const printRequests = this.sectoresSeleccionados.map(async (sector) => {
                    const payload = {
                        idsector: sector.idsectoroffice,
                        qty: 1, // Cantidad fija para impresión múltiple
                    };
                    const response = await axios.post('/api/imprimir-etiqueta-sector-simple/', payload);
                    return response.data.urlPdf;
                });

                // Esperar a que todas las solicitudes se completen
                const pdfUrls = await Promise.all(printRequests);

                // Abrir cada PDF en una nueva pestaña
                pdfUrls.forEach((url) => {
                    window.open(url, '_blank');
                });

            } catch (error) {
                console.error('Error al imprimir etiquetas:', error);
                Swal.fire('Error', 'No se pudieron imprimir las etiquetas.', 'error');
            }
        },

        seleccionarTodos(event) {
            this.sectoresSeleccionados = event.target.checked ? [...this.filteredSectors] : [];
        },
        async createSector() {
            try {
                await axios.post('/api/crear-sector/', this.newSector);
                Swal.fire('¡Sector creado!', 'El sector ha sido creado correctamente.', 'success');
                this.loadSectors();
                this.newSector = { idoffice: '', zone: '', floor: '', section: '', namesector: '', description: '' };
                $('#crearModalLabel').modal('hide');
            } catch (error) {
                Swal.fire('Error', 'Hubo un problema al crear el sector.', 'error');
                console.error('Error al crear el sector:', error);
            }
        },
        async loadSectors() {
            try {
                const response = await axios.get('/api/listar-sectores/');
                this.sectors = response.data;
            } catch (error) {
                console.error('Error al cargar sectores:', error);
            }
        },
        async loadBodegas() {
            try {
                const response = await axios.get('/api/listar-bodegas/');
                this.bodegas = response.data;
            } catch (error) {
                console.error('Error al cargar bodegas:', error);
            }
        }
    },
    mounted() {
        this.loadSectors();
        this.loadBodegas();
    }
});
</script>
{% endblock js %}
